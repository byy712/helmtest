{{- $ingressLimitRps := "1000" -}}
{{- if .Values.global.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.global.INGRESS_LIMIT_RPS -}}
{{- end }}
{{- $ingressLimitBurstMultiplier := "5" -}}
{{- if .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- end }}
{{- $ingressControllerType := .Values.global.INGRESS_CONTROLLER_TYPE }}
{{- $gitVersion := .Capabilities.KubeVersion.GitVersion }}
---
{{- if semverCompare "<1.19.0-0" $gitVersion }}
apiVersion: networking.k8s.io/v1beta1
{{- else }}
apiVersion: networking.k8s.io/v1
{{- end }}
kind: Ingress
metadata:
  name: "{{ .Release.Name }}-altiplano-indexsearch"
  labels:
    app: altiplano-indexsearch
    chart: altiplano-indexsearch
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
  {{- if eq $ingressControllerType "nginxinc" }}
    kubernetes.io/ingress.class: nginx
    nginx.org/mergeable-ingress-type: minion
    nginx.org/location-snippets: |
      proxy_set_header X-Forwarded-Prefix         /altiplano-indexsearch;
      rewrite ^(/altiplano-indexsearch)$ $1/ permanent;
      rewrite "(?i)/altiplano-indexsearch(/|$)(.*)" /$2 break;
      return 400;
    nginx.org/redirect-to-https: "true"
    nginx.org/ssl-services: altiplano-indexsearch
    {{- else }}
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^ $request_uri;
      rewrite "(?i)/altiplano-indexsearch(/|$)(.*)" /$2 break;
      return 400;
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-pass-suffix: $uri
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/secure-backends: "true"
    nginx.ingress.kubernetes.io/limit-rps: "{{ $ingressLimitRps }}"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "{{ $ingressLimitBurstMultiplier }}"
  {{- end }}

spec:
  rules:
    - http:
        paths:
          - backend:
              {{- if semverCompare "<1.19.0-0" $gitVersion }}
              serviceName: altiplano-indexsearch
              servicePort: tcp-rest
              {{- else }}
              service:
                name: altiplano-indexsearch
                port:
                  name: tcp-rest
            pathType: ImplementationSpecific
              {{- end }}
            path: /altiplano-indexsearch
---

---
{{- if semverCompare "<1.19.0-0" $gitVersion }}
apiVersion: networking.k8s.io/v1beta1
{{- else }}
apiVersion: networking.k8s.io/v1
{{- end }}
kind: Ingress
metadata:
  name: "{{ .Release.Name }}-altiplano-alarms-indexsearch"
  labels:
    app: altiplano-alarms-indexsearch
    chart: altiplano-alarms-indexsearch
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
  {{- if eq $ingressControllerType "nginxinc" }}
    kubernetes.io/ingress.class: nginx
    nginx.org/mergeable-ingress-type: minion
    nginx.org/location-snippets: |
      proxy_set_header X-Forwarded-Prefix         /altiplano-alarms-indexsearch;
      rewrite ^(/altiplano-alarms-indexsearch)$ $1/ permanent;
      rewrite "(?i)/altiplano-alarms-indexsearch(/|$)(.*)" /$2 break;
      return 400;
    nginx.org/redirect-to-https: "true"
    nginx.org/ssl-services: altiplano-alarms-indexsearch
  {{- else }}
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^ $request_uri;
      rewrite "(?i)/altiplano-alarms-indexsearch(/|$)(.*)" /$2 break;
      return 400;
    nginx.ingress.kubernetes.io/proxy-pass-suffix: $uri
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/secure-backends: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/limit-rps: "{{ $ingressLimitRps }}"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "{{ $ingressLimitBurstMultiplier }}"
  {{- end }}
spec:
  rules:
    - http:
        paths:
          - backend:
              {{- if semverCompare "<1.19.0-0" $gitVersion }}
              serviceName: altiplano-alarms-indexsearch
              servicePort: tcp-rest
              {{- else }}
              service:
                name: altiplano-alarms-indexsearch
                port:
                  name: tcp-rest
            pathType: ImplementationSpecific
              {{- end }}
            path: /altiplano-alarms-indexsearch
---