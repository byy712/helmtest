apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "crmq.postInstallJobName" . }}
  labels:
    app: {{ template "crmq.name" . }}-post-install
    chart: {{ template "crmq.chart" .  }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    {{- include "crmq.commonLabels" . | indent 4 }}
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    "helm.sh/hook": post-install
    {{- if .Values.hooks.deletePolicy }}
    "helm.sh/hook-delete-policy": {{ .Values.hooks.deletePolicy }}
    {{- else }}
    "helm.sh/hook-delete-policy": hook-succeeded, before-hook-creation
    {{- end }}
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:  
  activeDeadlineSeconds: {{ .Values.rabbitmq.dynamicConfig.timeout }}
  template:
    metadata:
      {{- if .Values.istio.enabled }}
      annotations:
        sidecar.istio.io/inject: "{{ .Values.istio.enabled }}"
      {{- end }}
        {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 8 }}
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
        app: {{ template "crmq.name" . }}-post-install-job
        chart: {{ template "crmq.chart" .  }}
        release: "{{ .Release.Name }}"
        heritage: "{{ .Release.Service }}"
        {{- include "crmq.commonLabels" . | indent 8 }}
        {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 8 }}
    spec:
      securityContext:
        {{- if eq (include "crmq.renderSeccompProfile" .) "true" }}
        seccompProfile:
          type: {{ .Values.securityContext.seccompProfile.type }}
        {{- end }}
        runAsNonRoot: true
        runAsUser: 10000
        fsGroup: 10000
      hostname: {{ template "crmq.fullname" . }}-dynamic-config-pod
      subdomain: {{ template "crmq.fullname" . }}
      restartPolicy: Never 
      serviceAccountName: {{ if .Values.rbac.enabled }}{{ template "crmq.fullname" . }}{{ else }}"{{ .Values.serviceAccountName }}"{{ end }}
      {{- if .Values.istio.enabled }}
      automountServiceAccountToken: true
      {{- else }}
      automountServiceAccountToken: false
      {{- end }}
      {{- if eq .Values.antiAffinity "hard" }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: "kubernetes.io/hostname"
              labelSelector:
                matchLabels:
                  app: {{ template "crmq.name" . }}
                  release: {{ .Release.Name | quote }}
      {{- else if eq .Values.antiAffinity "soft" }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              podAffinityTerm:
                topologyKey: "kubernetes.io/hostname"
                labelSelector:
                  matchLabels:
                    app: {{ template "crmq.name" . }}
                    release: {{ .Release.Name | quote }}
      {{- end }}
      {{- if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
      {{- end }}
      {{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
      {{- end }}
      {{- if  coalesce .Values.image.pullSecrets .Values.global.imagePullSecrets }}
      imagePullSecrets:
        - name: {{ coalesce .Values.image.pullSecrets .Values.global.imagePullSecrets }}
      {{- end }}
      containers:
      - name: {{ template "crmq.postInstallContainerName" . }}
        image: "{{ .Values.global.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        securityContext:
          capabilities:
            drop: ["ALL"]
          runAsNonRoot: true
          {{- if eq (include "crmq.renderSeccompProfile" .) "true" }}
          seccompProfile:
            type: {{ .Values.securityContext.seccompProfile.type }}
          {{- end }}
          {{- if .Values.securityContext.allowPrivilegeEscalation }}
          allowPrivilegeEscalation: {{ .Values.securityContext.allowPrivilegeEscalation }}
          {{- else }}
          allowPrivilegeEscalation: false
          {{- end }}
          readOnlyRootFilesystem: {{ required "Value is required true/false." .Values.securityContext.readOnlyRootFilesystem }}
          {{- if ( ne ( toString ( .Values.securityContext.runAsUser )) "auto" ) }}
          runAsUser: {{ .Values.securityContext.runAsUser }}
          {{- end }}
        command:
          - bash
          - -ec
          - |
            {{- if eq .Values.istio.enabled true}}
            until curl --head --fail localhost:{{ .Values.istio.envoy.healthCheckPort }}/healthz/ready
            do
              echo "Waiting for istio-proxy ..."
              sleep 1
            done
            echo "istio-proxy available"
            {{- end }}
            ls -al /var/lib/rabbitmq
            if [ ! -f /var/lib/rabbitmq/.erlang.cookie ]; then
              echo $RABBITMQ_ERL_COOKIE > /var/lib/rabbitmq/.erlang.cookie
            fi
            chmod 400 /var/lib/rabbitmq/.erlang.cookie
            ls -al /var/lib/rabbitmq
            
            set -x
            if [ -z {{ .Values.global.podNamePrefix }} ]; then
            pod="{{ template "crmq.fullname" . }}"
            else
            pod="{{ .Values.global.podNamePrefix }}{{ template "crmq.fullname" . }}"
            fi
            #wait when pod is ready. Job will sleep when rabbitmqctl return "Error:"
            #It depends on the output of rabbitmqctl
            #since we don't know how long rabbitmqctl will return
            #timeout value is the same as activeDeadlineSeconds to make it simple
            min=1
            max={{ .Values.rabbitmq.dynamicConfig.timeout }}
            while [ $min -le $max ]
            do
              min=`expr $min + 1`
            {{- if (eq "hostname" .Values.rabbitmq.clustering.address_type) }}
              result=`rabbitmqctl -l -n rabbit@\${pod}-0.$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.{{ .Values.rabbitmq.clustering.k8s_domain }} list_vhosts 2>&1 || true`
            {{- else }}
              result=`rabbitmqctl -n rabbit@\${pod}-0  list_vhosts 2>&1 || true`
            {{- end }}
              if [ ${result:0:6} == "Error:" ]; then
                sleep 5
              else
                sleep 10
                break
              fi
            done
            ## reading parameter only if dynamicConfig is set to true
            {{- if .Values.rabbitmq.dynamicConfig.enabled }}
            number=0
            patt="cmd"
            fname=""
            while read line;
            do
              line="$(echo $line | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
              if [[ "${line:0:1}" != "#" ]]; then
                 printf -v fname -- '%s-%02d' "$patt" "$(( ++number ))"
                 {{- if (eq "hostname" .Values.rabbitmq.clustering.address_type) }}
                 echo "rabbitmqctl -l -n rabbit@$pod-0.$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.{{ .Values.clusterDomain }} ${line}" >> /tmp/${fname};
                 {{- else }}
                 echo "rabbitmqctl -n rabbit@$pod-0 ${line}" >> /tmp/${fname};
                 {{- end }}
              fi
            done < /tmp/parameters
            set +e
            for f in /tmp/cmd*;
            do
              min=1
              max={{ .Values.rabbitmq.dynamicConfig.maxCommandRetries }}
              while [ $min -le $max ]
              do
                min=`expr $min + 1`
                chmod +x $f
                sh -c $f
                if [ $? -eq 0 ]; then
                  rm $f
                  break
                else
                  sleep 1
                fi
              done
              if [ $min -gt $max ]; then
                exit 1
              fi             
            done
            {{- end }}
            # changing default password
            
            # read default username and password from mounted hidden files.
            default_user=$(<"/etc/default-user-creds/.username")
            default_user=$default_user | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'

            default_user_password=$(<"/etc/default-user-creds/.password")
            default_user_password=$default_user_password | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'
            
            {{- if (eq "hostname" .Values.rabbitmq.clustering.address_type) }}
            rabbitmqctl -l -n rabbit@$pod-0.$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.{{ .Values.clusterDomain }} change_password $default_user $default_user_password
            {{- else }}
            rabbitmqctl -n rabbit@$pod-0 change_password $default_user $default_user_password
            {{- end }}
            set +x
            {{- if .Values.istio.enabled }}
            curl -X POST http://localhost:{{ .Values.istio.envoy.stopPort }}/quitquitquit
            {{- end }}

        {{- if .Values.resources }}
        resources:
{{ toYaml .Values.resources | indent 10 }}
        {{- end }}
        volumeMounts:
          - name: erlang-cookie
            mountPath: /var/lib/rabbitmq/
          - name: default-user-creds
            mountPath: /etc/default-user-creds/
{{- if .Values.rabbitmq.dynamicConfig.enabled }}
          - name: tmp
            mountPath: /tmp
          - name: dynamic-config-parameters
            mountPath: /tmp/parameters
            subPath: parameters
{{- end }}
# internode tls secret mount using secret/certmanager
{{- if .Values.rabbitmq.internodetls.enabled }}
          - name: config-dir
            mountPath: /etc/rabbitmq
          - name: secret-server-file-cm-itls
            mountPath: /etc/rabbitmq.tls.conf/secret/internodetls/
            readOnly: true
{{- end }}

        ports:
        - name: tcp-epmd
          containerPort: 4369
        - name: tcp-dist
          containerPort: 25672
        - name: tcp-erlang
          containerPort: 35672

        env:
          - name: LC_ALL
            value: en_US.UTF-8
          - name: LANG
            value: en_US.UTF-8
          {{- if and ( .Values.ipv6Enabled ) ( not .Values.rabbitmq.internodetls.enabled ) }}
          - name: RABBITMQ_CTL_ERL_ARGS
            value: "-proto_dist inet6_tcp"
          {{- end }}
          - name: RABBITMQ_ERL_COOKIE
          {{- if .Values.rabbitmq.erlangCookie }}
            value: {{ .Values.rabbitmq.erlangCookie | quote }}
          {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ template "crmq.fullname" . }}-const
                key: rabbitmq-erlang-cookie
          {{- end }}
          - name: K8S_SERVICE_NAME
            value: {{ template "crmq.fullname" . }}
          - name: MY_POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: HOME
            value: "/var/lib/rabbitmq/"
      dnsConfig:
        searches:
          - {{ template "crmq.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local
      volumes:
        - name: erlang-cookie      
          emptyDir: {}
        - name: default-user-creds
          secret:
            secretName: {{ .Values.rabbitmq.default_user_credentials.secretName }}
            items:
            - key: {{ .Values.rabbitmq.default_user_credentials.usernameKey }}
              path: ".username"
            - key: {{ .Values.rabbitmq.default_user_credentials.passwordKey }}
              path: ".password"
{{- if .Values.rabbitmq.dynamicConfig.enabled }}
        - name: tmp
          emptyDir: {}
        - name: dynamic-config-parameters
          configMap:
            name: {{ template "crmq.fullname" . }}-parameters
            items:
            - key: parameters
              path: parameters          
{{- end }}
# internode tls secret mount using secret/certmanager
{{- if .Values.rabbitmq.internodetls.enabled }}
        - name: config-dir
          configMap:
            name: {{ template "crmq.fullname" . }}-config
            items:
            - key: rabbitmq-env.conf
              path: rabbitmq-env.conf
            - key: tls.config
              path: tls.config
        - name: secret-server-file-cm-itls
          secret:
            secretName: {{ include "crmq.internode.tls.secret_name" . }}
            items:
            - key: {{ include "crmq.internode.tls.secretCAKey" . }}
              path: .cacert.pem
            - key: {{ include "crmq.internode.tls.secretCertKey" . }}
              path: .cert.pem
            - key: {{ include "crmq.internode.tls.secretKeyKey" . }}
              path: .key.pem
{{- end }}