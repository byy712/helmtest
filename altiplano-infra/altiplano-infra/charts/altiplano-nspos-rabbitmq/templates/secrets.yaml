---
{{ if or (.Release.IsInstall) (and (.Release.IsUpgrade) (.Values.rabbitmq.password)) (and (.Release.IsUpgrade) (.Values.tmpForceRecreateResources)) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.rabbitmq.default_user_credentials.secretName }}
  labels:
    app: {{ template "crmq.name" . }}
    chart: {{ template "crmq.chart" .  }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    {{- include "crmq.commonLabels" . | indent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation
type: Opaque
data:
  {{ if .Values.rabbitmq.password }}
  password: {{ .Values.rabbitmq.password | b64enc | quote }}
  {{ else }}
  password: {{ randAlphaNum 20 | b64enc | quote }}
  {{ end }}
  username: {{ .Values.rabbitmq.username | b64enc | quote }}
{{ end }}

---
{{ if or .Release.IsInstall (and (.Release.IsUpgrade) (.Values.tmpForceRecreateResources)) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "crmq.fullname" . }}-const
  labels:
    app: {{ template "crmq.name" . }}
    chart: {{ template "crmq.chart" .  }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    {{- include "crmq.commonLabels" . | indent 4 }}
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
type: Opaque
data:
  {{ if .Values.rabbitmq.erlangCookie }}
  rabbitmq-erlang-cookie: {{ .Values.rabbitmq.erlangCookie | b64enc | quote }}
  {{ else }}
  rabbitmq-erlang-cookie: {{ randAlphaNum 32 | b64enc | quote }}
  {{ end }}
  {{ if and .Values.rabbitmq.tls.uploadPath.cacert .Values.rabbitmq.tls.uploadPath.cert .Values.rabbitmq.tls.uploadPath.key }}
  server.cacert.pem: {{ .Values.rabbitmq.tls.uploadPath.cacert | b64enc | quote }}
  server.cert.pem: {{ .Values.rabbitmq.tls.uploadPath.cert | b64enc | quote }}
  server.key.pem: {{ .Values.rabbitmq.tls.uploadPath.key | b64enc | quote }}
  {{ end }}
  {{- if and .Values.rabbitmq.management.enabled .Values.rabbitmq.management.tls.uploadPath.cacert .Values.rabbitmq.management.tls.uploadPath.cert .Values.rabbitmq.management.tls.uploadPath.key }}
  management.cacert.pem: {{ .Values.rabbitmq.management.tls.uploadPath.cacert | b64enc | quote }}
  management.cert.pem: {{ .Values.rabbitmq.management.tls.uploadPath.cert | b64enc | quote }}
  management.key.pem: {{ .Values.rabbitmq.management.tls.uploadPath.key | b64enc | quote }}
  {{ end }}
  {{- if and .Values.rabbitmq.prometheus.tls.enabled .Values.rabbitmq.prometheus.tls.uploadPath.cacert .Values.rabbitmq.prometheus.tls.uploadPath.cert .Values.rabbitmq.prometheus.tls.uploadPath.key }}
  prometheus.cacert.pem: {{ .Values.rabbitmq.prometheus.tls.uploadPath.cacert | b64enc | quote }}
  prometheus.cert.pem: {{ .Values.rabbitmq.prometheus.tls.uploadPath.cert | b64enc | quote }}
  prometheus.key.pem: {{ .Values.rabbitmq.prometheus.tls.uploadPath.key | b64enc | quote }}
  {{- end }}
  {{- range $item := .Values.tlsClient }}
  {{ $item.name }}.cacert.pem: {{ $item.cacert | b64enc | quote }}
  {{ $item.name }}.cert.pem: {{ $item.cert | b64enc | quote }}
  {{ $item.name }}.key.pem: {{ $item.key | b64enc | quote }}
  {{- end }}
{{ end }}

---

{{if .Values.rabbitmq.tls.certmanager.used }}
apiVersion: {{ template "crmq.certificateVersion" . }}
kind: Certificate
metadata:
  name: {{ template "crmq.fullname" . }}-crmq-server-cert-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "crmq.commonLabels" . | indent 4 }}
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  secretName: {{ template "crmq.fullname" . }}-crmq-server-cert-secret
  usages:
  - server auth
  - client auth
  duration: {{ .Values.rabbitmq.tls.certmanager.duration }}
  renewBefore: {{ .Values.rabbitmq.tls.certmanager.renewBefore }}
  {{- include "crmq.tls.privateKey.configs" . | indent 2 }}
  {{- if .Values.rabbitmq.tls.certmanager.commonName }}
  commonName: "{{ .Values.rabbitmq.tls.certmanager.commonName }}
  {{- else }}
  commonName: {{ printf "%s-server" (include "crmq.fullname" .) | quote }}
  {{- end }}
  dnsNames:
{{- if .Values.rabbitmq.tls.certmanager.dnsNames }}
{{ toYaml .Values.rabbitmq.tls.certmanager.dnsNames | indent 4 }}
{{- else }}
  {{ printf "- %s" (include "crmq.fullname" .) | indent 2 }}
  {{ printf "- %s.%s" (include "crmq.fullname" .) .Release.Namespace | indent 2 }}
  {{ printf "- %s.%s.%s" (include "crmq.fullname" .) .Release.Namespace  .Values.rabbitmq.tls.certmanager.domain | indent 2 }}
{{- end }}
  {{- if .Values.rabbitmq.tls.certmanager.ipAddresses }}
  ipAddresses:
{{ toYaml .Values.rabbitmq.tls.certmanager.ipAddresses | indent 4 }}
  {{- end }}
  issuerRef:
    name: {{ .Values.rabbitmq.tls.certmanager.issuerName }}
    # We can reference ClusterIssuers by changing the kind here.
    # The default value is Issuer (i.e. a locally namespaced Issuer)
    kind: {{ .Values.rabbitmq.tls.certmanager.issuerType }}
   
{{ end }}

---

{{if .Values.rabbitmq.management.tls.certmanager.used }}
apiVersion: {{ template "crmq.certificateVersion" . }}
kind: Certificate
metadata:
  name: {{ template "crmq.fullname" . }}-crmq-management-cert-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "crmq.commonLabels" . | indent 4 }}
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  secretName: {{ template "crmq.fullname" . }}-crmq-management-cert-secret
  usages:
  - server auth
  - client auth
  duration: {{ .Values.rabbitmq.management.tls.certmanager.duration }}
  renewBefore: {{ .Values.rabbitmq.management.tls.certmanager.renewBefore }}
  {{- include "crmq.management.tls.privateKey.configs" . | indent 2 }}
  {{- if .Values.rabbitmq.management.tls.certmanager.commonName }}
  commonName: "{{ .Values.rabbitmq.management.tls.certmanager.commonName }}
  {{- else }}
  commonName: {{ printf "%s-management" (include "crmq.fullname" .) | quote }}
  {{- end }}
  dnsNames:
{{- if .Values.rabbitmq.management.tls.certmanager.dnsNames }}
{{ toYaml .Values.rabbitmq.management.tls.certmanager.dnsNames | indent 4 }}
{{- else }}
  {{ printf "- %s" (include "crmq.managementService" .) | indent 2 }}
  {{ printf "- %s.%s" (include "crmq.managementService" .) .Release.Namespace | indent 2 }}
  {{ printf "- %s.%s.%s" (include "crmq.managementService" .) .Release.Namespace .Values.rabbitmq.management.certmanager.domain | indent 2 }}
{{- end }}
  {{- if .Values.rabbitmq.management.tls.certmanager.ipAddresses }}
  ipAddresses:
{{ toYaml .Values.rabbitmq.management.tls.certmanager.ipAddresses | indent 4 }}
  {{- end }}
  issuerRef:
    name: {{ .Values.rabbitmq.management.tls.certmanager.issuerName }}
    # We can reference ClusterIssuers by changing the kind here.
    # The default value is Issuer (i.e. a locally namespaced Issuer)
    kind: {{ .Values.rabbitmq.management.tls.certmanager.issuerType }}
{{ end }}

---

{{if .Values.rabbitmq.prometheus.tls.certmanager.used }}
apiVersion: {{ template "crmq.certificateVersion" . }}
kind: Certificate
metadata:
  name: {{ template "crmq.fullname" . }}-crmq-prometheus-cert-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "crmq.commonLabels" . | indent 4 }}
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  secretName: {{ template "crmq.fullname" . }}-crmq-prometheus-cert-secret
  usages:
  - server auth
  - client auth
  duration: {{ .Values.rabbitmq.prometheus.tls.certmanager.duration }}
  renewBefore: {{ .Values.rabbitmq.prometheus.tls.certmanager.renewBefore }}
  {{- include "crmq.prometheus.tls.privateKey.configs" . | indent 2 }}
  {{- if .Values.rabbitmq.prometheus.tls.certmanager.commonName }}
  commonName: "{{ .Values.rabbitmq.prometheus.tls.certmanager.commonName }}
  {{- else }}
  commonName: {{ printf "%s-prometheus" (include "crmq.fullname" .) | quote }}
  {{- end }}
  dnsNames:
{{- if .Values.rabbitmq.prometheus.tls.certmanager.dnsNames }}
{{ toYaml .Values.rabbitmq.prometheus.tls.certmanager.dnsNames | indent 4 }}
{{- else }}
  {{ printf "- %s" (include "crmq.prometheusService" .) | indent 2 }}
  {{ printf "- %s.%s" (include "crmq.prometheusService" .) .Release.Namespace | indent 2 }}
  {{ printf "- %s.%s.%s" (include "crmq.prometheusService" .) .Release.Namespace .Values.rabbitmq.prometheus.tls.certmanager.domain | indent 2 }}
{{- end }}
  {{- if .Values.rabbitmq.prometheus.tls.certmanager.ipAddresses }}
  ipAddresses:
{{ toYaml .Values.rabbitmq.prometheus.tls.certmanager.ipAddresses | indent 4 }}
  {{- end }}
  issuerRef:
    name: {{ .Values.rabbitmq.prometheus.tls.certmanager.issuerName }}
    # We can reference ClusterIssuers by changing the kind here.
    # The default value is Issuer (i.e. a locally namespaced Issuer)
    kind: {{ .Values.rabbitmq.prometheus.tls.certmanager.issuerType }}
{{ end }}

---

{{if .Values.ingress.certmanager.used }}
apiVersion: {{ template "crmq.certificateVersion" . }}
kind: Certificate
metadata:
  name: {{ .Values.ingress.tlsSecret }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "crmq.commonLabels" . | indent 4 }}
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  secretName: {{  .Values.ingress.tlsSecret }}
  duration: {{ .Values.ingress.certmanager.duration }}
  renewBefore: {{ .Values.ingress.certmanager.renewBefore }}
  {{- include "crmq.ingress.privateKey.configs" . | indent 2 }}
  dnsNames: 
{{- if .Values.ingress.certmanager.dnsNames }}
{{ .Values.ingress.certmanager.dnsNames | indent 2 }}
{{- else }}
  - ""
{{- end }}
  issuerRef:
    name: {{ .Values.ingress.certmanager.issuerName }}
    # We can reference ClusterIssuers by changing the kind here.
    # The default value is Issuer (i.e. a locally namespaced Issuer)
    kind: {{ .Values.ingress.certmanager.issuerType }}
{{ end }}

---

{{if and .Values.rabbitmq.internodetls.enabled .Values.rabbitmq.internodetls.certmanager.used }}
apiVersion: {{ template "crmq.certificateVersion" . }}
kind: Certificate
metadata:
  name: {{ template "crmq.fullname" . }}-crmq-internode-cert-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "crmq.commonLabels" . | indent 4 }}  
    {{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  secretName: {{ template "crmq.fullname" . }}-crmq-internode-cert-secret
  usages:
  - server auth
  - client auth
  duration: {{ .Values.rabbitmq.internodetls.certmanager.duration }}
  renewBefore: {{ .Values.rabbitmq.internodetls.certmanager.renewBefore }}
  {{- include "crmq.internodetls.privateKey.configs" . | indent 2 }}
  {{- if .Values.rabbitmq.internodetls.certmanager.commonName }}
  commonName: {{ .Values.rabbitmq.internodetls.certmanager.commonName }}
  {{- else }}
  commonName: {{ printf "%s-server" (include "crmq.fullname" .) | quote }}
  {{- end }}
  dnsNames:
{{- if .Values.rabbitmq.internodetls.certmanager.dnsNames }}
{{ toYaml .Values.rabbitmq.internodetls.certmanager.dnsNames | indent 4 }}
{{- else }}
   {{- include "crmq.internode.tls.dns" . -}}
{{- end }}
  {{- if .Values.rabbitmq.internodetls.certmanager.ipAddresses }}
  ipAddresses:
{{ toYaml .Values.rabbitmq.internodetls.certmanager.ipAddresses | indent 4 }}
  {{- end }}
  issuerRef:
    name: {{ .Values.rabbitmq.internodetls.certmanager.issuerName }}
    # We can reference ClusterIssuers by changing the kind here.
    # The default value is Issuer (i.e. a locally namespaced Issuer)
    kind: {{ .Values.rabbitmq.internodetls.certmanager.issuerType }}
{{ end }}
