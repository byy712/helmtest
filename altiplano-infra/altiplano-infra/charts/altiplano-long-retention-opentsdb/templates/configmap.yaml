apiVersion: v1
data:
  opentsdb.conf: |+
    tsd.core.auto_create_metrics = true
    tsd.core.auto_create_tagks = true
    tsd.core.auto_create_tagvs = true
    tsd.core.meta.enable_realtime_ts = false
    tsd.core.meta.enable_realtime_uid = false
    tsd.core.meta.enable_tsuid_incrementing = false
    tsd.core.meta.enable_tsuid_tracking = false
    tsd.core.plugin_path =
    tsd.core.preload_uid_cache = false
    tsd.core.preload_uid_cache.max_entries = 300000
    tsd.core.socket.timeout = 0
    tsd.core.storage_exception_handler.enable = false
    tsd.core.tree.enable_processing = false
    tsd.core.uid.random_metrics = false
    tsd.http.cachedir = /tmp
    tsd.http.query.allow_delete = false
    tsd.http.request.cors_domains =
    tsd.http.request.cors_headers = Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, Keep-Alive, X-Requested-With, If-Modified-Since
    tsd.http.request.enable_chunked = true
    tsd.http.request.max_chunk = 16384
    tsd.http.show_stack_trace = true
    tsd.http.staticroot = /usr/share/opentsdb/static
    tsd.mode = rw
    tsd.uid.lru.enable = true
    tsd.uid.lru.id.size = 10000000
    tsd.uid.lru.name.size = 40000000
    tsd.network.async_io = true
    tsd.network.bind = 0.0.0.0
    tsd.network.keep_alive = true
    tsd.network.port = 4242
    tsd.network.reuse_address = true
    tsd.network.tcp_no_delay = true
    tsd.network.worker_threads =
    tsd.no_diediedie = false
    tsd.query.allow_simultaneous_duplicates = true
    tsd.query.filter.expansion_limit = 4096
    tsd.query.skip_unresolved_tagvs = true
    tsd.query.timeout = 1800000
    tsd.rtpublisher.enable = false
    tsd.rtpublisher.plugin =
    tsd.search.enable = false
    tsd.search.plugin =
    tsd.stats.canonical = false
    tsd.storage.compaction.flush_interval = 10
    tsd.storage.compaction.flush_speed = 2
    tsd.storage.compaction.max_concurrent_flushes = 10000
    tsd.storage.compaction.min_flush_threshold = 100
    tsd.storage.enable_appends = false
    tsd.storage.enable_compaction = false
    tsd.storage.fix_duplicates = true
    tsd.storage.flush_interval = 1000
    tsd.storage.hbase.data_table = {{- if (.Values.env.init.TSDB_TABLE) }} {{.Values.env.init.TSDB_TABLE}} {{- else }}tsdb{{- end }}
    tsd.storage.hbase.meta_table = {{- if (.Values.env.init.TSDB_TABLE) }} {{.Values.env.init.META_TABLE}} {{- else }}tsdb-meta{{- end }}
    tsd.storage.hbase.prefetch_meta = false
    tsd.storage.hbase.tree_table = {{- if (.Values.env.init.TSDB_TABLE) }} {{.Values.env.init.TREE_TABLE}} {{- else }}tsdb-tree{{- end }}
    tsd.storage.hbase.uid_table = {{- if (.Values.env.init.TSDB_TABLE) }} {{.Values.env.init.UID_TABLE}} {{- else }}tsdb-uid{{- end }}
    tsd.storage.hbase.zk_basedir = /hbase
    {{- if .Values.global.clustered_opentsdb }}
    tsd.storage.hbase.zk_quorum =  {{- if (.Values.global.zookeeperquorum) }} {{ .Values.global.zookeeperquorum }}{{- else if (.Values.zookeeperquorum) }} {{ .Values.zookeeperquorum }}{{- else }} altiplano-zookeeper:2181 {{- end }}
    {{- else }}
    tsd.storage.hbase.zk_quorum = localhost:2181
    {{- end }}
    tsd.storage.repair_appends = false
    tsd.storage.uid.width.metric = 4
    tsd.storage.uid.width.tagv = 4
    tsd.storage.uid.width.tagk = 4
    tsd.storage.enable_compaction = false
    tsd.storage.salt.width = 1
    tsd.storage.salt.buckets = 20
    hbase.nsre.high_watermark = 100

  logback.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <configuration>
      <!--<jmxConfigurator/>-->
      <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
          <pattern>
            %d{ISO8601} %-5level [%thread] %logger{0}: %msg%n
          </pattern>
        </encoder>
      </appender>

      <appender name="CYCLIC" class="ch.qos.logback.core.read.CyclicBufferAppender">
        <MaxSize>1024</MaxSize>
      </appender>

      <!-- Appender to write OpenTSDB data to a set of rotating log files -->
      <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/opentsdb/opentsdb.log</file>
        <append>true</append>

        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
          <fileNamePattern>/var/log/opentsdb/opentsdb%d{yyyy-MM-dd}.log.%i</fileNamePattern>
          <maxHistory>7</maxHistory>
          <maxFileSize>20MB</maxFileSize>
          <totalSizeCap>200MB</totalSizeCap>
        </rollingPolicy>

        <encoder>
          <pattern>%d{ISO8601} %-5level [%logger{0}.%M] - %msg%n</pattern>
        </encoder>
      </appender>

      <!-- Appender for writing full and completed queries to a log file. To use it, make
      sure to set the "level" to "INFO" in QueryLog below. -->
      <appender name="QUERY_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/opentsdb/queries.log</file>
        <append>true</append>

        <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
        <fileNamePattern>/var/log/opentsdb/queries.log.%i</fileNamePattern>
        <minIndex>1</minIndex>
        <maxIndex>4</maxIndex>
        </rollingPolicy>

        <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
        <maxFileSize>128MB</maxFileSize>
        </triggeringPolicy>
        <encoder>
        <pattern>{{ .Values.env.init.ENCODER_PATTERN }}</pattern>
        </encoder>
      </appender>

      <!-- Per class logger levels -->
      <logger name="QueryLog" level="OFF" additivity="false">
        <appender-ref ref="QUERY_LOG"/>
      </logger>
      <logger name="org.apache.zookeeper" level={{- printf "\"%s\"" .Values.env.init.LOGGER}}/>
      <logger name="org.hbase.async" level={{- printf "\"%s\"" .Values.env.init.LOGGER}}/>
      <logger name="com.stumbleupon.async" level={{- printf "\"%s\"" .Values.env.init.LOGGER}}/>

      <!-- Fallthrough root logger and router -->
      <root level={{- printf "\"%s\"" .Values.env.init.LOGGER}}>
        <!-- <appender-ref ref="STDOUT"/> -->
        <appender-ref ref="CYCLIC"/>
        <appender-ref ref="FILE"/>
      </root>
    </configuration>
kind: ConfigMap
metadata:
  name: {{ template "altiplano-long-retention-opentsdb.fullname" . }}-conf
