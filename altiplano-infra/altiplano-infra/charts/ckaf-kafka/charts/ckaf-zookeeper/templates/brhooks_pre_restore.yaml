{{- if  .Values.cbur.enabled }}
apiVersion: "cbur.csf.nokia.com/v1"
kind: BrHook
metadata:
  name: {{ .Release.Name }}-zk-pre-restore-br-hook
  labels:
{{ include "ckaf-zookeeper.commonlabels" . | indent 4 }}
{{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
{{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  properties:
    targetType: "brpolicy"
    targetName: {{ template "ckaf-zookeeper.statefulset" . }}
    hookPoint: prerestore
    weight: 0 
    enable: true
    timeout: {{ .Values.cbur.brhookTimeout | default 600 }}
    deletePolicy: "hook-succeeded,before-hook-creation"
  template:
    spec:
     template:
       metadata:
         labels:
           app: {{ .Chart.Name }}
         annotations:
           sidecar.istio.io/inject: "false"
       spec:
         {{- if .Values.zookeeperNodeSelector.enable }}
         nodeSelector:
{{ toYaml .Values.zookeeperNodeSelector.nodeLabel | indent 11 }}
         {{- end }}
         {{- if .Values.global.rbac.enabled }}
         serviceAccountName: {{ template "ckaf-zookeeper.serviceAccountName" . }}
         {{- end }}
         automountServiceAccountToken: true
         {{- if eq .Values.security.enabled true }}
         securityContext:
           {{- if ( ne ( toString ( .Values.security.runAsUser )) "auto" ) }}
           runAsUser: {{ .Values.security.runAsUser }}
           {{- end }}
           runAsNonRoot: true
           {{- if ( ne ( toString (.Values.security.fsGroup)) "auto" ) }}
           fsGroup: {{ .Values.security.fsGroup }}
           {{- end }}
           {{- if eq (include "ckaf-zookeeper.renderSeccompProfile" .) "true" }}
           seccompProfile:
            type: {{ .Values.security.seccompProfile.type }}
           {{- end }}
         {{- end }}
         {{- if  coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
         imagePullSecrets:
           - name: {{ coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
         {{- end }}
         restartPolicy: Never
         containers:
         - name: zk-pre-restore-br-hook
           {{- if eq .Values.global.flatRegistry true }}
           image: "{{ .Values.global.registry }}/{{ .Values.kubectlImageName }}:{{ .Values.kubectlTag }}"
           {{- else }}
           image: "{{ coalesce .Values.global.registry3  .Values.global.registry }}/{{ .Values.kubectlImage }}:{{ .Values.kubectlTag }}"
           {{- end }}
           imagePullPolicy: IfNotPresent
           {{- if eq .Values.security.enabled true }}
           securityContext:
             runAsNonRoot: true
             readOnlyRootFilesystem: {{ .Values.security.readOnlyRootFilesystem }}
             {{- if ( ne ( toString ( .Values.security.runAsUser )) "auto" ) }}
             runAsUser: {{ .Values.security.runAsUser }}
             {{- end }}
             {{- if .Values.security.runAsGroup }}
             runAsGroup: {{ .Values.security.runAsGroup }}
             {{- end }}
             allowPrivilegeEscalation: false
             {{- if eq (include "ckaf-zookeeper.renderSeccompProfile" .) "true" }}
             seccompProfile:
               type: {{ .Values.security.seccompProfile.type }}
             {{- end }}
             privileged: false
             capabilities:
               drop: ["ALL"]
           {{- end }}
           env:
           - name: TZ
             value: {{ template "ckaf-zookeeper.timeZoneEnv" . }}
           resources:
{{- include "ckaf-zookeeper.getResources" (tuple . .Values.jobResources "1") | indent 14 }}
           command:
           - sh
           - -c
           - |
             kubectl get  cm {{ .Release.Name }}-zk-cbur-conf --namespace {{ .Release.Namespace }} -o yaml | grep 'is_restore: "false"'
             if [ $? -eq 0 ]
             then
                 echo "Performing pre-restore actions on zookeeper"
                 echo "Updating ZK cbur config is_restore to true"
                 kubectl patch cm {{ .Release.Name }}-zk-cbur-conf --namespace {{ .Release.Namespace }} --type merge -p '{ "data":{ "is_restore": "true" }}'
                 echo deleting zookeeper pods
                 kubectl delete pods --namespace {{ .Release.Namespace }} -l app={{ .Chart.Name }},release={{ .Release.Name }} --wait=true --timeout=5m

                 echo "Check and update kafka cbur configmap if available"
                 kubectl get cm {{ .Release.Name }}-kf-cbur-conf --namespace {{ .Release.Namespace }}
                 if [ $? -eq 0 ]
                 then
                     echo "Updating KF cbur config is_restore to true"
                     kubectl patch cm {{ .Release.Name }}-kf-cbur-conf --namespace {{ .Release.Namespace }} --type merge -p '{ "data":{ "is_restore": "true" }}'
                     echo deleting kafka pods
                     kubectl delete pods --namespace {{ .Release.Namespace }} -l app=ckaf-kafka,release={{ .Release.Name }} --wait=true --timeout=5m
                     sleep 10s
                     echo waiting for kafka pods to comeup
                     while true
                     do
                         kf_pods=$(kubectl get sts --namespace {{ .Release.Namespace }} -l app=ckaf-kafka,release={{ .Release.Name }} --no-headers=true | awk '{ print$2 }')
                         if [ $(echo $kf_pods | cut -d'/' -f2) == $(echo $kf_pods | cut -d'/' -f1) ]
                         then
                             echo All kafka pods are up
                             break
                         else
                             echo  $(echo $kf_pods | cut -d'/' -f1) of $(echo $kf_pods | cut -d'/' -f2) pods are only up. Waiting for all kafka pods to come up
                         fi
                         sleep 10s
                     done
                 fi

                 echo waiting for zk pods to comeup;
                 while true
                 do
                     zk_pods=$(kubectl get sts --namespace {{ .Release.Namespace }} -l app={{ .Chart.Name }},release={{ .Release.Name }} --no-headers=true | awk '{ print$2 }')
                     if [ $(echo $zk_pods | cut -d'/' -f2) == $(echo $zk_pods | cut -d'/' -f1) ]
                     then
                         echo All Zookeeper pods are up
                         break
                     else
                         echo  $(echo $zk_pods | cut -d'/' -f1) of $(echo $zk_pods | cut -d'/' -f2) pods are only up. Waiting for all ZK pods to come up
                     fi
                     sleep 10s
                 done

                 sleep 5s
             fi
             for pod_id in $(kubectl get pods --namespace {{ .Release.Namespace }} -l app={{ .Chart.Name }},release={{ .Release.Name }} --no-headers=true |   awk '{ print$1 }')
             do
               echo "Cleaning logs and data in pod ${pod_id}"
               kubectl exec ${pod_id} -c {{ template "ckaf-zookeeper.containerName" . }} --namespace {{ .Release.Namespace }} -- sh /etc/confluent/docker/cleanup.sh
             done
             echo ZK prerestore done
{{- end }}

