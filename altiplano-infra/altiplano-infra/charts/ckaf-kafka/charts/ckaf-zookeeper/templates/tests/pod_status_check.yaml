apiVersion: v1
kind: Pod
metadata:
  name: {{ template "ckaf-zookeeper.helmTestJobName" . }}
  labels:
{{ include "ckaf-zookeeper.commonlabels" . | indent 4 }}
{{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- if .Values.global.istio.enabled }}
    sidecar.istio.io/inject: "true"
    {{- end }}
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "3"
{{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
spec:
  {{- include "ckaf-zookeeper.tolerations" . | indent 2 }}
  {{- if .Values.zookeeperNodeSelector.enable }}
  nodeSelector:
{{ toYaml .Values.zookeeperNodeSelector.nodeLabel | indent 4 }}
  {{- end }}
  {{- if  coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
  imagePullSecrets:
    - name: {{ coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
  {{- end }}
  volumes:
    - name: zktestconfigmap
      configMap:
        name: {{ template "ckaf-zookeeper.name" .}}-zk-test-configmap
  containers:
    - name: {{ template "ckaf-zookeeper.helmTestJobContainerName" . }}
      {{- if eq .Values.global.flatRegistry true }}
      image: "{{ .Values.global.registry }}/{{ .Values.kubectlImageName }}:{{ .Values.kubectlTag }}"
      {{- else }}
      image: "{{ coalesce .Values.global.registry3 .Values.global.registry }}/{{ .Values.kubectlImage }}:{{ .Values.kubectlTag }}"
      {{- end }}
      imagePullPolicy: IfNotPresent
      {{- if eq .Values.security.enabled true }}
      securityContext:
        {{- if ( ne ( toString ( .Values.security.runAsUser )) "auto" ) }}
        runAsUser: {{ .Values.security.runAsUser }}
        {{- end }}
        runAsNonRoot: true
        readOnlyRootFilesystem: {{ .Values.security.readOnlyRootFilesystem }}
        {{- if ( ne ( toString ( .Values.security.runAsUser )) "auto" ) }}
        runAsUser: {{ .Values.security.runAsUser }}
        {{- end }}
        allowPrivilegeEscalation: false
        {{- if eq (include "ckaf-zookeeper.renderSeccompProfile" .) "true" }}
        seccompProfile:
          type: {{ .Values.security.seccompProfile.type }}
        {{- end }}
        privileged: false
        capabilities:
          drop: ["ALL"]
      {{- end }}
      env:
      - name: TZ
        value: {{ template "ckaf-zookeeper.timeZoneEnv" . }}
      resources:
        limits:
          cpu: "0.5"
          memory: 256Mi
        requests:
          cpu: "0.25"
          memory: 128Mi
      volumeMounts:
        - name: zktestconfigmap
          mountPath: /zktest/
      command:
         - bash
         - -ec
         - |
           {{- if .Values.global.istio.enabled }}
           until curl --fail -s --head localhost:{{ .Values.global.istio.envoy.healthCheckPort }}/healthz/ready
           do
             echo "Waiting for istio-proxy ..."
             sleep 1
           done
           echo "istio-proxy available"
           {{- end }}
           source /zktest/status_zk_shell_check.sh
           if ! check_pod_status; then
             {{- if .Values.global.istio.enabled }}
             echo "Killing istio-proxy ..."
             curl --fail -X POST http://localhost:{{ .Values.global.istio.envoy.stopPort }}/quitquitquit
             {{- end }}
             exit 1
           fi
          
           if ! check_zookeeper_shell; then
             {{- if .Values.global.istio.enabled }}
             echo "Killing istio-proxy ..."
             curl --fail -X POST http://localhost:{{ .Values.global.istio.envoy.stopPort }}/quitquitquit
             {{- end }}
             exit 1
           fi
           {{- if .Values.global.istio.enabled }}
           echo "Killing istio-proxy ..."
           curl --fail -X POST http://localhost:{{ .Values.global.istio.envoy.stopPort }}/quitquitquit
           {{- end }}
  restartPolicy: Never
  {{- if .Values.global.rbac.enabled }}
  {{- if .Values.serviceAccountName }}
  serviceAccountName: {{ .Values.serviceAccountName }}
  {{- else }}
  serviceAccountName: {{ template "ckaf-zookeeper.name" . }}-zk-test-sa
  {{- end }}
  {{- end }}
  automountServiceAccountToken: true
