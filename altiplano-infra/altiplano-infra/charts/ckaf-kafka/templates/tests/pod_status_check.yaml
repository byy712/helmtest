apiVersion: v1
kind: Pod
metadata:
  name: {{ template "ckaf-kafka.helmTestJobName" . }}
  labels:
{{ include "ckaf-kafka.commonLabels" . | indent 4 }}
{{- include "csf-common-lib.v1.customLabels" (tuple .Values.kfPodLevel.labels .Values.global.labels) | indent 4 }}
  annotations:
    {{- if .Values.global.istio.enabled }}
    sidecar.istio.io/inject: "true"
    {{- end }}
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "3"
{{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.kfPodLevel.annotations .Values.global.annotations) | indent 4 }}
spec:
  {{- include "ckaf-kafka.tolerations" . | indent 2 }}
  {{- if .Values.kafkaNodeSelector.enable }}
  nodeSelector:
{{ toYaml .Values.kafkaNodeSelector.nodeLabel | indent 4 }}
  {{- end }}
  {{- if  coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
  imagePullSecrets:
    - name: {{ coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
  {{- end }}
  volumes:
    - name: kftestconfigmap
      configMap:
        name: {{ template "ckaf-kafka.name" .}}-kf-test-configmap
  containers:
    - name: {{ template "ckaf-kafka.helmTestJobContainerName" . }}
      {{- if eq .Values.global.flatRegistry true }}
      image: "{{ .Values.global.registry }}/{{ .Values.kubectlImageName }}:{{ .Values.kubectlTag }}"
      {{- else }}
      image: "{{ coalesce .Values.global.registry3 .Values.global.registry }}/{{ include "ckaf-kafka.kubectlImageRepo" . }}:{{ .Values.kubectlTag }}"
      {{- end }}
      imagePullPolicy: IfNotPresent
      {{- if eq .Values.security.enabled true }}
      securityContext:
        runAsNonRoot: true
        readOnlyRootFilesystem: {{ .Values.security.readOnlyRootFilesystem }}
        {{- if ( ne ( toString ( .Values.security.runAsUser )) "auto" ) }}
        runAsUser: {{ .Values.security.runAsUser }}
        {{- end }}
        allowPrivilegeEscalation: false
        {{- if eq (include "ckaf-kafka.renderSeccompProfile" .) "true" }}
        seccompProfile:
          type: {{ .Values.security.seccompProfile.type }}
        {{- end }}
        privileged: false
        capabilities:
            drop: ["ALL"]
      {{- end }}
      env:
      - name: TZ
        value: {{ template "ckaf-kafka.timeZoneEnv" . }}
      resources:
        limits:
          cpu: "0.5"
          memory: 256Mi
        requests:
          cpu: "0.25"
          memory: 128Mi
      volumeMounts:
        - name: kftestconfigmap
          mountPath: /kftest/
      command:
         - bash
         - -ec
         - |
           {{- if .Values.global.istio.enabled }}
           until curl --fail -s --head localhost:{{ .Values.global.istio.envoy.healthCheckPort }}/healthz/ready
           do
             echo "Waiting for istio-proxy ..."
             sleep 1
           done
           echo "istio-proxy available"
           {{- end }}
           source /kftest/status_function_check.sh
           if ! check_pod_status; then
             {{- if .Values.global.istio.enabled }}
             echo "Killing istio-proxy ..."
             curl --fail -X POST http://localhost:{{ .Values.global.istio.envoy.stopPort }}/quitquitquit
             {{- end }}
             exit 1 
           fi
           {{- if and (not .Values.zkAclAuthorizer.enable) (not .Values.sasl.enable) (not .Values.ssl.enabled) }}
           if ! verification; then
             {{- if .Values.global.istio.enabled }}
             echo "Killing istio-proxy ..."
             curl --fail -X POST http://localhost:{{ .Values.global.istio.envoy.stopPort }}/quitquitquit
             {{- end }}
             exit 1
           fi
           {{- end }}
           {{- if .Values.global.istio.enabled }}
           echo "Killing istio-proxy ..."
           curl --fail -X POST http://localhost:{{ .Values.global.istio.envoy.stopPort }}/quitquitquit
           {{- end }}
  restartPolicy: Never
  {{- if .Values.global.rbac.enabled }}
  {{- if .Values.serviceAccountName }}
  serviceAccountName: {{ .Values.serviceAccountName }}
  {{- else }}
  serviceAccountName: {{ template "ckaf-kafka.name" . }}-kf-test-sa
  {{- end }}
  {{- end }}
  automountServiceAccountToken: true
