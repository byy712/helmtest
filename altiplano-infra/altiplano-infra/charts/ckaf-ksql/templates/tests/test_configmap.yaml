apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "ckaf-ksql.name" .}}-ksql-test-configmap
  labels:
{{ include "ckaf-ksql.commonlabels" . | indent 4 }}
{{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "1"
{{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
data:
  status_log_check.sh: |
    #!/bin/bash
    RETRY=5
    replicaCount={{ .Values.replicaCount }}
    function check_pod_status() {
       i=0
       echo "CHECKING KSQL POD STATUS"
       while [ $i -lt $RETRY ]
       do
           ksql_pods=$(kubectl get pod --namespace {{ .Release.Namespace }} -l app={{ .Chart.Name }},release={{ .Release.Name }} |grep  Running|wc -l)
           if [[ "$replicaCount" == "$ksql_pods" ]]
           then
              echo "KSQL pod is Up and Running"
              break
           else
              if [[ $i == $(($RETRY-1)) ]]
              then
                 echo "Failed while checking the pod status... Exiting" 
                 return 1
              fi
              echo "KSQL is not Running..Retrying for $i time"
              sleep 10
              (( i=i+1 ))
           fi
       done
    }
