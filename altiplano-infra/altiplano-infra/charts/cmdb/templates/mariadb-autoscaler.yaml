{{- include "cmdb.init" . -}}
{{- if eq (include "cmdb.mariadb_hpa_enabled" .) "true" }}
---
apiVersion: {{ .Capabilities.APIVersions.Has "autoscaling/v2/HorizontalPodAutoscaler" | ternary "autoscaling/v2" "autoscaling/v2beta2" }}
kind: HorizontalPodAutoscaler
metadata:
  name: {{ template "cmdb.pod-prefix" . }}-mariadb
  labels:
    {{- include "cmdb-mariadb.labels" (tuple . "horizontalpodautoscaler") | nindent 4 }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple . "horizontalpodautoscaler") | nindent 4 }}
{{- with .Values.mariadb.hpa }}
spec:
  minReplicas: {{ .minReplicas }}
  maxReplicas: {{ .maxReplicas }}
  metrics:
  {{- if .predefinedMetrics.enabled }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .predefinedMetrics.averageCPUThreshold }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .predefinedMetrics.averageMemoryThreshold }}
  {{- end }}
  {{- if .metrics }}
  {{ toYaml .metrics | nindent 2 }}
  {{- end }}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: {{ .behavior.scaleDown.stabilizationWindowSeconds }}
    {{- if .behavior.scaleDown.policies }}
      policies:
      {{ toYaml .behavior.scaleDown.policies | nindent 6 }}
    {{- end }}
    {{- if .behavior.scaleDown.selectPolicy }}
      selectPolicy: {{ .behavior.scaleDown.selectPolicy }}
    {{- end }}
    scaleUp:
      stabilizationWindowSeconds: {{ .behavior.scaleUp.stabilizationWindowSeconds }}
    {{- if .behavior.scaleUp.policies }}
      policies:
      {{ toYaml .behavior.scaleUp.policies | nindent 6 }}
    {{- end }}
    {{- if .behavior.scaleUp.selectPolicy }}
      selectPolicy: {{ .behavior.scaleUp.selectPolicy }}
    {{- end }}
{{- end }}
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: {{ template "cmdb.pod-prefix" . }}-mariadb
{{- end }}
