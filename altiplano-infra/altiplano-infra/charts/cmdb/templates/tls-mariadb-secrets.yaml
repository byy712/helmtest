{{- include "cmdb.init" . -}}
{{/* Certificate Template */}}
{{- define "cmdb-mariadb.sslcert" }}
{{- $_type := .type -}}
{{- $_cmgr := eq $_type "server" | ternary .ctx.Values.mariadb.certificate .ctx.Values.clients.mariadb.certificate -}}
{{- $_name := printf "%s-%s-cert" (include "cmdb.fullname" .ctx) $_type -}}
---
apiVersion: {{ default "cert-manager.io/v1" .ctx.Values.certManager.apiVersion }}
kind: Certificate
metadata:
  name: {{ $_name }}
  namespace: {{ .ctx.Release.Namespace }}
  labels:
    {{- include "cmdb-mariadb.labels" (tuple .ctx "certificate") | nindent 4 }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple .ctx "certificate") | nindent 4 }}
spec:
  secretName: {{ $_name }}
  issuerRef:
    name: {{ default "ncms-ca-issuer"   $_cmgr.issuerRef.name }}
    kind: {{ default "ClusterIssuer"    $_cmgr.issuerRef.kind }}
    group: {{ default "cert-manager.io" $_cmgr.issuerRef.group }}
  duration: {{ default "8760h" $_cmgr.duration }}
  renewBefore: {{ default "360h"  $_cmgr.renewBefore }}
  # The use of the common name field has been deprecated since 2000 and is
  # discouraged from being used
  commonName: {{ .ctx.Release.Namespace }}.svc.{{ .ctx.Values.clusterDomain }}
  isCA: false
  usages:
    - server auth
    - client auth
  dnsNames:
  {{- if $_cmgr.dnsNames }}
    {{- range $item := $_cmgr.dnsNames }}
    - {{ $item }}
    {{- end }}
  {{- else }}
    - {{ .ctx.Release.Namespace }}.svc.{{ .ctx.Values.clusterDomain }}
  {{- end }}
  {{- if $_cmgr.ipAddresses }}
  ipAddresses:
    {{- range $item := $_cmgr.ipAddresses }}
    - {{ $item }}
    {{- end }}
  {{- end }}
  {{- if $_cmgr.uris }}
  uris:
    {{- range $item := $_cmgr.uris }}
    - {{ $item }}
    {{- end }}
  {{- end }}
  privateKey:
    {{- if hasKey $_cmgr.privateKey "algorithm" }}
    algorithm: {{ $_cmgr.privateKey.algorithm }}
    {{- end }}
    encoding: {{ default "PKCS1"   $_cmgr.privateKey.encoding }}
    {{- if hasKey $_cmgr.privateKey "size" }}
    size: {{ int $_cmgr.privateKey.size }}
    {{- end }}
    rotationPolicy: {{ default "Never"   $_cmgr.privateKey.rotationPolicy }}
{{- end }}

{{/* Server-side SSL Certificate */}}
{{- if and (eq (include "cmdb.tls_enabled" (tuple . "mariadb")) "true") (eq (include "cmdb.mariadb_use_cmgr" .) "true") }}
{{ include "cmdb-mariadb.sslcert" (dict "ctx" . "type" "server") }}
---
{{/* Client-side SSL Certificate */}}
{{ include "cmdb-mariadb.sslcert" (dict "ctx" . "type" "client") }}
{{- end }}
