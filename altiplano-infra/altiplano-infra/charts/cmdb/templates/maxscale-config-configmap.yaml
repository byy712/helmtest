{{- include "cmdb.init" . -}}
{{- if eq (include "cmdb.has_maxscale" .) "true" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cmdb.fullname" . }}-maxscale-config
  labels:
    {{- include "cmdb-maxscale.labels" (tuple . "configmap") | nindent 4 }}
  annotations:
    {{- include "cmdb-maxscale.annotations" (tuple . "configmap") | nindent 4 }}
data:
  maxscale.site: |-
{{- if .Values.maxscale.maxscale_site_conf }}
{{- .Values.maxscale.maxscale_site_conf | nindent 4 }}
{{- end }}
    [maxscale]
    piddir = /etc/mariadb/
    cachedir = /etc/mariadb/maxcache/
    admin_host = ::
    admin_port = {{ .Values.services.maxscale.port }}
{{- if and (eq (include "cmdb.tls_enabled" (tuple . "maxscale")) "true") (or (eq (include "cmdb.maxscale_use_cmgr" .) "true") (ne (default "none" .Values.maxscale.tls.secretRef.name) "none")) }}
    admin_ssl_cert=/etc/certs/maxscale/{{ eq (include "cmdb.maxscale_use_cmgr" .) "true" | ternary "mxs-server-cert.pem" .Values.maxscale.tls.secretRef.keyNames.tlsCrt }}
    admin_ssl_key=/etc/certs/maxscale/{{ eq (include "cmdb.maxscale_use_cmgr" .) "true" | ternary "mxs-server-key.pem" .Values.maxscale.tls.secretRef.keyNames.tlsKey }}
    admin_ssl_ca_cert=/etc/certs/maxscale/{{ eq (include "cmdb.maxscale_use_cmgr" .) "true" | ternary "mxs-server-ca-cert.pem" .Values.maxscale.tls.secretRef.keyNames.caCrt }}
    admin_ssl_version={{ .Values.maxscale.admin_ssl_version }}
{{- end }}
{{- if and (eq (include "cmdb.tls_enabled" (tuple . "mariadb")) "true") (or (eq (include "cmdb.mariadb_use_cmgr" .) "true") (and (ne (default "none" .Values.mariadb.tls.secretRef.name) "none") (ne (default "none" .Values.clients.mariadb.tls.secretRef.name) "none"))) }}
    [SSL]
    ssl=true
    ssl_cert=/etc/my.cnf.d/ssl/{{ eq (include "cmdb.mariadb_use_cmgr" .) "true" | ternary "client-cert.pem" .Values.clients.mariadb.tls.secretRef.keyNames.tlsCrt }}
    ssl_key=/etc/my.cnf.d/ssl/{{ eq (include "cmdb.mariadb_use_cmgr" .) "true" | ternary "client-key.pem" .Values.clients.mariadb.tls.secretRef.keyNames.tlsKey }}
    ssl_ca_cert=/etc/my.cnf.d/ssl/{{ eq (include "cmdb.mariadb_use_cmgr" .) "true" | ternary "client-ca-cert.pem" .Values.clients.mariadb.tls.secretRef.keyNames.caCrt }}
    ssl_cert_verify_depth=9
    ssl_version={{ .Values.maxscale.ssl_version }}
{{- end }}

{{- $add_promotion := and .Values.maxscale.semiSyncReplication (not (contains "rpl_semi_sync" (.Values.maxscale.sql.promotion | join " "))) }}
{{- if or .Values.maxscale.sql.promotion $add_promotion }}
  promotion.sql: |-
{{- range .Values.maxscale.sql.promotion }}
    {{ . | trimSuffix ";" }};
{{- end }}
{{- if $add_promotion }}
    SET GLOBAL rpl_semi_sync_master_enabled=ON;
    SET GLOBAL rpl_semi_sync_slave_enabled=OFF;
{{- end }}
{{- end }}

{{- $add_demotion := and .Values.maxscale.semiSyncReplication (not (contains "rpl_semi_sync" (.Values.maxscale.sql.demotion | join " "))) }}
{{- if or .Values.maxscale.sql.demotion $add_demotion }}
  demotion.sql: |-
{{- range .Values.maxscale.sql.demotion }}
    {{ . | trimSuffix ";" }};
{{- end }}
{{- if $add_demotion }}
    SET GLOBAL rpl_semi_sync_master_enabled=OFF;
    SET GLOBAL rpl_semi_sync_slave_enabled=ON;
{{- end }}
{{- end }}

  logrotate.conf : |-
{{- if .Values.maxscale.logrotate_conf }}
{{- .Values.maxscale.logrotate_conf | nindent 4 }}
{{- end }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cmdb.fullname" . }}-fluentd-config
  labels:
    {{- include "cmdb-maxscale.labels" (tuple . "configmap") | nindent 4 }}
data:
  fluentd.conf: |-
{{- if .Values.maxscale.fluentd_sidecar.fluent_conf }}
{{ tpl .Values.maxscale.fluentd_sidecar.fluent_conf . | indent 4 }}
{{- end }}
  
---
