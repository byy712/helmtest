{{- include "cmdb.init" . -}}
{{- if .Release.IsInstall }}

{{/*
Built-in User credential secret creation
*/}}
{{- if not .Values.users.root.credentialName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "cmdb.fullname" . }}-user-root
  labels:
    {{- include "cmdb-mariadb.labels" (tuple . "secret") | nindent 4 }}
    auto-created: {{ include "cmdb.chart-version" . | quote}}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple . "secret") | nindent 4 }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-failed"
type: Opaque
data:
  username: {{ print "root" | b64enc }}
  password: {{ include "cmdb.pw.root.enc" . | quote }}
{{- if .Values.geo_redundancy.enabled }}
  multi_dc_key: ""
{{- end }}
{{- end -}}

{{- if and (not .Values.users.replication.credentialName) (hasPrefix "master" .Values.cluster_type) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "cmdb.fullname" . }}-user-replication
  labels:
    {{- include "cmdb-mariadb.labels" (tuple . "secret") | nindent 4 }}
    auto-created: {{ include "cmdb.chart-version" . | quote }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple . "secret") | nindent 4 }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-failed"
type: Opaque
data:
  username: {{ .Values.users.replication.username | b64enc }}
  password: {{ include "cmdb.pw.repl.enc" . | quote }}
{{- if .Values.geo_redundancy.enabled }}
  multi_dc_key: ""
{{- end }}
{{- end -}}

{{- if and (not .Values.users.mariadbMetrics.credentialName) .Values.mariadb.metrics.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "cmdb.fullname" . }}-user-mariadb-metrics
  labels:
    {{- include "cmdb-mariadb.labels" (tuple . "secret") | nindent 4 }}
    auto-created: {{ include "cmdb.chart-version" . | quote }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple . "secret") | nindent 4 }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-failed"
type: Opaque
data:
  username: {{ .Values.users.mariadbMetrics.username | b64enc }}
  password: {{ include "cmdb.pw.mariadb_metrics.enc" . | quote }}
{{- if .Values.geo_redundancy.enabled }}
  multi_dc_key: ""
{{- end }}
{{- end -}}

{{- if and (not .Values.users.maxscaleMetrics.credentialName) .Values.maxscale.metrics.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "cmdb.fullname" . }}-user-maxscale-metrics
  labels:
    {{- include "cmdb-mariadb.labels" (tuple . "secret") | nindent 4 }}
    auto-created: {{ include "cmdb.chart-version" . | quote }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple . "secret") | nindent 4 }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-failed"
type: Opaque
data:
  username: {{ .Values.users.maxscaleMetrics.username | b64enc }}
  password: {{ include "cmdb.pw.maxscale_metrics.enc" . | quote }}
{{- if .Values.geo_redundancy.enabled }}
  multi_dc_key: ""
{{- end }}
{{- end -}}

{{- if and (not .Values.users.maxscale.credentialName) (eq (include "cmdb.has_maxscale" .) "true") }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "cmdb.fullname" . }}-user-maxscale
  labels:
    {{- include "cmdb-mariadb.labels" (tuple . "secret") | nindent 4 }}
    auto-created: {{ include "cmdb.chart-version" . | quote }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple . "secret") | nindent 4 }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-failed"
type: Opaque
data:
  username: {{ .Values.users.maxscale.username | b64enc }}
  password: {{ include "cmdb.pw.maxscale.enc" . | quote }}
{{- if .Values.geo_redundancy.enabled }}
  multi_dc_key: ""
{{- end }}
{{- end -}}

{{/*
Add User credential secret creation
*/}}
{{- if .Values.mariadb.users }}
{{- $g := . }}
{{- $set_requires := eq (include "cmdb.tls_enabled" (tuple . "mariadb")) "true" }}
{{- range $index, $item := .Values.mariadb.users }}
{{- if not $item.credentialName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "cmdb.fullname" $g }}-dbuser-{{ $index }}
  labels:
    {{- include "cmdb-mariadb.labels" (tuple $g "secret") | nindent 4 }}
    auto-created: {{ include "cmdb.chart-version" . | quote }}
  annotations:
    {{- include "cmdb-mariadb.annotations" (tuple $g "secret") | nindent 4 }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-6"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-failed"
type: Opaque
data:
  name: {{ $item.name | b64enc | quote }}
  host: {{ default "%" $item.host | b64enc | quote }}
  password: {{ tpl $item.password $ | quote }}
  privilege: {{ $item.privilege | b64enc | quote }}
  object: {{ $item.object | b64enc | quote }}
  {{- if $set_requires }}
  requires: {{ default "" $item.requires | b64enc | quote }}
  {{- end }}
  with: {{ default "" $item.with | b64enc | quote }}
{{- end }}
{{- end }}
{{- end }}

{{ end }}
