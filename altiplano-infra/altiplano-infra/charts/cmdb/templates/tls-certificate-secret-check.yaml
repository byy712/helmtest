{{- include "cmdb.init" . -}}
{{ $mdb_use_tls := eq (include "cmdb.tls_enabled" (tuple . "mariadb")) "true" }}
{{ $mxs_use_tls := eq (include "cmdb.tls_enabled" (tuple . "maxscale")) "true" }}
---
{{/*
*
* A non-manifest helper to check that the configured cert-manager certificates
* are consistent with the tls.secretRef.name secret names configured.
*
*/}}

{{/*
===== MariaDB cert-manager checks =====
*/}}
{{/* If:   mariadb TLS is enabled, and
     Then: - mariadb client certificate must be enabled
           - mariadb tls server secret name must not be specified
           - mariadb tls client secret name must not be specified
*/}}
{{- if and $mdb_use_tls (eq (include "cmdb.mariadb_use_cmgr" .) "true") -}}
{{- if not .Values.clients.mariadb.certificate.enabled -}}
{{- $_ := required "clients.mariadb.certificate.enabled must be true if mariadb.certificate.enabled is true" "" -}}
{{- end -}}
{{- if .Values.mariadb.tls.secretRef.name -}}
{{- $_ := required "mariadb.tls.secretRef.name must not be specified when cert-manager creates certificate" "" -}}
{{- end -}}
{{- if .Values.clients.mariadb.tls.secretRef.name -}}
{{- $_ := required "clients.mariadb.tls.secretRef.name must not be specified when cert-manager creates certificate" "" -}}
{{- end -}}
{{- end -}}

{{/* If:   mariadb TLS is enabled, and
           mariadb server CMGR certificate is not enabled
           mariadb tls server secret is specified
     Then: - mariadb tls client secret name must be specified
*/}}
{{- if and $mdb_use_tls (ne (include "cmdb.mariadb_use_cmgr" .) "true") .Values.mariadb.tls.secretRef.name -}}
{{- $_ := required "clients.mariadb.tls.secretRef.name must be specified when mariadb.tls.secretRef.name is specified" .Values.clients.mariadb.tls.secretRef.name -}}
{{- end -}}

{{/* If:   mariadb TLS is enabled, and
           mariadb server CMGR certificate is not enabled
           mariadb tls server secret is not specified
     Then: - mariadb tls client secret name must not be specified
*/}}
{{- if and $mdb_use_tls (ne (include "cmdb.mariadb_use_cmgr" .) "true") (eq (default "" .Values.mariadb.tls.secretRef.name) "") -}}
{{- if .Values.clients.mariadb.tls.secretRef.name -}}
{{- $_ := required "clients.mariadb.tls.secretRef.name must not be specified when mariadb.tls.secretRef.name is not specified" "" -}}
{{- end -}}
{{- end -}}

{{/*
===== MaxScale cert-manager checks =====
*/}}
{{/* If:   maxscale TLS is enabled, and
           maxscale CMGR certificate is enabled
     Then: - maxscale tls secret name must not be specified
*/}}
{{- if and $mxs_use_tls (eq (include "cmdb.maxscale_use_cmgr" .) "true") -}}
{{- if .Values.maxscale.tls.secretRef.name -}}
{{- $_ := required "maxscale.tls.secretRef.name must not be specified when cert-manager is creating certificate" "" -}}
{{- end -}}
{{- end -}}

{{/* If:   maxscale TLS is enabled, and
           maxscale CMGR certificate is not enabled
     Then: - maxscale tls secret name must be specified
*/}}
{{- if and $mxs_use_tls (ne (include "cmdb.maxscale_use_cmgr" .) "true") -}}
{{- $_ := required "maxscale.tls.secretRef.name must be specified when not using cert-manager" .Values.maxscale.tls.secretRef.name -}}
{{- end -}}
