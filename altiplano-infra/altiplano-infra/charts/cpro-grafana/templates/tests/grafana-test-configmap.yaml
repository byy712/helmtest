apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cpro-grafana.testConfigmap" . }}
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  annotations:
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.annotations) | indent 4}}
data:
  cmd.sh: |
    #!/bin/bash
    RETRY=20

    function wait_pod_running(){
       i=0;
       replicas={{ template "cpro-grafana.replicas" . }}
       echo "wait all containers to start"
       while [ $i -lt $RETRY ]
       do
         numb=$(kubectl get pod --namespace {{ .Release.Namespace }} -l app={{ template "cpro-grafana.name" . }},release={{ .Release.Name }} | grep -P '\s+([1-9]+)\/\1\s+' | grep Running|wc -l)
         pods=$((numb))
         
         if [ "$replicas" == "$pods" ]; then
            echo "Pod status returned success"
            return 0
         else
            sleep 20
            (( i=i+1 ))
         fi
       done
       if [ "$i" == "$RETRY" ]
       then
         echo "Pod status returned failure"
         return 1
       fi
    }
