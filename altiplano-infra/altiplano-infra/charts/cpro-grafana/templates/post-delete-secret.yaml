apiVersion: {{ template "cpro-grafana.grafanaApiVersion.job" . }}
kind: Job
metadata:
  name: "{{ template "cpro-grafana.postDelSecretDeljobPod" . }}"
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.labels .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.annotations .Values.global.annotations) | indent 4}}
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    # If there're multiple hooks, may define differnent hook-weight value. 
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "{{ add .Values.helmDeleteImage.hookWeight 10 }}"
    "helm.sh/hook-delete-policy": hook-succeeded, before-hook-creation
spec:
  activeDeadlineSeconds: {{ default 300 .Values.helmDeleteImage.activeDeadlineSeconds }}
  template:
    metadata:
      labels:
        {{- include "cpro-grafana.app.labels-v3" . | nindent 8 }}
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.labels .Values.custom.pod.labels .Values.global.labels) | indent 8}}
      annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.annotations .Values.custom.pod.annotations .Values.global.annotations) | indent 8}}
{{- if .Values.rbac.pspUseAppArmor }}
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.custom.pod.apparmorAnnotations) | indent 8}}
{{- end }}
        sidecar.istio.io/inject: "false"
    spec:
      automountServiceAccountToken: true
      {{- if or .Values.serviceAccountName .Values.global.serviceAccountName }}
      serviceAccountName: {{ template "cpro-grafana.serviceAccountName" . }}
      {{- else if .Values.rbac.enabled }}
      serviceAccountName: {{ template "cpro-grafana.postDeleteJobResourceName" . }}
      {{- else }}
      serviceAccountName: "default"
      {{- end }}
      securityContext:
      {{$securityContextvalue := dict "cSecCtx" .Values.securityContext "ctx" . }}
      {{- include "cpro-grafana.securitycontext" $securityContextvalue | nindent 8 }}
        {{- if .Values.seLinuxOptions.enabled }}
        seLinuxOptions:
          level: {{ .Values.seLinuxOptions.level }}
          role: {{ .Values.seLinuxOptions.role }}
          type: {{ .Values.seLinuxOptions.type }}
          user: {{ .Values.seLinuxOptions.user }}
        {{- end }}
      restartPolicy: Never
{{ include "cpro-common-lib.imagePullSecrets" (dict "workloadName" .Values.grafana "root" .) | indent 6 }}        
      containers:
      - name: {{ template "cpro-grafana.deletesecretsContainer" . }}
{{- include "cpro-grafana.kubectl.image" (dict "root" . "workload" .Values.helmDeleteImage "imageName" .Values.helmDeleteImage.imagerocky ) | nindent 8}}
{{- include "cpro-grafana.terminationMessage" . | nindent 8 }}
        env:
          {{- include "cpro-grafana.timeZoneName" . | nindent 10 }}
        resources:
{{- include "cpro-common-lib.v1.resources" ( dict "root" . "workloadresources" .Values.helmDeleteImage.resources "defaultcpulimit" "100m") | nindent 10 }}
        securityContext:
        {{$securityContextvalue := dict "cSecCtx" .Values.helmDeleteImage.containerSecurityContext "ctx" . }}
        {{- include "cpro-grafana.containerSecurityContext" $securityContextvalue | nindent 10 }}
        command:
        - sh
        - -c
        - |
     {{ if (eq (include "csf-common-lib.v1.coalesceBoolean" (tuple .Values.grafana.tls.enabled .Values.tls.enabled .Values.global.tls.enabled false)) "true") }}
     {{ if eq (include "csf-common-lib.v1.coalesceBoolean" (tuple .Values.certManager.enabled .Values.global.certManager.enabled false)) "true" }}
     {{ if .Values.grafana.certificate.enabled }}
         kubectl delete secrets --namespace {{ .Release.Namespace }} {{ include "csf-common-lib.v3.certificateSecretName" (tuple . .Values.grafana .Values.grafana.certificate) }}
     {{ end }}
     {{ end }}
     {{ end }}
     {{ if .Values.cmdb.enabled }}
         kubectl delete secrets --namespace {{ .Release.Namespace }} {{ template "cpro-grafana.mdbSecretName" . }}
     {{ end }}
         kubectl delete secrets --namespace {{ .Release.Namespace }} {{ template "cpro-grafana.fullname" . }} --ignore-not-found=true
{{- with .Values.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
{{- end }}
{{- with .Values.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
{{- with .Values.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

