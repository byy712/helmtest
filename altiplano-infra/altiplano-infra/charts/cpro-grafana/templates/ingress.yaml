{{- if .Values.ingress.enabled -}}
{{- $fullName := include "cpro-grafana.service.name" . -}}
{{- $servicePort := .Values.service.port -}}
{{- $ingressPath := .Values.ingress.path -}}
apiVersion: {{ template "cpro-grafana.grafanaApiVersion.ingress" . }}
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.ingress.labels .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.ingress.annotations .Values.global.annotations) | indent 4}}
spec:
{{- if .Values.ingress.tls }}
  tls:
  {{- range .Values.ingress.tls }}
    - hosts:
      {{- range .hosts }}
        - {{ . }}
      {{- end }}
      secretName: {{ .secretName }}
  {{- end }}
{{- end }}
  rules:
{{- if semverCompare "<= 1.19.0-0" .Capabilities.KubeVersion.GitVersion }}
{{- range .Values.ingress.hosts }}
    - host: {{ . }}
      http:
        paths:
          - path: {{ $ingressPath }}
          {{- if semverCompare ">= 1.18.0-0" $.Capabilities.KubeVersion.GitVersion }}
          {{- if eq $.Values.ingress.pathType "" }}
          {{- required "This parameter needs to be provided. Possible Values are Prefix, ImplementationSpecific, Exact" ""}}
          {{- else }}
            pathType: {{ $.Values.ingress.pathType }}
          {{- end }}
          {{- end }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: {{ $servicePort }}
{{- end }}
{{- else }}
{{- range .Values.ingress.hosts }}
    - host: {{ . }}
      http:
        paths:
          - path: {{ $ingressPath }}
          {{- if eq $.Values.ingress.pathType "" }}
          {{- required "This parameter needs to be provided. Possible Values are Prefix, ImplementationSpecific, Exact" ""}}
          {{- else }}
            pathType: {{ $.Values.ingress.pathType }}
          {{- end }}
            backend:
              service:
                name: {{ $fullName }}
                port:
                  number: {{ $servicePort }}
{{- end }}
  {{- end }}
{{- end }}

{{- if .Values.sane }}
  {{- if .Values.sane.enabled }}
  {{- if .Values.sane.ingress }}
---
{{- $fullName := include "cpro-grafana.saneIngressName" . -}}
{{- $servicePort := .Values.sane.servicePort -}}
{{- $ingressPath := .Values.sane.ingress.path -}}
apiVersion: {{ template "cpro-grafana.grafanaApiVersion.ingress" . }}
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.sane.ingress.labels .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.sane.ingress.annotations .Values.global.annotations) | indent 4}}
spec:
{{- if .Values.sane.ingress.tls }}
  tls:
  {{- range .Values.sane.ingress.tls }}
    - hosts:
      {{- range .hosts }}
        - {{ . }}
      {{- end }}
      secretName: {{ .secretName }}
  {{- end }}
{{- end }}
  rules:
{{- if semverCompare "<= 1.19.0-0" .Capabilities.KubeVersion.GitVersion }}
  {{- range .Values.sane.ingress.hosts }}
    - host: {{ . }}
      http:
        paths:
          - path: {{ $ingressPath }}
          {{- if eq $.Values.sane.ingress.pathType "" }}
          {{- required "This parameter needs to be provided. Possible Values are Prefix, ImplementationSpecific,Exact" ""}}
          {{- else }}
            pathType: {{ $.Values.sane.ingress.pathType }}
          {{- end }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: {{ $servicePort }}
  {{- end }}
{{- else }}
  {{- range .Values.sane.ingress.hosts }}
    - host: {{ . }}
      http:
        paths:
          - path: {{ $ingressPath }}
          {{- if eq $.Values.sane.ingress.pathType "" }}
          {{- required "This parameter needs to be provided. Possible Values are Prefix, ImplementationSpecific,Exact" ""}} 
          {{- else }}
            pathType: {{ $.Values.sane.ingress.pathType }}
          {{- end }}
            backend:
              service:
                name: {{ $fullName }}
                port:
                  number: {{ $servicePort }}
{{- end }}
  {{- end }}
  {{- end }}
  {{- end}}
{{- end}}
