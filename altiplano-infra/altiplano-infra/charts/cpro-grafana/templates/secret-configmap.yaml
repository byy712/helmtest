apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cpro-grafana.secretConfigmap" . }}
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  annotations:
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.annotations) | indent 4}}
data:
  update-configmap.sh: |+
    #!/bin/bash
    admin_user=${1:-}
    admin_pwd=${2:-}
    proxy_user=$(echo -ne "${admin_user}")

      {{- range $key_ini, $value := index .Values "grafana_ini" }}
        {{- range $elem, $elemVal := $value }}
          {{- if and (eq $key_ini "auth.basic") (eq $elem "enabled") ( $elemVal ) }}

          auth=$(echo -ne "${admin_user}:${admin_pwd}" | base64 --wrap 0)
          curl_opts=( --header 'Authorization: Basic '${auth} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)

          {{- else if and (eq $key_ini "auth.proxy") (eq $elem "enabled") ( $elemVal ) }}
            {{- range $elem_header, $elemVal_header := $value }}
              {{- if (eq $elem_header "header_name") }}

              curl_opts=( --header '{{ $elemVal_header }}: '${proxy_user} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)
              {{ end }}

          {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}

      grafana_hostname={{ template "cpro-grafana.service.name" . }}
      grafana_port={{ .Values.service.port }}
      protocol={{ .Values.scheme }}

      prom_id="$(curl "${curl_opts[@]}" ${protocol}://${grafana_hostname}:${grafana_port}/api/datasources | jq -r '.[] | select(.name == "{{ .Values.SetDatasource.datasource.name }}").id')"
      prom_method="POST"
      prom_api="/api/datasources"
      if [ "${prom_id}" != "" ]; then
        prom_method="PUT"
        prom_api="/api/datasources/${prom_id}"
      fi
      json_response=$(curl -v -d '
      {
        {{- with .Values.SetDatasource.datasource }}
                  "name":"{{ .name }}","type":"{{ .type }}","url":"{{ .url }}","database":"{{ .database }}","jsonData":{{ .jsonData | toJson }},"secureJsonData":{{ .secureJsonData | toJson }},"access":"{{ .access }}","isDefault":{{ .isDefault }},"user":"{{ .user }}","basicAuth":{{ .basicAuth }},"basicAuthUser":"{{ .basicAuthUser }}","editable":{{ .editable }}
        {{- end }}
      }' -H "Content-Type: application/json" -H "Accept: application/json" -w "%{http_code}" "${curl_opts[@]}" -X ${prom_method} ${protocol}://${grafana_hostname}:${grafana_port}${prom_api})

      source  /opt/grafana-secrets-update/http_code.sh

  http_code.sh: |+
    #!/bin/bash
    message=$(echo "$json_response" | sed -E 's/([0-9]+)$//')
    echo "$message"
    http_code=$(echo "$json_response" | awk -F '[{}]' '{print $NF}')

    if [ "${http_code}" != "200" ]; then
      echo "Failed to perform the requested operation!"
      exit 1
    fi
     
  job-configmap.sh: |+
    #!/bin/bash
    admin_user=${1:-}
    admin_pwd=${2:-}
    proxy_user=$(echo -ne "${admin_user}")

      {{- range $key_ini, $value := index .Values "grafana_ini" }}
        {{- range $elem, $elemVal := $value }}
          {{- if and (eq $key_ini "auth.basic") (eq $elem "enabled") ( $elemVal ) }}
  
          auth=$(echo -ne "${admin_user}:${admin_pwd}" | base64 --wrap 0)
          curl_opts=( --header 'Authorization: Basic '${auth} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)
  
          {{- else if and (eq $key_ini "auth.proxy") (eq $elem "enabled") ( $elemVal ) }}
            {{- range $elem_header, $elemVal_header := $value }}
              {{- if (eq $elem_header "header_name") }}
  
              curl_opts=( --header '{{ $elemVal_header }}: '${proxy_user} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)
              {{ end }}
  
          {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
  
      grafana_hostname={{ template "cpro-grafana.service.name" . }}
      grafana_port={{ .Values.service.port }}
      protocol={{ .Values.scheme }}
      prom_method="POST"
      prom_api="/api/datasources"
  
      curl -v -H "Content-Type:application/json;charset=UTF-8" \
      -H "Accept: application/json" "${curl_opts[@]}" \
      -X ${prom_method} ${protocol}://${grafana_hostname}:${grafana_port}${prom_api} \
      --data-binary \
      {{- with .Values.SetDatasource.datasource }}
      '{"name":"{{ .name }}","type":"{{ .type }}","url":"{{ .url }}","database":"{{ .database }}","jsonData":{{ .jsonData | toJson }},"secureJsonData":{{ .secureJsonData | toJson }},"access":"{{ .access }}","isDefault":{{ .isDefault }},"user":"{{ .user }}","basicAuth":{{ .basicAuth }},"basicAuthUser":"{{ .basicAuthUser }}","editable":{{ .editable }}}'
      {{- end }}

  delete-configmap.sh: |+
    #!/bin/bash
    admin_user=${1:-}
    admin_pwd=${2:-}
    proxy_user=$(echo -ne "${admin_user}")
      {{- range $key_ini, $value := index .Values "grafana_ini" }}
        {{- range $elem, $elemVal := $value }}
          {{- if and (eq $key_ini "auth.basic") (eq $elem "enabled") ( $elemVal ) }}

          auth=$(echo -ne "${admin_user}:${admin_pwd}" | base64 --wrap 0)
          curl_opts=( --header 'Authorization: Basic '${auth} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)

          {{- else if and (eq $key_ini "auth.proxy") (eq $elem "enabled") ( $elemVal ) }}
            {{- range $elem_header, $elemVal_header := $value }}
              {{- if (eq $elem_header "header_name") }}

          curl_opts=( --header '{{ $elemVal_header }}: '${proxy_user} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)
              {{- end }}

          {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}

      grafana_hostname={{ template "cpro-grafana.service.name" . }}
      grafana_port={{ .Values.service.port }}
      protocol={{ .Values.scheme }}
      prom_method="GET"
      # In the line below, '0' is the folderId of General folder. To access other folders the value of folderIds can be changed
      prom_api="/grafana/api/search?query=Kafka%20service%20metrics&folderIds=0"
      json=$(curl -X${prom_method} "${curl_opts[@]}" ${protocol}://${grafana_hostname}:${grafana_port}${prom_api} )
      data=$(echo $json | jq .[].uid)
      uid=$(echo $data | tr -d \")
      prom_method="DELETE"
      prom_api="/grafana/api/dashboards/uid/${uid}"
      curl -X${prom_method} "${curl_opts[@]}" ${protocol}://${grafana_hostname}:${grafana_port}${prom_api}
      # The above curl command deletes the dashboard if present and the result is similar even in the presence of multiple organizations.
      
  import-configmap.sh: |+
    #!/bin/bash
    admin_user=${1:-}
    admin_pwd=${2:-}
    proxy_user=$(echo -ne "${admin_user}")
    

      {{- range $key_ini, $value := index .Values "grafana_ini" }}
        {{- range $elem, $elemVal := $value }}
          {{- if and (eq $key_ini "auth.basic") (eq $elem "enabled") ( $elemVal ) }}

          auth=$(echo -ne "${admin_user}:${admin_pwd}" | base64 --wrap 0)
          curl_opts=( --header 'Authorization: Basic '${auth} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)

          {{- else if and (eq $key_ini "auth.proxy") (eq $elem "enabled") ( $elemVal ) }}
            {{- range $elem_header, $elemVal_header := $value }}
              {{- if (eq $elem_header "header_name") }}

              curl_opts=( --header '{{ $elemVal_header }}: '${proxy_user} --insecure --connect-timeout 5 --max-time 30 --retry 3 --silent --globoff)
              {{ end }}

          {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      if [ -e ./dashboards.zip ] ; then
        base64 -d ./dashboards.zip > ./tmp/dashboards.zip
        unzip ./tmp/dashboards.zip -d ./tmp/
      else
        echo 'dashboards.zip not found'
      fi
      grafana_hostname={{ template "cpro-grafana.service.name" . }}
      grafana_port={{ .Values.service.port }}
      protocol={{ .Values.scheme }}
      prom_method="POST"
      prom_api="/api/dashboards/db"
      for file in `find . -name "*.json"` ; do
        if [ -e "$file" ] ; then
          echo "importing $file" &&
          ( echo '{"dashboard":'; \
            cat "$file"; \
{{- if .Values.SetDashboard.overwrite }}
            echo ',"overwrite":true}' ) \
{{- else }}
            echo ',"overwrite":false}' ) \
{{- end }}
          | jq -c '.' \
          | curl -v -H "Content-Type: application/json" \
            -H "Accept: application/json" "${curl_opts[@]}" \
            -X ${prom_method} ${protocol}://${grafana_hostname}:${grafana_port}${prom_api} \
            --data-binary "@-" &&
          echo "OK" || rc=1
        fi
      done
      rm -rf ./tmp/*
