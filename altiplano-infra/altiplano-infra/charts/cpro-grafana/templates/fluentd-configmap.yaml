{{- $syslogEnabled := eq (include "csf-common-lib.v1.coalesceBoolean" (tuple .Values.grafana.unifiedLogging.syslog.enabled .Values.global.unifiedLogging.syslog.enabled false )) "true"  }}
{{- include "cpro-common-lib.v1.syslog" ( dict "root" . "context" .Values.grafana) }}
{{- if or $syslogEnabled .Values.grafana.unifiedLogging.extension .Values.global.unifiedLogging.extension }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cpro-grafana.fluentdConfigmapName" (dict "name" "fluentdconfigmap" "context" .) }}
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.annotations) | indent 4}}
data:
  fluentd.conf: |
    <system>
      <log>
        format json
        time_format %Y-%m-%dT%H:%M:%S%z
      </log>
    </system>
    <source>
      @type tail
      path /var/log/grafana/grafana.log
      pos_file /var/log/grafana/fluent-grafana.pos
      read_from_head true
      tag {{ template "cpro-grafana.grafanaContainer" . }}
      <parse>
        @type json
      </parse>
    </source>
    <filter {{ template "cpro-grafana.grafanaContainer" . }}>
      @type record_transformer
      enable_ruby true
      renew_record true
      <record>
        log ${ { message: record["msg"],category: record["logger"]  } }
        type "log"
        level ${ record["level"] }
        system ${ ENV["SYSTEM"] }
        systemid ${ ENV["SYSTEMID"] }
        host ${ ENV["PODNAME"]}.${ ENV["RELEASE_NAMESPACE"] || '' }
        timezone ${ ENV["TZ"] }
        container ${tag}
        time ${ record["t"] || record["now"]}
        extension ${require 'json';record.merge(JSON.parse(ENV["EXTENSION_FIELDS"]))}
      </record>
      remove_keys $.extension.@timestamp,$.extension.msg,$.extension.t,$.extension.now,$.extension.logger,$.extension.level
    </filter>
    <match {{ template "cpro-grafana.grafanaContainer" . }}>
      @type rewrite_tag_filter
      <rule>
        key level
        pattern (?i)alert
        tag alert.${tag}
      </rule>
      <rule>
        key level
        pattern .+
        tag notice.${tag}
      </rule>
    </match>
{{- if .Values.sidecar.dashboards.enabled }}
    <source>
      @type tail
      path /var/log/kiwigrid/kiwigrid_dashboard.log
      pos_file /var/log/kiwigrid/fluent-kiwigrid-dashboard.pos
      read_from_head true
      tag {{ template "cpro-grafana.grafanaSidecarDashboard" . }}
      <parse>
        @type json
      </parse>
    </source>
    <filter {{ template "cpro-grafana.grafanaSidecarDashboard" . }}>
      @type record_transformer
      enable_ruby true
      renew_record true
      <record>
        log ${ { message: record["msg"] } }
        type "log"
        level ${ record["level"] }
        system ${ ENV["SYSTEM"] }
        systemid ${ ENV["SYSTEMID"] }
        host ${ ENV["PODNAME"]}.${ ENV["RELEASE_NAMESPACE"] || '' }
        timezone ${ ENV["TZ"] }
        time ${Time.new.strftime('%Y-%m-%dT%H:%M:%S%z')}
        container ${tag}
        extension ${require 'json';record.merge(JSON.parse(ENV["EXTENSION_FIELDS"]))}
      </record>
      remove_keys $.extension.@timestamp,$.extension.msg,$.extension.t,$.extension.now,$.extension.logger,$.extension.level
    </filter>
{{- end }}
{{- if .Values.sidecar.datasources.enabled }}
    <source>
      @type tail
      path /var/log/kiwigrid/kiwigrid_datasource.log
      pos_file /var/log/kiwigrid/fluent-kiwigrid-datasource.pos
      read_from_head true
      tag {{ template "cpro-grafana.grafanaDatasource" . }}
      <parse>
        @type json
      </parse>
    </source>
    <filter {{ template "cpro-grafana.grafanaDatasource" . }}>
      @type record_transformer
      enable_ruby true
      renew_record true
      <record>
        log ${ { message: record["msg"] } }
        type "log"
        level ${ record["level"] }
        system ${ ENV["SYSTEM"] }
        systemid ${ ENV["SYSTEMID"] }
        host ${ ENV["PODNAME"]}.${ ENV["RELEASE_NAMESPACE"] || '' }
        timezone ${ ENV["TZ"] }
        time ${Time.new.strftime('%Y-%m-%dT%H:%M:%S%z')}
        container ${tag}
        extension ${require 'json';record.merge(JSON.parse(ENV["EXTENSION_FIELDS"]))}
      </record>
      remove_keys $.extension.@timestamp,$.extension.msg,$.extension.t,$.extension.now,$.extension.logger,$.extension.level
    </filter>
{{- end }}
    <match notice.** alert.** >
        @type copy
        <store>
          @type stdout
          <format>
            @type json
          </format>
        </store>
        {{- if $syslogEnabled }}
        <store>
          @type remote_syslog
          host {{ tpl $.syslog.host . }}
          port {{ tpl ($.syslog.port | quote) . }}
          {{- if or (eq (tpl $.syslog.protocol . | lower) "tcp") (eq (tpl $.syslog.protocol . | lower) "ssl") }}
          protocol tcp
          {{- else }}
          protocol udp
          {{- end }}
          {{- if tpl (default "" $.syslog.facility) . }}
          facility {{ tpl $.syslog.facility . | lower }}
          {{- end }}
          severity ${tag[0]}
          <format>
            @type json
          </format>
        {{- if and (tpl (default "" $.syslog.tls.secretRef.name) .) (tpl (default "" $.syslog.tls.secretRef.keyNames.caCrt) .) }}
          tls true
          ca_file /etc/fluent/certs/syslogRootCaPem
          {{- end }}
          <buffer tag>
          </buffer>
        </store>
        {{- end }}
    </match>
{{- end }}
