{{- if and ( .Values.cmdb.enabled ) (not .Values.cmdb.retain_data) }}
{{- include "cpro-grafana.istio.grafanaInitIstio" . }}
apiVersion: {{ template "cpro-grafana.grafanaApiVersion.job" . }}
kind: Job
metadata:
  name: "{{ template "cpro-grafana.postDeletejobPod" . }}"
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.labels .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.annotations .Values.global.annotations) | indent 4}}
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    # If there're multiple hooks, may define differnent hook-weight value. 
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "{{ add .Values.helmDeleteImage.hookWeight 9 }}"
    "helm.sh/hook-delete-policy": hook-succeeded, before-hook-creation
spec:
  activeDeadlineSeconds: {{ default 300 .Values.helmDeleteImage.activeDeadlineSeconds }}
  template:
    metadata:
      labels:
        {{- include "cpro-grafana.app.labels-v3" . | nindent 8 }}
        altiplano-role: {{ .Values.accessRoleLabel }}
        app: {{ template "cpro-grafana.fullname" . }}
        release: "{{ .Release.Name }}"
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.labels .Values.custom.pod.labels .Values.global.labels) | indent 8}}
      annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.grafana.annotations .Values.custom.pod.annotations .Values.global.annotations) | indent 8}}
{{- if .Values.rbac.pspUseAppArmor }}
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.custom.pod.apparmorAnnotations) | indent 8}}
{{- end }}
        sidecar.istio.io/inject: "{{ $.istio.enabled }}"
    spec:
      automountServiceAccountToken: true
      {{- if or .Values.serviceAccountName .Values.global.serviceAccountName }}
      serviceAccountName: {{ template "cpro-grafana.serviceAccountName" . }}
      {{- else if .Values.rbac.enabled }}
      serviceAccountName: {{ template "cpro-grafana.postDeleteJobResourceName" . }}
      {{- else }}
      serviceAccountName: "default"
      {{- end }}
      securityContext:
      {{$securityContextvalue := dict "cSecCtx" .Values.securityContext "ctx" . }}
      {{- include "cpro-grafana.securitycontext" $securityContextvalue | nindent 8 }}
        {{- if .Values.seLinuxOptions.enabled }}
        seLinuxOptions:
          level: {{ .Values.seLinuxOptions.level }}
          role: {{ .Values.seLinuxOptions.role }}
          type: {{ .Values.seLinuxOptions.type }}
          user: {{ .Values.seLinuxOptions.user }}
        {{- end }}
      restartPolicy: Never
{{ include "cpro-common-lib.imagePullSecrets" (dict "workloadName" .Values.grafana "root" .) | indent 6 }}        
      containers:
      - name: {{ template "cpro-grafana.deletedbContainer" . }}
{{- include "cpro-grafana.utility.image" (dict "root" . "workload" .Values.grafana "container" .Values.hookImage "imageName" .Values.image.utility) | nindent 8}}
{{- include "cpro-grafana.terminationMessage" . | nindent 8 }}
        env:
          {{- include "cpro-grafana.timeZoneName" . | nindent 10 }}
        resources:
{{- include "cpro-common-lib.v1.resources" ( dict "root" . "workloadresources" .Values.mdbToolImage.resources "defaultcpulimit" "500m") | nindent 10 }}
        securityContext:
        {{$securityContextvalue := dict "cSecCtx" .Values.helmDeleteImage.containerSecurityContext "ctx" . }}
        {{- include "cpro-grafana.containerSecurityContext" $securityContextvalue | nindent 10 }}
        command: ["/bin/sh"]
        args:
         - -c
         - |
           {{- if $.istio.enabled }}
           until [ $(curl --fail --silent --output /dev/stderr --write-out "%{http_code}" localhost:{{- template "cpro-common-lib.istioHealthCheckPort" . -}}/healthz/ready) -eq 200 ]; do
              echo "Waiting for proxy..."
              sleep 1
            done

           echo "istio-proxy available"
           {{- end }}

{{- if and .Values.grafana_ini.database.ssl_mode (ne (.Values.grafana_ini.database.ssl_mode | quote) "false") }}
{{- if eq .Values.cmdb.certsecret  "certmanager" }}
           /usr/bin/secretdata --namespace={{ .Release.Namespace }} --secretPathPrefix={{ .Values.secretPathPrefix }} --certmgrsecretname={{ include "csf-common-lib.v3.certificateSecretName" (tuple . .Values.grafana .Values.grafana.certificate) }} --secretname={{ template "cpro-grafana.mdbSecretName" . }} --sensitivedata={{ .Values.sensitiveDataSecretName }} --scriptname=/usr/bin/grafana_deldb.sh
{{- else }}
           /usr/bin/secretdata --namespace={{ .Release.Namespace }} --secretPathPrefix={{ .Values.secretPathPrefix }} --cmdbsecretname={{ template "cpro-grafana.cmdb.userSecretName" . }} --secretname={{ template "cpro-grafana.mdbSecretName" . }} --sensitivedata={{ .Values.sensitiveDataSecretName }} --scriptname=/usr/bin/grafana_deldb.sh
{{- end }}
{{- else }}
           /usr/bin/secretdata --namespace={{ .Release.Namespace }} --secretPathPrefix={{ .Values.secretPathPrefix }} --secretname={{ template "cpro-grafana.mdbSecretName" . }} --sensitivedata={{ .Values.sensitiveDataSecretName }} --scriptname=/usr/bin/grafana_deldb.sh
{{- end }}

           {{- if $.istio.enabled }}
           curl -X POST http://localhost:{{- template "cpro-common-lib.istioStopPort" . -}}/quitquitquit
           {{- end }}
        volumeMounts:
        {{- if ne .Values.sensitiveDataSecretName "" }}
          - name: sensitivedata
            mountPath: /etc/config/secrets
            readOnly: true
        {{- end }}
          {{- if .Values.grafana.externalCredentials }}
          {{- include "cpro-common-lib.v1-includeExternalCredentialMounts" (dict "creds" .Values.grafana.externalCredentials "root" . ) | indent 10 }}
          {{- end }}
          {{- if ne .Values.grafana.security.credentialName "" }}
          {{- include "cpro-common-lib.v1-includeCredentialMount" (dict "cred" .Values.grafana.security "root" . "volumeName" "graf-security") | indent 10 }}
          {{- end }}
          {{- if ne .Values.cmdb.auth.credentialName "" }}
          {{- include "cpro-common-lib.v1-includeCredentialMount" (dict "cred" .Values.cmdb.auth "root" . "volumeName" "cmdb-auth") | indent 10 }}
          {{- end }}
          {{- if ne .Values.keycloak.auth.credentialName "" }}
          {{- include "cpro-common-lib.v1-includeCredentialMount" (dict "cred" .Values.keycloak.auth "root" . "volumeName" "keycloak-auth") | indent 10 }}
          {{- end }}
          - name: appdata
            mountPath: "/appdata"
      volumes:
      {{- if ne .Values.sensitiveDataSecretName "" }}
        - name: sensitivedata
          secret:
            secretName: {{ .Values.sensitiveDataSecretName }}
      {{- end }}
      {{- if .Values.grafana.externalCredentials  }}
      {{- include "cpro-common-lib.v1-includeExternalCredentials" (dict "creds" .Values.grafana.externalCredentials ) | indent 8 }}
      {{- end }}
      {{- if ne .Values.grafana.security.credentialName "" }}
      {{- include "cpro-common-lib.v1-includeCredential" (dict "creds" .Values.grafana.security "volumeName" "graf-security") | indent 8 -}} 
      {{- end }}
      {{- if ne .Values.cmdb.auth.credentialName "" }}
      {{- include "cpro-common-lib.v1-includeCredential" (dict "creds" .Values.cmdb.auth "volumeName" "cmdb-auth") | indent 8 -}} 
      {{- end }}
      {{- if ne .Values.keycloak.auth.credentialName "" }}
      {{- include "cpro-common-lib.v1-includeCredential" (dict "creds" .Values.keycloak.auth "volumeName" "keycloak-auth") | indent 8 -}} 
      {{- end }}
        - name: appdata
          emptyDir: {}
{{- with .Values.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
{{- end }}
{{- with .Values.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
{{- with .Values.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
{{- end }}
