{{- $Values := .Values }}
{{- $release := .Release }}
{{- $grafanaSecurityCredential := $Values.grafana.security.credentialName }}
{{- $grafanaCmdbCredential := $Values.cmdb.auth.credentialName }}
{{- $grafanaKeycloakCredential := $Values.keycloak.auth.credentialName }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cpro-grafana.fullname" . }}
  labels:
    {{- include "cpro-grafana.app.labels-v3" . | nindent 4 }}
    {{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro-grafana.labelsOrAnnotations" (tuple .Values.global.annotations) | indent 4}}
data:
{{- $root := . -}}
{{- with .Values.plugins }}
  plugins: {{ . | quote }}
{{- end }}
  grafana.ini: |
{{- range $key, $value := index .Values "grafana_ini" }}
    {{- if and (eq $key "security") }}
    {{- if $grafanaSecurityCredential }}
    {{- include "cpro-grafana-update-grafanaIniSecurityForSensitiveData" (dict "key" $key "value" $value "Values" $Values "context" $ "release" $release) }}
    {{- else }}
    {{- include "cpro-grafana-update-grafanaIniSecurity" (dict "key" $key "value" $value "Values" $Values "context" $ "release" $release) }}
    {{- end }}
    {{- else if and (eq $key "database") (ne $grafanaCmdbCredential "") }}
    {{- include "cpro-grafana-update-grafanaIniDatabase" (dict "key" $key "value" $value "Values" $Values "context" $ ) }}
    {{- else if and (eq $key "auth.generic_oauth") (ne $grafanaKeycloakCredential "") }}
    {{- include "cpro-grafana-update-grafanaIniOauth" (dict "key" $key "value" $value "Values" $Values "context" $ ) }}
    {{- else }}
    [{{ $key }}]
    {{- range $elem, $elemVal := $value }}
    {{- if kindIs "string" $elemVal }}
      {{ $elem }} = {{ tpl $elemVal $ }}
     {{- else }}
    {{ $elem }} = {{ $elemVal }}
     {{- end }}
    {{- end }}
{{- end }}
{{- end }}
{{- include "cpro-grafana.syslogValues" . }}
{{- if or $.syslogEnabled .Values.grafana.unifiedLogging.extension .Values.global.unifiedLogging.extension }} 
{{- include "cpro-grafana.syslog.grafana_ini" . | nindent 4 }}
{{- end }}

{{- if .Values.datasources }}
  {{- range $key, $value := .Values.datasources }}
  {{ $key }}: |
{{ toYaml $value | indent 4 }}
  {{- end -}}
{{- end -}}

{{- if .Values.dashboardProviders }}
  {{- range $key, $value := .Values.dashboardProviders }}
  {{ $key }}: |
{{ toYaml $value | indent 4 }}
  {{- end -}}
{{- end -}}

{{- if .Values.dashboards }}
  download_dashboards.sh: |
    #!/usr/bin/env sh
    set -euf
    mkdir -p /var/lib/grafana/dashboards
  {{- range $key, $value := .Values.dashboards }}
    {{- if (or (hasKey $value "gnetId") (hasKey $value "url")) }}
    curl -sk \
    --connect-timeout 60 \
    --max-time 60 \
    -H "Accept: application/json" \
    -H "Content-Type: application/json;charset=UTF-8" \
    {{- if $value.url -}}{{ $value.url }}{{- else -}} https://grafana.com/api/dashboards/{{ $value.gnetId }}/revisions/{{- if $value.revision -}}{{ $value.revision }}{{- else -}}1{{- end -}}/download{{- end -}}{{ if $value.datasource }}| sed 's|\"datasource\":[^,]*|\"datasource\": \"{{ $value.datasource }}\"|g'{{ end }} \
    > /var/lib/grafana/dashboards/{{ $key }}.json
    {{- end }}
  {{- end }}
{{- end }}
