--- bssc-ifd/charts/bssc-indexsearch/templates/sec-admin-job-origin.yaml	2023-12-06 18:41:43.000000000 +0530
+++ bssc-ifd/charts/bssc-indexsearch/templates/sec-admin-job.yaml	2024-06-09 14:12:04.056653568 +0530
@@ -21,11 +21,16 @@
 {{- include "bssc-indexsearch.commonLabels" (tuple .) | indent 4 }}
   annotations:
 {{- include "bssc-indexsearch.csf-toolkit-helm.annotations" (tuple . .Values.custom.hookJobs.job.annotations) | indent 4 }}
+    "helm.sh/hook": post-install
+    "helm.sh/hook-weight": "-8"
+    "helm.sh/hook-delete-policy": before-hook-creation, hook-succeeded
 spec:
-  backoffLimit: {{ default "1" .Values.jobs.secAdminUpgradeJob.backoffLimit }}
+  backoffLimit: {{ default "3" .Values.jobs.secAdminUpgradeJob.backoffLimit }}
+  ttlSecondsAfterFinished: 1800
   template:
     metadata:
       labels:
+        altiplano-role: {{ .Values.accessRoleLabel }}
 {{- include "bssc-indexsearch.csf-toolkit-helm.labels" (tuple . .Values.custom.hookJobs.pod.labels) | indent 8 }}
 {{- include "bssc-indexsearch.commonLabels" (tuple .) | indent 8 }}
       annotations:
@@ -78,8 +83,6 @@
           #Check if cm exists then it is a rollback else an install.
           kubectl get configmap {{ template "bssc-indexsearch.fullname" . }}-osinstalled --namespace {{ .Release.Namespace }}
           if [ $? -ne 0 ];then
-            echo "Started....Waiting for $(( {{ .Values.manager.readinessProbe.initialDelaySeconds }} +20)) seconds" ## add 20s
-            sleep $(( {{ .Values.manager.readinessProbe.initialDelaySeconds }} + 20))
             data_sts_name=$(echo "{{ template "bssc-indexsearch.data.fullname" . }}")
 
             retry_count=0
@@ -88,6 +91,7 @@
             do
               for pod_id in $(kubectl get pods  --namespace {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }},app.kubernetes.io/name={{ default .Chart.Name .Values.nameOverride }},app.kubernetes.io/component={{ .Values.client.name}} --no-headers=true | grep Running | grep {{ template "bssc-indexsearch.client.fullname" . }} | sort -r |  awk '{ print$1 }')
               do
+                find_status=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c 'find /etc/opensearch/config/certs/ . -name "*.enc"')
                 echo "Monitoring ${pod_id} logs"
                 sleep 5
                 {{- if and ( $.syslogEnabled ) (eq .Values.client.syslogSidecar.enabled true ) (not ($.sendLogsViaLog4j)) }}
@@ -96,13 +100,14 @@
                   client_container_name="{{ template "bssc-indexsearch.client.container" . }}"
                 {{- end }}
                 kubectl logs ${pod_id} --namespace {{ .Release.Namespace }} -c ${client_container_name}  > /tmp/is-${pod_id}.log
-                echo "Checking if any data pod joined in cluster"
-                if $(grep -q -m 1 -E "added.*($data_sts_name)" /tmp/is-${pod_id}.log); then
-                  echo "Data node joined. Start running security admin at `date +'%Y.%m.%d-%H:%M:%S'`"
+                  echo "Start running security admin at `date +'%Y.%m.%d-%H:%M:%S'`"
                   ((retry_count++))
                   echo "------------------------------------------------------------"
-                  cmd_status=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c '/opt/opensearch/scripts/auth/securityadmin.sh -cd $SEC_CONFIG_DIRECTORY')
-                  echo -e "Output of running security admin - \n $cmd_status"
+                  delete_security_index=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv -dci')
+                  echo -e "Output of delete security index - \n $delete_security_index"
+
+                  cmd_status=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv')
+                  echo -e "Output of reinitialize security index - \n $cmd_status"
                   echo "------------------------------------------------------------"
                   # The job looks for "Done with success" or SUCC messages for 9 files to check if securityadmin is successful.
                   if [[ $(echo "$cmd_status") != *"ERR:"* ]] && [[ $(echo "$cmd_status" | grep "Done with success" ) || ($(echo "$cmd_status" | grep -E -c "SUCC: Configuration for .* created or updated") -ge 9) ]]; then
@@ -111,6 +116,36 @@
                   else
                     echo "Securityadmin failed due to above error"
                     if [[ $retry_count > 3 ]]; then
+                      echo -e "\nRetrying to run decrypt files in IS client"
+                      echo "Decryption started at `date +'%Y-%m-%d %H:%M:%S:%3N'` "
+                      certs_list=(.keyPass.enc .trustPass.enc .authAdminIdentity.enc clientKeystoreJks.enc truststoreJks.enc)
+                      security_list=(action_groups.yml.enc allowlist.yml.enc audit.yml.enc config.yml.enc internal_users.yml.enc nodes_dn.yml.enc roles.yml.enc roles_mapping.yml.enc tenants.yml.enc whitelist.yml.enc)
+                      for i in "${certs_list[@]}"
+                      do
+                        kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/config/certs/; mv -- \"$i\" "${i%.enc}"; java -cp /etc/sharedMount/Nokia-encrypter.jar com.nokia.fileencrypter.Decrypter /etc/sharedMount/.secretKey /etc/opensearch/config/certs/\"${i%.enc}\""
+                      done
+                      for i in "${security_list[@]}"
+                      do
+                        kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/securityconfig/; mv -- \"$i\" "${i%.enc}"; java -cp /etc/sharedMount/Nokia-encrypter.jar com.nokia.fileencrypter.Decrypter /etc/sharedMount/.secretKey /etc/opensearch/securityconfig/\"${i%.enc}\""
+                      done
+                      delete_security_index=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv -dci')
+                      echo -e "Deleting security index... \n $delete_security_index"
+
+                      reinitialize_security_index=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv')
+                      echo -e "Reinitialize security index... \n $reinitialize_security_index"
+
+                      echo -e "Deleting decrypted files... \n"
+                      kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/config/certs/; find . -depth -name '*' -type f ! -name 'keycloakRootCaPem' ! -name '*.enc' -exec sh -c 'mv -- "{}" "{}.enc"' \;"
+                      kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/securityconfig/; find . -depth -name '*' -type f ! -name '*.enc' -exec sh -c 'mv -- "{}" "{}.enc"' \;"
+                      echo "Decryption ended at `date +'%Y-%m-%d %H:%M:%S:%3N'` "
+                      if [[ $(echo "$reinitialize_security_index" | grep "Done with success" ) || ($(echo "$reinitialize_security_index" | grep -E -c "SUCC: Configuration for .* created or updated") -ge 9) ]] ; then 	
+                        echo "Securityadmin executed successfully at `date +'%Y.%m.%d-%H:%M:%S'`. Install setup is success."	
+                        exit 0
+                      fi
+                      if [[ $(echo "$reinitialize_security_index" | grep "is not in OpenSearch Security 7 format") || $(echo "$reinitialize_security_index" | grep "Parsing failed") ]]
+                      then
+                        kubectl delete pod ${pod_id} --namespace {{ .Release.Namespace }}
+                      fi
                       echo "------------------------------------------------------------"
                       echo "Retry attempts exceeded !! sec-admin-is job install step has failed at `date +'%Y.%m.%d-%H:%M:%S'` exiting!"
                       exit 1
@@ -119,7 +154,6 @@
                       echo -e "\nRetrying to run security admin"
                     fi
                   fi
-                fi
                 rm -rf /tmp/is-${pod_id}.log
               done
               if [ $SECONDS -lt $data_wait_timeout ]; then
