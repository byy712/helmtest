{{- include "bssc-indexsearch.ccrEnabled" . }}
#These RBAC objects are used by install and upgrade jobs of indexsearch.
{{- if ( .Values.rbac.enabled ) }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "bssc-indexsearch.fullname" . |trunc ((sub .Values.customResourceNames.resourceNameLimit 6)|int) }}-is-sa
  namespace: "{{.Release.Namespace}}"
  labels:
{{- include "bssc-indexsearch.commonLabels" (tuple .) | nindent 4 }}
{{- include "bssc-indexsearch.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-indexsearch.csf-toolkit-helm.annotations" (tuple .) | nindent 4 }}
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
automountServiceAccountToken: false
---
kind: RoleBinding
apiVersion: {{ template "bssc-indexsearch.apiVersionRbacAuthorizatioK8sIoV1Beta1orV1" . }}
metadata:
  name: {{ template "bssc-indexsearch.fullname" . }}-is-rb
  namespace: "{{.Release.Namespace}}"
  labels:
{{- include "bssc-indexsearch.commonLabels" (tuple .) | nindent 4 }}
{{- include "bssc-indexsearch.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-indexsearch.csf-toolkit-helm.annotations" (tuple .) | nindent 4 }}
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
subjects:
- kind: ServiceAccount
  name: {{ include "bssc-indexsearch.fullname" . |trunc ((sub .Values.customResourceNames.resourceNameLimit 6)|int) }}-is-sa
  namespace: "{{.Release.Namespace}}"
  apiGroup: ""
roleRef:
  kind: Role
  name: {{ template "bssc-indexsearch.fullname" . }}-is-role
  apiGroup: ""

---
kind: Role
apiVersion: {{ template "bssc-indexsearch.apiVersionRbacAuthorizatioK8sIoV1Beta1orV1" . }}
metadata:
  namespace: "{{.Release.Namespace}}"
  name: {{ template "bssc-indexsearch.fullname" . }}-is-role
  labels:
{{- include "bssc-indexsearch.commonLabels" (tuple .) | nindent 4 }}
{{- include "bssc-indexsearch.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-indexsearch.csf-toolkit-helm.annotations" (tuple .) | nindent 4 }}
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - delete
  - create
  - get
  - list
- apiGroups:
  - ""
  resources:
  - pods
  - pods/log
  verbs:
  - delete
  - list
  - get
- apiGroups:
  - ""
  resources:
  - pods/exec
  verbs:
  - create
- apiGroups:
  - apps
  resources:
  - deployments
  {{- if and (or ($.ccrEnabled) (.Values.restApi.enabled)) (not (.Values.security.enable)) }}
  - statefulsets
  {{- end }}
  verbs:
  - get
  - list
{{- if and (or ($.ccrEnabled) (.Values.restApi.enabled)) (.Values.security.enable ) }}
- apiGroups:
  - batch
  resources:
  - jobs
  verbs:
  - get
  - list
{{- end }}
{{- end }}
---
