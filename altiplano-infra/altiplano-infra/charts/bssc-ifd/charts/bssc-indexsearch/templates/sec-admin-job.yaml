#This script checks for existence of configmap named "{{ template "bssc-indexsearch.fullname" . }}-osinstalled" to distinguish whether the lcm event run is an install or rollback. Based on this check, the script runs with two cases:
#1. Install -> In this case, it monitors client pod logs and checks if a data pod is joined to the client pod. Once data pod has joined, inside the client pod security admin.sh command is run to initialize the security admin. ( Note- security admin would be run on only one client pod). 
#2. Rollback to revision 1 -> In this case, it waits for atleast one client pod to be updated and up and run reload script which will in turn execute security admin with -f config.yml
#If security admin fails to run on a client pod due to some error even after 3 attempts, the sec-admin-is job fails.
#Success criteria for securityAdmin.sh run:
#Securityadmin prints "Done with success" message at the end of successful execution and this can be considered as success criteria.
#It also prints SUCC message for each file successfully uploaded to .opendistro_security index.
#In some cases, even if all the security configuration files get created/updated successfully into .opendistro_security index, if in case the number of nodes in the cluster vary during the execution of securityadmin, it would fail with message "Done with failures". To avoid job failure in such cases, if "Done with success" condition is not met, the job also checks for SUCC msg for each file successfully uploaded to .opendistro_security index.
##1. Install: Here, securityAdmin.sh is run with entire securityconfig directory and there are 9 files currently. The job looks for "Done with success" or SUCC messages for 9 files - if atleast one of these conditions is met, the securityAdmin.sh is considered as successful run.
##2. Rollback to revision 1: For this case, securityAdmin script is run with only config.yml, so it looks for SUCC message for config file and if found, it is considered as successful run.
#
{{- include "bssc-indexsearch.syslogValues" . }}
{{- include "bssc-indexsearch.syslogSendLogsViaLog4j" . }}
{{- if and .Values.security.enable .Release.IsInstall }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "bssc-indexsearch.secAdminJob.name" . }}
  labels:
{{- include "bssc-indexsearch.csf-toolkit-helm.labels" (tuple . .Values.custom.hookJobs.job.labels) | indent 4 }}
{{- include "bssc-indexsearch.commonLabels" (tuple .) | indent 4 }}
  annotations:
{{- include "bssc-indexsearch.csf-toolkit-helm.annotations" (tuple . .Values.custom.hookJobs.job.annotations) | indent 4 }}
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "-8"
    "helm.sh/hook-delete-policy": before-hook-creation, hook-succeeded
spec:
  backoffLimit: {{ default "3" .Values.jobs.secAdminUpgradeJob.backoffLimit }}
  ttlSecondsAfterFinished: 1800
  template:
    metadata:
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
{{- include "bssc-indexsearch.csf-toolkit-helm.labels" (tuple . .Values.custom.hookJobs.pod.labels) | indent 8 }}
{{- include "bssc-indexsearch.commonLabels" (tuple .) | indent 8 }}
      annotations:
        sidecar.istio.io/inject: "false"
{{- include "bssc-indexsearch.csf-toolkit-helm.annotations" (tuple . .Values.custom.hookJobs.pod.annotations) | indent 8 }}
    spec:
      serviceAccountName: {{ template "bssc-indexsearch.inupgServiceAccount.name" . }}
      automountServiceAccountToken: true
      {{- if .Values.jobs.affinity }}
      affinity:
{{ toYaml .Values.jobs.affinity | indent 8 }}
      {{- end }}
      {{- if .Values.jobs.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.jobs.nodeSelector | indent 8 }}
      {{- end }}
      {{- if .Values.jobs.tolerations }}
      tolerations:
{{ toYaml .Values.jobs.tolerations | indent 8 }}
      {{- end }}
      restartPolicy: Never
      securityContext:
{{ include "bssc-indexsearch.pod.securityContext" . | indent 8 }}
      {{- with or .Values.imagePullSecrets .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{- toYaml . | nindent 8 }}
      {{- end }}
      volumes:
      # tmp folder is mounted as emptyDir as client pod logs are stored in /tmp
      - name: tmp
        emptyDir:
          sizeLimit: {{ default "150Mi"  .Values.emptyDirSizeLimit.secAdminJobTmp }}
      containers:
      - name: {{ template "bssc-indexsearch.secAdminContainer.name" .}}
        image: {{ include "bssc-indexsearch.registry" (tuple .Values .Values.internalToolsRegistry) }}/{{ include "bssc-indexsearch.imageRepositoryPath" (tuple .Values.global.flatRegistry .Values.kubectl.image.repo) }}:{{ (include "bssc-indexsearch.imageTag" (tuple .Values.kubectl.image.tag .Values.kubectl.image.supportedImageFlavor .Values .Values.kubectl .Values.kubectl.image )) }}
        securityContext:
{{ include "bssc-indexsearch.container.securityContext" . | indent 10 }}
        resources:
{{ include "bssc-indexsearch.resources" (tuple . .Values.jobs.secAdminUpgradeJob.resources "500m") | indent 10 }}
        env:
        - name: TZ
          value: {{ or .Values.timezone.timeZoneEnv .Values.global.timeZoneEnv "UTC" | quote }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        command:
        - bash
        - "-c"
        - |
          #Check if cm exists then it is a rollback else an install.
          kubectl get configmap {{ template "bssc-indexsearch.fullname" . }}-osinstalled --namespace {{ .Release.Namespace }}
          if [ $? -ne 0 ];then
            data_sts_name=$(echo "{{ template "bssc-indexsearch.data.fullname" . }}")

            retry_count=0
            data_wait_timeout=$(( SECONDS + ( {{ .Values.data.readinessProbe.initialDelaySeconds }} + {{ .Values.data.readinessProbe.periodSeconds }}*{{ .Values.data.readinessProbe.failureThreshold }} + 300 )))
            while true
            do
              for pod_id in $(kubectl get pods  --namespace {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }},app.kubernetes.io/name={{ default .Chart.Name .Values.nameOverride }},app.kubernetes.io/component={{ .Values.client.name}} --no-headers=true | grep Running | grep {{ template "bssc-indexsearch.client.fullname" . }} | sort -r |  awk '{ print$1 }')
              do
                find_status=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c 'find /etc/opensearch/config/certs/ . -name "*.enc"')
                echo "Monitoring ${pod_id} logs"
                sleep 5
                {{- if and ( $.syslogEnabled ) (eq .Values.client.syslogSidecar.enabled true ) (not ($.sendLogsViaLog4j)) }}
                  client_container_name="{{ template "bssc-indexsearch.unifiedLoggingContainer.name" . }}"
                {{- else }}
                  client_container_name="{{ template "bssc-indexsearch.client.container" . }}"
                {{- end }}
                kubectl logs ${pod_id} --namespace {{ .Release.Namespace }} -c ${client_container_name}  > /tmp/is-${pod_id}.log
                  echo "Start running security admin at `date +'%Y.%m.%d-%H:%M:%S'`"
                  ((retry_count++))
                  echo "------------------------------------------------------------"
                  delete_security_index=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv -dci')
                  echo -e "Output of delete security index - \n $delete_security_index"

                  cmd_status=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv')
                  echo -e "Output of reinitialize security index - \n $cmd_status"
                  echo "------------------------------------------------------------"
                  # The job looks for "Done with success" or SUCC messages for 9 files to check if securityadmin is successful.
                  if [[ $(echo "$cmd_status") != *"ERR:"* ]] && [[ $(echo "$cmd_status" | grep "Done with success" ) || ($(echo "$cmd_status" | grep -E -c "SUCC: Configuration for .* created or updated") -ge 9) ]]; then
                    echo "Securityadmin executed successfully at `date +'%Y.%m.%d-%H:%M:%S'`. Install setup is success."
                    exit 0
                  else
                    echo "Securityadmin failed due to above error"
                    if [[ $retry_count > 3 ]]; then
                      echo -e "\nRetrying to run decrypt files in IS client"
                      echo "Decryption started at `date +'%Y-%m-%d %H:%M:%S:%3N'` "
                      certs_list=(.keyPass.enc .trustPass.enc .authAdminIdentity.enc clientKeystoreJks.enc truststoreJks.enc)
                      security_list=(action_groups.yml.enc allowlist.yml.enc audit.yml.enc config.yml.enc internal_users.yml.enc nodes_dn.yml.enc roles.yml.enc roles_mapping.yml.enc tenants.yml.enc whitelist.yml.enc)
                      for i in "${certs_list[@]}"
                      do
                        kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/config/certs/; mv -- \"$i\" "${i%.enc}"; java -cp /etc/sharedMount/Nokia-encrypter.jar com.nokia.fileencrypter.Decrypter /etc/sharedMount/.secretKey /etc/opensearch/config/certs/\"${i%.enc}\""
                      done
                      for i in "${security_list[@]}"
                      do
                        kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/securityconfig/; mv -- \"$i\" "${i%.enc}"; java -cp /etc/sharedMount/Nokia-encrypter.jar com.nokia.fileencrypter.Decrypter /etc/sharedMount/.secretKey /etc/opensearch/securityconfig/\"${i%.enc}\""
                      done
                      delete_security_index=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv -dci')
                      echo -e "Deleting security index... \n $delete_security_index"

                      reinitialize_security_index=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -- bash -c 'source /opt/opensearch/scripts/utility.sh && exportEnv && cd /etc/opensearch/securityconfig/ && /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh -ts $TRUSTSTORE_FILEPATH -ks $CLIENT_KEYSTORE_FILEPATH -cn $CLUSTER_NAME -kspass $KS_PWD -tspass $TS_PWD -h $HOSTNAME -p $HTTP_PORT -nhnv')
                      echo -e "Reinitialize security index... \n $reinitialize_security_index"

                      echo -e "Deleting decrypted files... \n"
                      kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/config/certs/; find . -depth -name '*' -type f ! -name 'keycloakRootCaPem' ! -name '*.enc' -exec sh -c 'mv -- "{}" "{}.enc"' \;"
                      kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- bash -c "cd /etc/opensearch/securityconfig/; find . -depth -name '*' -type f ! -name '*.enc' -exec sh -c 'mv -- "{}" "{}.enc"' \;"
                      echo "Decryption ended at `date +'%Y-%m-%d %H:%M:%S:%3N'` "
                      if [[ $(echo "$reinitialize_security_index" | grep "Done with success" ) || ($(echo "$reinitialize_security_index" | grep -E -c "SUCC: Configuration for .* created or updated") -ge 9) ]] ; then 	
                        echo "Securityadmin executed successfully at `date +'%Y.%m.%d-%H:%M:%S'`. Install setup is success."	
                        exit 0
                      fi
                      if [[ $(echo "$reinitialize_security_index" | grep "is not in OpenSearch Security 7 format") || $(echo "$reinitialize_security_index" | grep "Parsing failed") ]]
                      then
                        kubectl delete pod ${pod_id} --namespace {{ .Release.Namespace }}
                      fi
                      echo "------------------------------------------------------------"
                      echo "Retry attempts exceeded !! sec-admin-is job install step has failed at `date +'%Y.%m.%d-%H:%M:%S'` exiting!"
                      exit 1
                    else
                      sleep 10
                      echo -e "\nRetrying to run security admin"
                    fi
                  fi
                rm -rf /tmp/is-${pod_id}.log
              done
              if [ $SECONDS -lt $data_wait_timeout ]; then
                echo "Waiting for data node to join..."
              else
                echo "ERROR: Data pod could not join within configured timeout."
                exit 1
              fi
            done
          else
            echo "Rolling back to revision 1"
            desired_replica={{.Values.client.replicas }}
            echo "Waiting for client pods to get updated with rollback changes"
            #The job waits until timeout period to find atleast 1 pod to come up with rollback changes. Timeout period is calculated as per readinessProbe parameters configured for client with an additional delay of 300s(5min).
            client_wait_timeout=$((SECONDS+({{ .Values.client.readinessProbe.initialDelaySeconds }}+{{ .Values.client.readinessProbe.periodSeconds }}*{{ .Values.client.readinessProbe.failureThreshold }}+300)))
            #Delay for readiness.initialDelaySeconds sec before starting check if client pod has restarted
            sleep {{ .Values.client.readinessProbe.initialDelaySeconds }}
            while true
            do
              updated_replica=$(kubectl get deployment -n {{ .Release.Namespace }} {{ template "bssc-indexsearch.client.fullname" . }} --no-headers | awk '{ print $3 }')
              if [[ $updated_replica -ge 2 || $desired_replica -eq 1 && $updated_replica -eq 1 ]]; then
                break
              elif [ $SECONDS -ge $client_wait_timeout ]; then
                echo "Error: Even 1 client pod has not got updated with rollback changes. Failing the job as it timed out waiting for the condition"
                exit 1
              fi
            done

            retry=0
            while [ $retry -le 3 ];
            do
              pod_id=$(kubectl get pods  --namespace {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }},app.kubernetes.io/name={{ default .Chart.Name .Values.nameOverride }},app.kubernetes.io/component={{ .Values.client.name}}  --no-headers=true --sort-by=.metadata.creationTimestamp  --field-selector=status.phase==Running | awk '{ print$1 }' | tac | head -1)
              echo "Reloading securityadmin with config.yml on pod ${pod_id} at `date +'%Y.%m.%d-%H:%M:%S'`"
              cmd_status=$(kubectl exec -i ${pod_id} --namespace {{ .Release.Namespace }} -c {{ template "bssc-indexsearch.client.container" . }} -- /opt/opensearch/scripts/reloadSecConfig.sh)
              if [ $? -eq 0 ] && ($(echo $cmd_status | grep -q "SUCC: Configuration for 'config' created or updated")) ;then
                echo "$cmd_status";
                echo "Content of config.yml updated successfully after rollback at `date +'%Y.%m.%d-%H:%M:%S'`, exiting"
                #Deleting the cm created as part of pre-rollback script to distinguish if it is an rollback or not.
                kubectl delete cm {{ template "bssc-indexsearch.fullname" . }}-osinstalled --namespace {{ .Release.Namespace }}  --ignore-not-found=true
                exit 0
              else
                echo "Warning: Failure in updating config.yml after rollback"
                echo "$cmd_status";
              fi
              ((retry++))
              sleep 10
              echo "Retry attempt to update config.yml after rollback : $retry "
            done
            echo "Error: Could not update config.yml after rollback in ${retry} attempts."
            exit 1
          fi
{{- end }}


