{{- if and ( not .Values.fluentd.enable_root_privilege) ( .Values.rbac.enabled ) (.Values.istio.enabled) (not $.istioCni)  }}
{{- if or (and (.Capabilities.APIVersions.Has "policy/v1beta1/PodSecurityPolicy") (.Values.rbac.psp.create)) (and (.Capabilities.APIVersions.Has "security.openshift.io/v1/SecurityContextConstraints") (.Values.rbac.scc.create)) }}
{{- include "bssc-fluentd.istio.initIstio" . }}
apiVersion: {{ template "bssc-fluentd.apiVersionRbacAuthorizatioK8sIoV1Beta1orV1" . }}
kind: RoleBinding
metadata:
  name: {{ template "bssc-fluentd.fullname" . }}-def-rb
  namespace: {{ .Release.Namespace }}
  labels:
{{- include "bssc-fluentd.commonLabels" (tuple . "fluentd" ) | nindent 4 }}
{{- include "bssc-fluentd.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-fluentd.csf-toolkit-helm.annotations" (tuple .) | nindent 4 }}
subjects:
- kind: ServiceAccount
  name: {{ include "bssc-fluentd.fullname" . | trunc ((sub .Values.customResourceNames.resourceNameLimit 7)|int) }}-def-sa
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ template "bssc-fluentd.fullname" . }}-def-role
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: {{ template "bssc-fluentd.apiVersionRbacAuthorizatioK8sIoV1Beta1orV1" . }}
kind: Role
metadata:
  name: {{ template "bssc-fluentd.fullname" . }}-def-role
  labels:
{{- include "bssc-fluentd.commonLabels" (tuple . "fluentd" ) | nindent 4 }}
{{- include "bssc-fluentd.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-fluentd.csf-toolkit-helm.annotations" (tuple .) | nindent 4 }}
rules:
{{- if (.Values.rbac.psp.create) }}
- apiGroups:
  - "extensions" # "" indicates the core API group
  resources:
  - "podsecuritypolicies"
  resourceNames:
  - {{ template "bssc-fluentd.fullname" . }}-psp
  verbs:
  - "use"
{{- end }}
{{- if (.Values.rbac.scc.create) }}
- apiGroups:
  - security.openshift.io
  resourceNames:
  - {{ template "bssc-fluentd.fullname" . }}-scc
  resources:
  - securitycontextconstraints
  verbs:
  - use
{{- end }}

---
{{- if .Values.rbac.psp.create }}
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: {{ template "bssc-fluentd.fullname" . }}-psp
  labels:
{{- include "bssc-fluentd.commonLabels" (tuple . "fluentd" ) | nindent 4 }}
{{- include "bssc-fluentd.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-fluentd.csf-toolkit-helm.annotations" (tuple . .Values.rbac.psp.annotations) | nindent 4 }}
spec:
  volumes:
    - 'downwardAPI'
    - 'configMap'
    - 'emptyDir'
    - 'secret'
    - 'hostPath'
    - 'projected'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  fsGroup:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  allowedCapabilities:
  - 'NET_ADMIN'
  - 'NET_RAW'
{{- end }}

---
{{- if .Values.rbac.scc.create }}
apiVersion: security.openshift.io/v1
kind: SecurityContextConstraints
metadata:
  name: {{ template "bssc-fluentd.fullname" . }}-scc
  labels:
{{- include "bssc-fluentd.commonLabels" (tuple . "fluentd" ) | nindent 4 }}
{{- include "bssc-fluentd.csf-toolkit-helm.labels" (tuple .) | nindent 4 }}
  annotations:
{{- include "bssc-fluentd.csf-toolkit-helm.annotations" (tuple . .Values.rbac.scc.annotations) | nindent 4 }}
allowHostDirVolumePlugin: false
allowHostIPC: false
allowHostNetwork: false
allowHostPID: false
allowHostPorts: false
allowPrivilegeEscalation: true
allowPrivilegedContainer: false
readOnlyRootFilesystem: true
defaultAddCapabilities: []
requiredDropCapabilities:
- 'KILL'
- 'MKNOD'
- 'SETUID'
- 'SETGID'
allowedCapabilities:
- 'NET_ADMIN'
- 'NET_RAW'
runAsUser:
  type: MustRunAsNonRoot
fsGroup:
  type: RunAsAny
seLinuxContext:
  type: MustRunAs
supplementalGroups:
  type: RunAsAny
{{- if semverCompare ">= 1.24.0-0" .Capabilities.KubeVersion.GitVersion }}
seccompProfiles:
- runtime/default
{{- end }}
groups: []
users: []
volumes:
- 'secret'
- 'emptyDir'
- 'configMap'
- 'projected'
- 'downwardAPI'
- 'persistentVolumeClaim'
{{- end }}
{{- end }}
{{- end }}

