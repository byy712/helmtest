{{ if and .Values.repopulateSecretAdminPasswordField ( and (not .Values.secretCredentials.ckeySecret) (not .Values.keycloakPassword)) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "ckey.preUpgradeSecretPopulateJob" . }}
  labels:
    app: {{ template "ckey.fullName" . }}
    release: {{ .Release.Name }}
    {{- include "ckey.customLabels" (tuple .Values.custom.job.labels .Values.global.labels ) | indent 4 }}
    {{- include "ckey.commonLabels" . | indent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade, pre-rollback
    "helm.sh/hook-delete-policy": {{ .Values.hookDeletePolicy }}
    {{- include "ckey.customAnnotations" (tuple .Values.custom.job.annotations .Values.global.annotations) | indent 4 }}
spec:
  template:
    metadata:
      name: {{ template "ckey.preUpgradeSecretPopulateJob" . }}
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
        app: {{ template "ckey.fullName" . }}
        release: {{ .Release.Name }}
        {{- include "ckey.customLabels" (tuple .Values.custom.job.labels .Values.global.labels ) | indent 4 }}
        {{ include "ckey.commonLabels" . | indent 8 }}
      annotations:
        sidecar.istio.io/inject: "false"
        {{- include "ckey.customAnnotations" (tuple .Values.custom.job.annotations .Values.global.annotations) | indent 8 }}
    spec:
      restartPolicy: Never
      serviceAccountName: {{ template "ckey.serviceAccountSecretPopulate" . }}
      automountServiceAccountToken: true
      securityContext:
{{ include "ckey.keycloak.securitycontext" . | indent 8 }}
      containers:
        - name: {{ template "ckey.preUpgradeSecretPopulateContainerName" . }}
          image: {{ include "ckey.container.image" (tuple $ .Values.images.kubectl .Values.internalKubectlRegistry) }}
          imagePullPolicy: "{{ .Values.images.pullPolicy }}"
          securityContext:
          {{- include "ckey.container.securitycontext" . | nindent 12 }}
          env:
            {{- include "ckey.timezone" . | nindent 12 }}
          command:
          - sh
          - -c
          - |

            kubectl get pod {{ template "ckey.keycloak.statefulsetName" . }}-0  -n {{ .Release.Namespace }}

            if [[ $? != 0 ]]; then
               echo 'ckey pod not found! Exiting...'
               exit 0
            fi

            EXEC_CKEY_POD="kubectl exec -n {{ .Release.Namespace }} {{ template "ckey.keycloak.statefulsetName" . }}-0 -c {{ template "ckey.keycloak.containerName" . }} -- /bin/bash -c "

            ADMIN_PASSWORD=$($EXEC_CKEY_POD 'cat /opt/keycloak/security/ckey-secret/keycloak-admin-password')

            kubectl patch secret {{ template "ckey.fullName" . }} -n {{ .Release.Namespace }} \
              --type='json' -p='[{"op" : "replace" ,"path" : "/data/keycloak-admin-password" ,"value" : "'"$(echo -n $ADMIN_PASSWORD | base64)"'"}]'
            STATUS=$?

{{ include "ckey.istio.quit_proxy_container" . | indent 12 }}
            exit $STATUS
          resources:
{{ include "ckey.keycloak.busybox-container-resources-spec" . | indent 12 }}
      {{- if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
      {{- end }}
      {{- include "ckey.imagePullSecrets" (tuple . "kubectl") | nindent 6 }}
      {{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
      {{- end }}
{{ include "ckey.common.affinity" . | indent 6 }}
{{ end }}
