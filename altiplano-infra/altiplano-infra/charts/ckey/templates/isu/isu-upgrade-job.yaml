{{ if .Values.isuUpgrade.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "ckey.keycloak.preUpgradeIsuJob" . }}
  labels:
    app: {{ template "ckey.fullName" . }}
    release: {{ .Release.Name }}
    {{- include "ckey.customLabels" (tuple .Values.custom.job.labels .Values.global.labels ) | indent 4 }}
    {{- include "ckey.commonLabels" . | indent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-delete-policy": {{ .Values.hookDeletePolicy }}
    "helm.sh/hook-weight": "10"
    sidecar.istio.io/inject: "false"
    {{- include "ckey.customAnnotations" (tuple .Values.custom.job.annotations .Values.global.annotations) | indent 4 }}
spec:
  template:
    metadata:
      name: {{ template "ckey.keycloak.isuUpgradeContainerName" . }}
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
        app: {{ template "ckey.fullName" . }}
        release: {{ .Release.Name }}
        {{- include "ckey.customLabels" (tuple .Values.custom.job.labels .Values.global.labels ) | indent 8 }}
        {{- include "ckey.commonLabels" . | indent 8 }}
      annotations:
        {{- include "ckey.common.k8s-client-pod.annotations" . | indent 8 }}
        {{- include "ckey.customAnnotations" (tuple .Values.custom.job.annotations .Values.global.annotations) | indent 8 }}
    spec:
{{ include "ckey.keycloak.isu.common-pod-spec" . | indent 6 }}
      containers:
        - name: {{ template "ckey.keycloak.isuUpgradeContainerName" . }}
          image: {{ include "ckey.container.image" (tuple $ .Values.images.kubectl .Values.internalKubectlRegistry) }}
{{ include "ckey.keycloak.isu.common-container-spec" . | indent 10 }}
          env:
            {{- include "ckey.timezone" . | nindent 12 }}
          command:
          - sh
          - -c
          - |
            {{ if .Values.isuUpgrade.traceLogging }}
            set -x
            {{ end }}
            . /opt/keycloak/isu-common/isu-common.sh
            
            info "Pre-upgrade job started"
            remove_isu_statefulset 2>/dev/null
            info "Putting flag in backup volume to let CBUR know ISU is in progress"
            $EXEC_CKEY_POD 'echo 1 > /ckey/backup/.isu_inprogress'
            sleep 10
            
            {{- if .Values.isuUpgrade.cburBackup.enabled }}
            cbur_backup
            {{- end }}
            create_isu_statefulset {{ .Values.isuUpgrade.tmpPodsReplicaCount | default 2 }}
            wait_isu_statefulset
            {{- if .Values.isuUpgrade.dbSwitching.enabled }}
            create_temp_db
            change_isu_statefulset_db
            wait_isu_statefulset
            {{- end }}
            redirect_requests_to_isu_statefulset
            remove_main_sts

            STATUS=$?
            info "Pre-upgrade job complete"
{{ include "ckey.istio.quit_proxy_container" . | indent 12 }}
            exit $STATUS
          image: {{ include "ckey.container.image" (tuple $ .Values.images.kubectl .Values.internalKubectlRegistry) }}
{{ include "ckey.keycloak.isu.common-container-spec" . | indent 10 }}
      {{- if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
      {{- end }}
      {{- include "ckey.imagePullSecrets" (tuple . "kubectl") | nindent 6 }}
      {{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
      {{- end }}
{{ include "ckey.common.affinity" . | indent 6 }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "ckey.keycloak.postUpgradeIsuJob" . }}
  labels:
    app: {{ template "ckey.fullName" . }}
    release: {{ .Release.Name }}
{{ include "ckey.commonLabels" . | indent 4 }}
{{- include "ckey.customLabels" (tuple .Values.custom.job.labels .Values.global.labels ) | indent 4 }}
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-delete-policy": {{ .Values.hookDeletePolicy }}
    "helm.sh/hook-weight": "15"
    sidecar.istio.io/inject: "false"
    {{- include "ckey.customAnnotations" (tuple .Values.custom.job.annotations .Values.global.annotations) | indent 4 }}
spec:
  template:
    metadata:
      name: {{ template "ckey.keycloak.postUpgradeIsuJob" . }}
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
        app: {{ template "ckey.fullName" . }}
        release: {{ .Release.Name }}
{{ include "ckey.commonLabels" . | indent 8 }}
      annotations:
{{ include "ckey.common.k8s-client-pod.annotations" . | indent 8 }}
    spec:
{{ include "ckey.keycloak.isu.common-pod-spec" . | indent 6 }}
      containers:
        - name: {{ template "ckey.keycloak.isuUpgradeContainerName" . }}
          image: {{ include "ckey.container.image" (tuple $ .Values.images.kubectl .Values.internalKubectlRegistry) }}
{{ include "ckey.keycloak.isu.common-container-spec" . | indent 10 }}
          env:
            {{- include "ckey.timezone" . | nindent 12 }}
          command:
          - sh
          - -c
          - |
            {{ if .Values.isuUpgrade.traceLogging }}
            set -x
            {{ end }}
            . /opt/keycloak/isu-common/isu-common.sh
            info "Post-upgrade job started"
            cleanup
            STATUS=$?
            info "Post-upgrade job complete"
{{ include "ckey.istio.quit_proxy_container" . | indent 12 }}
            exit $STATUS
          image: {{ include "ckey.container.image" (tuple $ .Values.images.kubectl .Values.internalKubectlRegistry) }}
{{ include "ckey.keycloak.isu.common-container-spec" . | indent 10 }}
      {{- if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
      {{- end }}
      {{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
      {{- end }}
{{ include "ckey.common.affinity" . | indent 6 }}
{{ end }}
