apiVersion: v1
kind: Service
metadata:
  name: {{ template "ckey.fullName" . }}
  labels:
    app: {{ template "ckey.chartName" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    {{- include "ckey.customLabels" (tuple .Values.global.labels ) | indent 4 }}
    {{- include "ckey.commonLabels" . | indent 4 }}
  annotations:
    {{- include "ckey.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
{{ toYaml .Values.metric.annotations | indent 4 }}
    {{- if and .Values.httpPort .Values.metric.scrapeMetricsOnHttpPort }}
    "prometheus.io/port": {{ .Values.httpPort | quote }}
    {{- else }}
    "prometheus.io/port": {{ .Values.httpsPort | quote }}
    {{- end }}
spec:
  {{- if .Values.serviceType }}
  type: {{ .Values.serviceType }}
  {{- end }}
  {{- if .Values.serviceClusterIp }}
  clusterIP: {{ .Values.serviceClusterIp }}
  {{- end }}
  ports:
    # Istio docs recommends to prefix port name with the appProtocol.
    # Reference: https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/#explicit-protocol-selection
    # Also according to CKEY's istio design we want istio to consider all the app traffic as plain TCP (although actually they are HTTP or HTTPS). This is because keycloak server by default generates traffic always in TLS mode.
    - name: tcp-secure-keycloak
      port: {{ .Values.httpsPort }}
      targetPort: {{ .Values.httpsPort }}
      protocol: TCP
      appProtocol: tcp
    {{- if .Values.httpPort }}
    - name: tcp-nonsecure-keycloak
      port: {{ .Values.httpPort }}
      targetPort: {{ .Values.httpPort }}
      protocol: TCP
      appProtocol: tcp
    {{- end }}
  {{- include "ckey.dualStack.ipFamilyPolicy.config" ( dict "root" . "context" .Values )  | indent 2 }}
  {{- include "ckey.dualStack.ipFamilies.config" ( dict "root" . "context" .Values )| indent 2 }}
  selector:
    app: {{ template "ckey.chartName" . }}
    release: "{{ .Release.Name }}"
  sessionAffinity: {{ .Values.serviceSessionAffinity }}
