{{- if (eq (include "ckey.certManagerCheck" . ) "true" ) }}
{{- if .Values.istio.enabled -}}
#For istio both drCredentialName and gateway credentialName should be same.
{{- if eq (.Values.tls.certManager.isTlsExternalCertViaCertManager) true -}}
---
apiVersion: {{ template "ckey.certificateVersion" . }}
kind: Certificate
metadata:
  name: {{ template "ckey.fullName" . }}-server-cert-istio
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- include "ckey.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
    "helm.sh/hook": pre-install, pre-upgrade, pre-rollback
    "helm.sh/hook-weight": "-10"
  labels:
  {{- include "ckey.customLabels" (tuple .Values.global.labels ) | indent 4 }}
  {{- include "ckey.commonLabels" . | indent 4 }}
spec:
  secretName: {{ template "ckey.fullName" . }}-server-cert-istio
  issuerRef:
    name: {{ default "ncms-ca-issuer" .Values.tls.certManager.caIssuer.name }}
    kind: {{ default "ClusterIssuer" .Values.tls.certManager.caIssuer.kind }}
    group: {{ default "cert-manager.io" .Values.tls.certManager.caIssuer.group }}
  duration: {{ default "87600h" .Values.tls.certManager.duration }}
  renewBefore: {{ default "360h" .Values.tls.certManager.renewBefore }}
  {{- if .Values.tls.certManager.subject }}
  subject: {{ .Values.tls.certManager.subject | toYaml | nindent 4 }}
  {{- end }}
  privateKey:
  {{- if (.Values.tls.certManager.privateKey | default (dict)).algorithm }}
    algorithm: {{ .Values.tls.certManager.privateKey.algorithm }}
  {{- end }}
  {{- if (.Values.tls.certManager.privateKey | default (dict)).encoding }}
    encoding: {{ .Values.tls.certManager.privateKey.encoding }}
  {{- end }}
  {{- if (.Values.tls.certManager.privateKey | default (dict)).size }}
    size: {{ .Values.tls.certManager.privateKey.size }}
  {{- end }}
  {{- if (.Values.tls.certManager.privateKey | default (dict)).rotationPolicy }}
    rotationPolicy: {{ .Values.tls.certManager.privateKey.rotationPolicy }}
  {{- else }}
    rotationPolicy: Always
  {{- end }}


  {{- if .Values.tls.certManager.usages }}
  usages:
    {{ .Values.tls.certManager.usages | toYaml | indent 2 }}
  {{- else }}
  usages:
    - server auth
    - client auth
  {{- end }}
  dnsNames:
{{ include "ckey.istio.vs.hosts" . | indent 4 }}
{{- end }}
{{- end }}
{{- end }}
