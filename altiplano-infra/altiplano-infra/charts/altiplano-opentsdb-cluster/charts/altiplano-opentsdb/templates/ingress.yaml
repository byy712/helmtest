{{- if .Values.ingress.enabled -}}
{{- $name := include "altiplano-opentsdb.name" . -}}
{{- $ingressPath := .Values.ingress.path -}}
{{- $ingressLimitRps := "1000" -}}
{{- if .Values.env.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.env.INGRESS_LIMIT_RPS -}}
{{- else if .Values.global.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.global.INGRESS_LIMIT_RPS -}}
{{- end }}
{{- $ingressLimitBurstMultiplier := "5" -}}
{{- if .Values.env.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.env.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- else if .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- end }}
{{- $ingressControllerType := .Values.global.INGRESS_CONTROLLER_TYPE }}
{{- $gitVersion := .Capabilities.KubeVersion.GitVersion }}
{{- if semverCompare "<1.19.0-0" $gitVersion }}
apiVersion: networking.k8s.io/v1beta1
{{- else }}
apiVersion: networking.k8s.io/v1
{{- end }}
kind: Ingress
metadata:
  name: {{ template "altiplano-opentsdb.fullname" . }}
  labels:
    app: {{ $name }}
    chart: {{ template "altiplano-opentsdb.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
  {{- if eq $ingressControllerType "nginxinc" }}
{{- with .Values.nginxIncIngress.annotations }}
{{ toYaml . | indent 4 }}
{{- end }}
    nginx.org/location-snippets: |
      proxy_set_header X-Forwarded-Prefix         /{{ $ingressPath }};
      
      #To include a trailing / when the URI is just the ingress path
      {{- if $ingressPath }}
      rewrite "(?i)/{{ $ingressPath }}(/|$)(.*)" /$2 break;
      {{- else }}
      rewrite "(?i)/{{ $name }}(/|$)(.*)" /$2 break;
      {{- end }}
      return 400;
{{- else }}
{{- with .Values.ingress.annotations }}
{{ toYaml . | indent 4 }}
{{- end }}
    # uncomment below if using altiplano-oauth2-proxy
  {{- if $.Values.global.K8S_PUBLIC_HOSTNAME }}
      {{- if .Values.global.INGRESS_CONTROLLER_HTTPSPORT }}
    nginx.ingress.kubernetes.io/auth-signin: https://{{ $.Values.global.K8S_PUBLIC_HOSTNAME }}:{{ .Values.global.INGRESS_CONTROLLER_HTTPSPORT }}/oauth2/start?rd=$escaped_request_uri
      {{- else }}
    nginx.ingress.kubernetes.io/auth-signin: https://{{ $.Values.global.K8S_PUBLIC_HOSTNAME }}/oauth2/start?rd=$escaped_request_uri
      {{- end }}
  {{- else }}
      {{- if .Values.global.INGRESS_CONTROLLER_HTTPSPORT }}
    nginx.ingress.kubernetes.io/auth-signin: https://{{ $.Values.global.K8S_PUBLIC_IP }}:{{ .Values.global.INGRESS_CONTROLLER_HTTPSPORT }}/oauth2/start?rd=$escaped_request_uri
      {{- else }}
    nginx.ingress.kubernetes.io/auth-signin: https://{{ $.Values.global.K8S_PUBLIC_IP }}/oauth2/start?rd=$escaped_request_uri
      {{- end }}
  {{- end }}
  {{- if $.Values.ingress.authUrl }}
    nginx.ingress.kubernetes.io/auth-url: {{ tpl (toYaml $.Values.ingress.authUrl) $ | default "" | indent 2 }}
  {{- else }}
    nginx.ingress.kubernetes.io/auth-url: http://altiplano-oauth2-proxy.{{ $.Release.Namespace }}.svc.cluster.local:4180/oauth2/auth?allowed_groups=%2Fopentsdbadmin
  {{- end }}
    nginx.ingress.kubernetes.io/limit-rps: "{{ $ingressLimitRps }}"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "{{ $ingressLimitBurstMultiplier }}"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/disable-annotation-validation: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^ $request_uri;
      {{- if $ingressPath }}
      rewrite "(?i)/{{ $ingressPath }}(/|$)(.*)" /$2 break;
      {{- else }}
      rewrite "(?i)/{{ $name }}(/|$)(.*)" /$2 break;
      {{- end }}
      return 400;
{{- end }}
spec:
{{- if .Values.ingress.tls }}
  tls:
  {{- range .Values.ingress.tls }}
    - hosts:
      {{- range .hosts }}
        - {{ . }}
      {{- end }}
      secretName: {{ .secretName }}
  {{- end }}
{{- end }}
  rules:
    {{- if .Values.ingress.hosts }}
    {{- range $host := .Values.ingress.hosts }}
  - host: {{ $host }}
    http:
      paths:
  {{- if eq $ingressControllerType "nginxinc" -}}
      {{- if $ingressPath }}
      - path: {{ $ingressPath }}
      {{- else }}
      - path: /{{ $name }}
      {{- end }}
  {{- else }}
      {{- if $ingressPath }}
      - path: {{ $ingressPath }}/?(.*)
      {{- else }}
      - path: /{{ $name }}/?(.*)
      {{- end }}
  {{- end }}
        backend:
          {{- if semverCompare "<1.19.0-0" $gitVersion }}
          serviceName: {{ $name }}
          servicePort: http
          {{- else }}
          service:
            name: {{ $name }}
            port:
              name: http
        pathType: ImplementationSpecific
          {{- end }}
    {{- end -}}
    {{- else }}
  - http:
      paths:
      {{- if eq $ingressControllerType "nginxinc" -}}
      {{- if $ingressPath }}
      - path: {{ $ingressPath }}
      {{- else }}
      - path: /{{ $name }}
        {{- end }}
      {{- else }}
        {{- if $ingressPath }}
      - path: {{ $ingressPath }}/?(.*)
        {{- else }}
      - path: /{{ $name }}/?(.*)
        {{- end }}
      {{- end }}
        backend:
          {{- if semverCompare "<1.19.0-0" $gitVersion }}
          serviceName: {{ $name }}
          servicePort: opentsdbport
          {{- else }}
          service:
            name: {{ $name }}
            port:
              name: opentsdbport
        pathType: ImplementationSpecific
          {{- end }}
    {{- end -}}
{{- end }}
---
{{- if .Values.ingress.enabled -}}
{{- $name := include "altiplano-opentsdb.name" . -}}
{{- $ingressPath := .Values.ingress.path -}}
{{- $ingressLimitRps := "1000" -}}
{{- if .Values.env.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.env.INGRESS_LIMIT_RPS -}}
{{- else if .Values.global.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.global.INGRESS_LIMIT_RPS -}}
{{- end }}
{{- $ingressLimitBurstMultiplier := "5" -}}
{{- if .Values.env.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.env.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- else if .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- end }}
{{- $ingressControllerType := .Values.global.INGRESS_CONTROLLER_TYPE }}
{{- $gitVersion := .Capabilities.KubeVersion.GitVersion }}
{{- if semverCompare "<1.19.0-0" $gitVersion }}
apiVersion: networking.k8s.io/v1beta1
{{- else }}
apiVersion: networking.k8s.io/v1
{{- end }}
kind: Ingress
metadata:
  name: {{ template "altiplano-opentsdb.fullname" . }}-nbi
  labels:
    app: {{ $name }}-nbi
    chart: {{ template "altiplano-opentsdb.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
  {{- if eq $ingressControllerType "nginxinc" }}
{{- with .Values.nginxIncIngress.annotations }}
{{ toYaml . | indent 4 }}
{{- end }}
    nginx.org/location-snippets: |
      proxy_set_header X-Forwarded-Prefix         /{{ $ingressPath }};
      
      #To include a trailing / when the URI is just the ingress path
      {{- if $ingressPath }}
      rewrite "(?i)/{{ $ingressPath }}-nbi(/|$)(.*)" /$2 break;
      {{- else }}
      rewrite "(?i)/{{ $name }}-nbi(/|$)(.*)" /$2 break;
      {{- end }}
      return 400;
{{- else }}
{{- with .Values.ingress.annotations }}
{{ toYaml . | indent 4 }}
{{- end }}
    # uncomment below if using altiplano-oauth2-proxy
  {{- if $.Values.global.K8S_PUBLIC_HOSTNAME }}
    nginx.ingress.kubernetes.io/auth-signin: https://{{ $.Values.global.K8S_PUBLIC_HOSTNAME }}/oauth2-nbi/start?rd=$escaped_request_uri
  {{- else }}
    nginx.ingress.kubernetes.io/auth-signin: https://{{ $.Values.global.K8S_PUBLIC_IP }}/oauth2-nbi/start?rd=$escaped_request_uri
  {{- end }}
  {{- if $.Values.ingress.authUrl }}
    nginx.ingress.kubernetes.io/auth-url: {{ tpl (toYaml $.Values.ingress.authUrl) $ | default "" | indent 2 }}
  {{- else }}
    nginx.ingress.kubernetes.io/auth-url: http://altiplano-oauth2-proxy-nbi.{{ $.Release.Namespace }}.svc.cluster.local:4180/oauth2/auth?allowed_groups=%2Fopentsdbadmin
  {{- end }}
    nginx.ingress.kubernetes.io/limit-rps: "{{ $ingressLimitRps }}"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "{{ $ingressLimitBurstMultiplier }}"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^ $request_uri;
      {{- if $ingressPath }}
      rewrite "(?i)/{{ $ingressPath }}-nbi(/|$)(.*)" /$2 break;
      {{- else }}
      rewrite "(?i)/{{ $name }}-nbi(/|$)(.*)" /$2 break;
      {{- end }}
      return 400;
{{- end }}
spec:
{{- if .Values.ingress.tls }}
  tls:
  {{- range .Values.ingress.tls }}
    - hosts:
      {{- range .hosts }}
        - {{ . }}
      {{- end }}
      secretName: {{ .secretName }}
  {{- end }}
{{- end }}
  rules:
    {{- if .Values.ingress.hosts }}
    {{- range $host := .Values.ingress.hosts }}
  - host: {{ $host }}
    http:
      paths:
  {{- if eq $ingressControllerType "nginxinc" -}}
      {{- if $ingressPath }}
      - path: {{ $ingressPath }}
      {{- else }}
      - path: /{{ $name }}
      {{- end }}
  {{- else }}
      {{- if $ingressPath }}
      - path: {{ $ingressPath }}/?(.*)
      {{- else }}
      - path: /{{ $name }}/?(.*)
      {{- end }}
  {{- end }}
        backend:
          {{- if semverCompare "<1.19.0-0" $gitVersion }}
          serviceName: {{ $name }}
          servicePort: http
          {{- else }}
          service:
            name: {{ $name }}
            port:
              name: http
        pathType: ImplementationSpecific
          {{- end }}
    {{- end -}}
    {{- else }}
  - http:
      paths:
      {{- if eq $ingressControllerType "nginxinc" -}}
      {{- if $ingressPath }}
      - path: {{ $ingressPath }}-nbi
      {{- else }}
      - path: /{{ $name }}-nbi
        {{- end }}
      {{- else }}
        {{- if $ingressPath }}
      - path: {{ $ingressPath }}-nbi/?(.*)
        {{- else }}
      - path: /{{ $name }}-nbi/?(.*)
        {{- end }}
      {{- end }}
        backend:
          {{- if semverCompare "<1.19.0-0" $gitVersion }}
          serviceName: {{ $name }}
          servicePort: opentsdbport
          {{- else }}
          service:
            name: {{ $name }}
            port:
              name: opentsdbport
        pathType: ImplementationSpecific
          {{- end }}
    {{- end -}}
{{- end }}
