{{- include "cbur.initCelery" . }}
{{- include "cbur.unifiedLoggingMerge" (tuple . "cburm") }}
{{- include "cbur.unifiedLogging" (tuple . "cburm") }}
{{- include "cbur.tls" . }}
apiVersion: {{ template "cbur.DeploymentAPI" . }}
kind: Deployment
metadata:
  name: {{ include "cbur.proxy.resourceName" (tuple . "Deployment") }}
  labels:
    heritage: {{ .Release.Service }}
    app: {{ template "cbur.fullname" . }}
    release: {{ .Release.Name }}
    component: "{{ .Release.Name }}-{{ .Values.component }}"
    {{- include "cbur.proxy.commonLabels" (tuple . .Values.cburm.name) | indent 4 }}
    {{- include "cbur.customLabels" (tuple .Values.cburm.labels .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "cbur.customAnnotations" (tuple .Values.cburm.annotations .Values.global.annotations) | indent 4 }}
spec:
  replicas: {{ .Values.replicas }}
  strategy:
    type: Recreate
    rollingUpdate:
  selector:
    matchLabels:
      heritage: {{ .Release.Service }}
      app: {{ template "cbur.fullname" . }}
      release: {{ .Release.Name }}
      component: "{{ .Release.Name }}-{{ .Values.component }}"
  template:
    metadata:
      name: {{ include "cbur.proxy.resourceName" (tuple . "Deployment") }}
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
        heritage: {{ .Release.Service }}
        app: {{ template "cbur.fullname" . }}
        release: {{ .Release.Name }}
        component: "{{ .Release.Name }}-{{ .Values.component }}"
        {{- include "cbur.proxy.commonLabels" (tuple . .Values.cburm.name) | indent 8 }}
        {{- include "cbur.customLabels" (tuple .Values.cburm.labels .Values.global.labels) | indent 8 }}
      annotations:
      {{- include "cbur.customAnnotations" (tuple .Values.cburm.annotations .Values.custom.pod.annotations .Values.global.annotations) | indent 8 }}
      {{- include "cbur.defaultContainer" (tuple . "cburm") | indent 8 }}
      {{- include "cbur.syslogCmChecksum" (tuple . "cburm") | indent 8 }}
      {{- include "cbur.certCmChecksum" . | indent 8 }}
      {{- if .Values.istio.enabled }}
        sidecar.istio.io/inject: "true"
        {{- if .Values.istio.mtls.enabled }}
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
        {{- end }}
      {{- else }}
        sidecar.istio.io/inject: "false"
      {{- end }}
      {{- if .Values.direct_redis.enabled }}
        checksum/secret: {{ include (print $.Template.BasePath "/redis_secret.yaml") . | sha256sum }}
      {{- end }}
      {{- if and .Values.multus.enabled (not .Values.direct_redis.enabled) }}
        {{- include "cbur.multus.annotation" . | nindent 8 }}
      {{- end }}
    spec:
      {{- if .Values.rbac.enabled }}
      serviceAccountName: {{ template "cbur.fullname" . }}
      {{- else if .Values.rbac.serviceAccountName }}
      serviceAccountName: {{ .Values.rbac.serviceAccountName }}
      {{- end }}
      automountServiceAccountToken: true
{{ include "cbur.podSecurityContext" . | indent 6 }}
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName | quote }}
      {{- else if .Values.global.priorityClassName }}
      priorityClassName: {{ .Values.global.priorityClassName | quote }}
      {{- end }}
      {{- if .Values.image.master.imagePullSecrets }}
      imagePullSecrets: {{ toYaml .Values.image.master.imagePullSecrets | nindent 8 }}
      {{- else if .Values.global.imagePullSecrets }}
      imagePullSecrets: {{ toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      initContainers:
      - name: init-{{ .Chart.Name }}
        image: {{ .Values.global.registry }}/{{ .Values.image.init.name }}:{{ .Values.image.init.tag }}
        imagePullPolicy: "{{ .Values.image.init.pullPolicy }}"
        securityContext:
         runAsUser: {{ .Values.securityContext.runAsUser }}
         runAsGroup: {{ .Values.securityContext.runAsGroup }}
         runAsNonRoot: {{ .Values.securityContext.runAsNonRoot }}
        command: [ "/bin/sh", "-c" ]
        args:
          - |
            cp /etc/altiplano/certificates/secrets/cbur-server-trustchain-cert.pem /etc/.certificates/ca-cert.pem
            cp /etc/altiplano/certificates/secrets/cbur-server-cert.pem /etc/.certificates/client-cert.pem
            cp /etc/altiplano/certificates/secrets/cbur-server-key.pem /etc/.certificates/client-key.pem

        volumeMounts:
        - name: cbur-certificates
          mountPath: /etc/.certificates/
        - name: altiplano-cbur-certs
          mountPath: /etc/altiplano/certificates/secrets/
      containers:
{{ include "cbur.syslogSidecar" (tuple . "cburm") | indent 8 }}
        - name: {{ include "cbur.proxy.containerName" (tuple . "cbur") }}
          image: {{ include "cbur.image.mapper" (tuple $ .Values.image.master .Values.internalCBURMasterRegistry) }}
          imagePullPolicy: {{ .Values.image.master.pullPolicy | default "IfNotPresent" | quote }}
{{ include "cbur.containerSecurityContext" . | indent 10 }}
{{ include "cbur.readOnlyRootFilesystem" . | indent 12 }}
{{ include "cbur.containerRunAsUser" . | indent 12 }}
{{ include "cbur.containerRunAsGroup" . | indent 12 }}
          env:
          - name: APP_NAME
            value: "cburm"
          - name: SIDECAR_IMAGE
            value:  {{ include "cbur.image.mapper" (tuple $ .Values.image.agent .Values.internalCBURSidecarRegistry) }}
          - name: SIDECAR_IMAGE_PULLPOLICY
            value: {{ .Values.image.agent.pullPolicy }}
          - name: CBUR_RELEASE_NAME
            value: {{ .Release.Name }}
          - name: CBURM_PORT
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
            value: "{{ .Values.tls.port }}"
          {{- else }}
            value: "{{ .Values.serverPort }}"
          {{- end }}
          - name: CBURM_NAME
            value: {{ template "cbur.fullname" . }}
          - name: CBURM_SCOPE
            value: {{ .Values.cburScope }}
          - name: INCLUDE_NAMESPACES
            value: {{ .Values.includeNamespaces | quote }}
{{- include "cbur.modsecurity" . | indent 10 }}
          - name: TZ
            value: {{ .Values.global.timeZoneEnv | default "UTC" | quote }}
          {{- if .Values.istio.enabled }}
          - name: ISTIO_ENABLED
            value: "true"
          {{- end }}
          - name: JOB_ANNOTATIONS
            value: |+
           {{- include "cbur.customAnnotations" (tuple .Values.cronjob.annotations .Values.custom.job.annotations .Values.global.annotations) | indent 14 }}
          - name: COMMON_LABELS
            value: |+
            {{- include "cbur.proxy.commonLabels" (tuple .) | indent 14 }}
          - name: CUSTOM_LABELS
            value: |+
            {{- include "cbur.customLabels" (tuple .Values.cronjob.labels .Values.global.labels) | indent 14 }}
          - name: TOLERATIONS
            value: |+
            {{- with .Values.tolerations }}
{{ toYaml . | indent 14 }}
            {{- end }}
          - name: CRONJOB_RESOURCES
            value: {{ .Values.cronjob.resources | toJson | quote }}
          - name: CELERY_NAMESPACE
            value: "{{ .Release.Namespace }}"
            {{- if .Values.direct_redis.enabled }}
          - name: USE_CELERY
            value: "true"
          - name: CELERY_DOMAINNAME
            value: {{ template "cbur.fullname" . }}-redis
          - name: CBUR_REDIS_HOST
            value: {{ template "cbur.redisServiceHost" . }}
          - name: CBUR_REDIS_PORT
            value: {{ quote .Values.direct_redis.redis_port }}
          {{- else }}
          - name: USE_CELERY
            value: "false"
          {{- end }}
          - name: CRON_IMAGE
            value:  {{ include "cbur.image.mapper" (tuple $ .Values.image.croncli .Values.internalCBURCliRegistry) }}
          - name: CRON_IMAGE_PULLPOLICY
            value: {{ .Values.image.croncli.pullPolicy }}
{{ include "cbur.cburaImagePullSecret" . | indent 10 }}
{{- include "cbur.croncliImagePullSecret" . | indent 10 }}
{{- include "cbur.alertsPSS" . | indent 10 }}
          {{- if .Values.rbac.enabled }}
          - name: K8S_RBAC_ENABLED
            value: "true"
          - name: SERVICE_ACCOUNT
            value: {{ template "cbur.fullname" . }}
          {{- else if .Values.rbac.serviceAccountName }}
          - name: SERVICE_ACCOUNT
            value: {{ .Values.rbac.serviceAccountName }}
          {{- end }}
          {{- if .Values.nginx }}
          {{- if .Values.nginx.reqLimitRate }}
          - name: REQLIMITRATE
            value: "{{ .Values.nginx.reqLimitRate }}"
          {{- end }}
          {{- if .Values.nginx.reqLimitBurst }}
          - name: REQLIMITBURST
            value: "{{ .Values.nginx.reqLimitBurst }}"
          {{- end }}
          {{- if .Values.nginx.listenIPv4Only }}
          - name: LISTENIPV4ONLY
            value: "YES"
          {{- end }}
          {{- if .Values.nginx.listenIPv6Only }}
          - name: LISTENIPV6ONLY
            value: "YES"
          {{- end }}
          {{- end }}
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
          - name: HTTPS_ENABLED
            value: "YES"
          - name: CBURM_CERTS_PATH
            value: "/etc/ssl/certs/cbur"
          {{- if and .Values.tls.certsPath (not .Values.tls.clientSecretRef.credentialName) }}
          - name: CERTS_PATH
            value: "{{ .Values.tls.certsPath }}"
          {{- else if .Values.tls.clientSecretRef.credentialName }}
          - name: TLS_CLIENT_CREDENTIAL_NAME
            value: {{ .Values.tls.clientSecretRef.credentialName }}
          - name: TLS_CLIENT_CA_CRT_NAME
            value: {{ .Values.tls.clientSecretRef.keyNames.caCrt | default "ca.crt" }}
          - name: TLS_CLIENT_TLS_CRT_NAME
            value: {{ .Values.tls.clientSecretRef.keyNames.tlsCrt | default "tls.crt" }}
          - name: TLS_CLIENT_TLS_KEY_NAME
            value: {{ .Values.tls.clientSecretRef.keyNames.tlsKey | default "tls.key" }}
          {{- else }}
          - name: TLS_CLIENT_CREDENTIAL_NAME
            value: {{ template "cbur.fullname" . }}-client-srt
          {{- end }}
          {{- if .Values.tls.serverSecretRef.credentialName }}
          - name: CBURM_CERTS_SERVER_CA_FILE
            value: {{ .Values.tls.serverSecretRef.keyNames.caCrt | default "ca.crt" }}
          - name: CBURM_CERTS_SERVER_TLS_KEY_FILE
            value: {{ .Values.tls.serverSecretRef.keyNames.tlsKey | default "tls.key" }}
          - name: CBURM_CERTS_SERVER_TLS_CRT_FILE
            value: {{ .Values.tls.serverSecretRef.keyNames.tlsCrt | default "tls.crt" }}
          {{- end }}
          {{- end }}
          {{- if .Values.storageMonitor.enabled }}
          - name: BACKUP_VOL_LOW_THRESHOLD
            value: {{ .Values.storageMonitor.backup_low_threshold }}
          - name: LOCAL_VOL_LOW_THRESHOLD
            value: {{ .Values.storageMonitor.repo_low_threshold }}
          - name: CLUSTER_VOL_LOW_THRESHOLD
            value: {{ .Values.storageMonitor.cluster_backup_low_threshold }}
          - name: BACKUP_VOL_HIGH_THRESHOLD
            value: {{ .Values.storageMonitor.backup_high_threshold }}
          - name: LOCAL_VOL_HIGH_THRESHOLD
            value: {{ .Values.storageMonitor.repo_high_threshold }}
          - name: CLUSTER_VOL_HIGH_THRESHOLD
            value: {{ .Values.storageMonitor.cluster_backup_high_threshold }}
          {{- end }}
          - name: COMPRESSION_METHOD
            value: {{ .Values.dataCompression.method | default "gzip" }}
          - name: COMPRESSION_LEVEL
            value: "6"
          {{- if .Values.dataCompression.pigzThreads }}
          - name: PIGZ_COMPRESSION_THREADS
            value: {{ quote .Values.dataCompression.pigzThreads }}
          {{- end }}
          {{- if .Values.avamar.enabled }}
          - name: AVAMAR_ENABLE
            value: "true"
          {{- end }}
          - name: CBURA_VOLUME_ENABLE
            {{- if .Values.cburaVolume.enabled }}
            value: "true"
            {{- else }}
            value: "false"
            {{- end }}
          {{- if .Values.cburaVolume.enabled }}
          - name: CBURA_STORAGE
            value: {{ .Values.cburaVolume.storage }}
          {{- end }}
          {{- if ne .Values.CEPHS3.endpoint "" }}
          - name: S3_ENDPOINT
            value: {{ .Values.CEPHS3.endpoint }}
          {{- end }}
          {{- if .Values.CEPHS3.credentialName }}
          - name: CEPHS3_CREDENTIAL_NAME
            value: {{ .Values.CEPHS3.credentialName }}
          {{- else if and .Values.CEPHS3.access_key .Values.CEPHS3.secret_key }}
          - name: CEPHS3_CREDENTIAL_NAME_AUTO
            value: {{ template "cbur.fullname" . }}-secret-cephs3
          {{- end }}
          {{- if .Values.AWSS3.credentialName }}
          - name: AWSS3_CREDENTIAL_NAME
            value: {{ .Values.AWSS3.credentialName }}
          {{- else if .Values.AWSS3.region }}
          - name: AWSS3_CREDENTIAL_NAME_AUTO
            value: {{ template "cbur.fullname" . }}-secret-awss3
          {{- end }}
          {{- if .Values.AWSS3.encryption }}
          - name: AWSS3_ENCRYPTION
            value: {{ .Values.AWSS3.encryption }}
          {{- end }}
          {{- if .Values.AWSS3.bucketKeyEnabled }}
          - name: AWSS3_BUCKETEKEYNABLED
            value: "true"
          {{- else }}
          - name: AWSS3_BUCKETEKEYNABLED
            value: "false"
          {{- end }}
          {{- if .Values.GCS.credentialName }}
          - name: GCS_CREDENTIAL_NAME
            value: {{ .Values.GCS.credentialName }}
          {{- end }}
          {{- if ne .Values.GCS.bucketPrefix "" }}
          - name: GCS_BUCKET_PREFIX
            value: {{ .Values.GCS.bucketPrefix }}
          {{- end }}
          {{- if .Values.swiftS3.credentialName }}
          - name: SWIFTS3_CREDENTIAL_NAME
            value: {{ .Values.swiftS3.credentialName }}
          {{- else if and .Values.swiftS3.accessKeyId .Values.swiftS3.secretAccessKey }}
          - name: SWIFTS3_CREDENTIAL_NAME_AUTO
            value: {{ template "cbur.fullname" . }}-secret-swifts3
          {{- end }}
          {{- if .Values.SSH.credentialName }}
          - name: SSH_CREDENTIAL_NAME
            value: {{ .Values.SSH.credentialName }}
          {{- else if and .Values.SSH.username .Values.SSH.host }}
          - name: SSH_CREDENTIAL_NAME_AUTO
            value: {{ template "cbur.fullname" . }}-secret-ssh
          {{- end }}
          {{- if ne .Values.CEPHS3.bucket_prefix "" }}
          - name: CEPHS3_BUCKET_PREFIX
            value: {{ .Values.CEPHS3.bucket_prefix }}
          {{- end }}
          {{- if ne .Values.AWSS3.bucket_prefix "" }}
          - name: AWSS3_BUCKET_PREFIX
            value: {{ .Values.AWSS3.bucket_prefix }}
          {{- end }}
          - name: AWSS3_ACCESS_LOGGING
            {{- if .Values.AWSS3.access_logging }}
            value: "true"
            {{- else }}
            value: "false"
            {{- end }}
          {{- if ne .Values.swiftS3.bucketPrefix "" }}
          - name: SWIFTS3_BUCKET_PREFIX
            value: {{ .Values.swiftS3.bucketPrefix }}
          {{- end }}
          {{- if ne .Values.GLOBAL_BACKEND "" }}
          - name: GLOBAL_BACKEND
            value: {{ .Values.GLOBAL_BACKEND }}
          {{- end }}
          {{- if .Values.direct_redis.enabled }}
          - name: LOGGING_FILE
            value: "/var/log/cbur/br.log"
          - name: AUDIT_LOGGING_FILE
            value: "/var/log/cbur/audit.log"
          {{- end }}
          - name: ENABLE_UNIFIED_LOGGING
          {{- if .Values.unifiedLogging.useLegacyFormat }}
            value: "false"
          {{- else }}
            value: "true"
          {{- end }}
{{- include "cbur.logging.level" . | indent 10 }}
          - name: INTEGRITY_KUBE_CP
            value: {{ quote .Values.integrityCheck.local_enable }}
          - name: INTEGRITY_S3_TRANSFER
            value: {{ quote .Values.integrityCheck.s3_enable }}
          {{- if .Values.integrityCheck.s3Algorithm }}
          - name: INTEGRITY_CHECKSUM_ALGORITHM
            value: {{ quote .Values.integrityCheck.s3Algorithm }}
          {{- end }}
          {{- if .Values.integrityCheck.e2e  }}
          - name: E2E_INTEGRITY_ENABLED
            value: {{ quote .Values.integrityCheck.e2e.enabled }}
          {{- if .Values.integrityCheck.e2e.appIntegritySecret }}
          - name: APP_INTEGRITY_SECRET
            value: {{ quote .Values.integrityCheck.e2e.appIntegritySecret }}
          {{- end }}
          {{- if .Values.integrityCheck.e2e.clusterIntegritySecret }}
          - name: CLUSTER_INTEGRITY_SECRET
            value: {{ quote .Values.integrityCheck.e2e.clusterIntegritySecret }}
          {{- end }}
          {{- end }}
          - name: CLUSTER_NAME
            value: {{ quote .Values.clusterName }}
          - name: CLUSTER_ID
            value: {{ quote .Values.clusterId }}
          {{- if .Values.clusterDomain }}
          - name: CLUSTER_DOMAIN
            value: {{ quote .Values.clusterDomain }}
          {{- end }}
          - name: ONLY_RESTORE
            value: {{ quote .Values.onlyRestore }}
          - name: ENABLE_BR_SCHEMA_VALIDATION
            value: {{ quote .Values.enableBrSchemaValidation }}
          - name: AUTH_ENABLED
            {{- if .Values.auth.enabled }}
            value:  "true"
            {{- else }}
            value:  "false"
            {{- end }}
          - name: AUDITLOG_STANDOUT
            {{- if .Values.auditLogStdout.enabled }}
            value:  "true"
            {{- else }}
            value:  "false"
            {{- end }}
          {{- if or .Values.cburm.unifiedLogging.syslog .Values.global.unifiedLogging.syslog}}
          - name: SYSLOG_ENABLED
            {{- if or .Values.cburm.unifiedLogging.syslog.enabled (and .Values.global.unifiedLogging.syslog .Values.global.unifiedLogging.syslog.enabled) }}
            value:  "true"
            {{- else }}
            value:  "false"
            {{- end }}
          {{- end }}
          - name: KUBE_VERSION
            value: {{ include "cbur.kubeVersion" . }}
          - name: LEGACY_SHORT_SVC_NAME
            {{- if .Values.tls.legacyShortSvcName }}
            value: "true"
            {{- else }}
            value: "false"
            {{- end }}
          {{- if not .Values.unifiedLogging.useLegacyFormat }}
{{ include "cbur.unifiedLoggingExt" (tuple . .Values.cburm.unifiedLogging.extension) | indent 10 }}
          {{- end }}
          {{- if not ( and (.Capabilities.APIVersions.Has "config.openshift.io/v1") ( semverCompare "<1.24.0-0" .Capabilities.KubeVersion.GitVersion )) }}
          - name: SECCOMPROFILE
            value: |+
              type: {{ .Values.securityContext.seccompProfile.type }}
              {{- if eq .Values.securityContext.seccompProfile.type "Localhost" }}
              localhostProfile: {{ .Values.securityContext.seccompProfile.localhostProfile }}
              {{- end }}
          {{- end }}
          {{- if .Values.rbac.accessAllResources }}
          - name: RBAC_ACCESS_ALL_RESOURCES
            value:  "true"
          {{- end }}
          {{- if .Values.rbac.adminRole }}
          - name: RBAC_ADMIN_ROLE
            value:  "true"
          {{- end }}
          {{- if $.Values.rbac.limitBrApiGroupPermission }}
          - name: LIMIT_BR_APIGROUP_PERMISSION
            value:  "true"
          {{- end }}
          - name: SECURITYCONTEXT_ENABLED
            value:  "{{ .Values.securityContext.enabled }}"
          - name: READONLYROOT_ENABLED
            value: "{{ .Values.securityContext.readOnlyRootFilesystem }}"
          {{- include "cbur.copyFlags" . | indent 10 }}
          ports:
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
          - containerPort: 8443
            name: https-cbur
          {{- else }}
          - containerPort: 8080
            name: http-cbur
          {{- end }}
          volumeMounts:
{{ include "cbur.emptydirvolumemount" . | indent 10  }}
          {{- if .Values.istio.enabled }}
{{ include "cbur.istiocheckvolumemount" . | indent 10  }}
          {{- end }}
          {{- if .Values.direct_redis.enabled }}
          - name: redis-password
            mountPath: /etc/redis
            readOnly: true
          {{- end }}
          {{- if not .Values.direct_redis.enabled }}
          - mountPath: /BACKUP
            name: "cbur-backup"
          - mountPath: /CBUR_REPO
            name: "cbur-repo"
            subPath: repo
          {{- if and .Values.k8swatcher.enabled .Values.k8swatcher.clusterBrEnabled }}
          - mountPath: /CLUSTER
            name: "cbur-backup-cluster"
          - mountPath: /etc/ncm.secret
            name: ncm-secret
            readOnly: True
          {{- if and .Values.hostPaths .Values.hostPaths.dirs }}
          {{- range $key, $val := .Values.hostPaths.dirs }}
          - mountPath: {{ $val | quote }}
            name: {{ $key }}
          {{- end }}
          {{- end }}
          {{- if and .Values.hostPaths .Values.hostPaths.files }}
          {{- range $key, $val := .Values.hostPaths.files }}
          - mountPath: {{ $val | quote }}
            name: {{ $key }}
            readOnly: true
          {{- end }}
          {{- end }}
          - mountPath: /root/.helm
            name: "helm-home"
          {{- end }}
          {{- end }}
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
          - mountPath: /etc/ssl/certs/cbur
            name: "certs"
            readOnly: true
          {{- end }}
          command:
            - "bash"
            - "-c"
            - |
            {{- /*
            Clean up the *.tar.gz files in /BACKUP due to CSFS-49972: CBUR does not delete backup files from local after pushing to remote
            */}}
            {{- if and (or .Release.IsInstall .Release.IsUpgrade) (not .Values.direct_redis.enabled) }}
              if ls /BACKUP/*/*/*/*/*.tar.gz > /dev/null 2>&1 ; then
                rm -rf /BACKUP/*/*/*/*
              fi
            {{- end }}
            {{- if .Values.istio.enabled }}
              source ./set_python_env.sh &&
              trap "python /tmp/istio_exit.py" EXIT &&
              python /tmp/istio_ready.py &&
            {{- end }}
            {{- if or (and .Values.cburm.unifiedLogging.syslog .Values.cburm.unifiedLogging.syslog.enabled) (and .Values.global.unifiedLogging.syslog .Values.global.unifiedLogging.syslog.enabled) }}
              /usr/local/bin/supervisord -c /etc/supervisor/conf.d/cburm.conf.syslog
            {{- else }}
              /usr/local/bin/supervisord -c /etc/supervisor/conf.d/cburm.conf
            {{- end }}
          readinessProbe:
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 30
            httpGet:
              path: /v2/status/
              {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
              scheme: HTTPS
              port: 8443
              {{- else }}
              scheme: HTTP
              port: 8080
              {{- end }}
          resources:
{{ include "cbur.resources" (tuple . .Values.resources "3") | indent 12 }}
        - name: {{ include "cbur.proxy.containerName" (tuple . "cbur") }}-fluentd-sidecar
          image: "{{ .Values.global.registry }}/{{ .Values.cbur_fluentd_sidecar.image.name }}:{{ .Values.cbur_fluentd_sidecar.image.tag }}"
          imagePullPolicy: {{ .Values.cbur_fluentd_sidecar.image.pullPolicy }}
          securityContext:
            readOnlyRootFilesystem: true
            runAsUser: 1000
            runAsGroup: {{ .Values.securityContext.runAsGroup }}
            runAsNonRoot: {{ .Values.securityContext.runAsNonRoot }}
          resources:
{{ toYaml .Values.cbur_fluentd_sidecar.resources | indent 12 }}
          env:
          - name: CONTAINER_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name   
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          {{- if .Values.cbur_fluentd_sidecar.secrets }}       
          - name: IS_USERNAME
            valueFrom:
              secretKeyRef:
                key: {{ .Values.env.secrets.IS_USERNAME }}
                name: {{ .Values.cbur_fluentd_sidecar.secrets.passwordSecret | quote }}
          - name: IS_PASSWORD
            valueFrom:
              secretKeyRef:
                key: {{ .Values.env.secrets.IS_PASSWORD }}
                name: {{ .Values.cbur_fluentd_sidecar.secrets.passwordSecret | quote }}
          {{- end}}
          volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: fluentd-config
            mountPath: /etc/fluent/
          - name: cbur-certificates
            mountPath: /etc/.certificates/
          - name: altiplano-cbur-certs
            mountPath: /etc/altiplano/certificates/secrets/
          - name: tmpemptydirvolume
            mountPath: /logs
            subPath: cbur-log
    {{- if .Values.nodeSelectorOverride }}
      nodeSelector:
{{ toYaml .Values.nodeSelectorOverride | indent 8 }}
    {{- else if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
    {{- end }}
    {{- if .Values.cburm.affinity }}
      affinity:
{{ toYaml .Values.cburm.affinity | indent 8 }}
    {{- else if .Values.cburm.podAntiAffinity }}
      affinity:
      {{- include "cbur.proxy.podAntiAffinity" (tuple . .Values.cburm) | nindent 8}}
    {{- end }}
    {{- with .Values.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.topologySpreadConstraints }}
      topologySpreadConstraints:
{{- toYaml . | nindent 8 }}
    {{- end }}
      volumes:
{{ include "cbur.tmpemptydirvolume" . | indent 8  }}
            sizeLimit: {{ index .Values.resources.limits "ephemeral-storage" | quote }}
{{ include "cbur.syslogSidecarVolume" (tuple . "cburm") | indent 8  }}
        - name: tmp
          emptyDir: {}
        {{- if .Values.cbur_fluentd_sidecar.secrets }}
        - name: altiplano-cbur-certs
          secret:
            secretName: {{ (tpl .Values.cbur_fluentd_sidecar.secrets.certSecret .) }}
        - name: cbur-certificates
          emptyDir:
            medium: Memory
        - name: passwords
          secret:
            secretName: {{ (tpl .Values.cbur_fluentd_sidecar.secrets.passwordSecret .) }}
        {{- end}}
        - name: fluentd-config
          configMap:
            name: {{ include "cbur.proxy.resourceName" (tuple . "Deployment") }}-fluentd-config
        - name: logs
          emptyDir: {}
        {{- if .Values.istio.enabled }}
{{ include "cbur.istiocheckvolume" . | indent 8  }}
        {{- end }}
        {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
        {{- if .Values.tls.serverSecretRef.credentialName }}
        - name: "certs"
          secret:
            secretName: {{ .Values.tls.serverSecretRef.credentialName }}
        {{- else if .Values.tls.certsPath }}
        - name: "certs"
          hostPath:
            path: {{ .Values.tls.certsPath }}
        {{- else }}
        - name: "certs"
          secret:
            secretName: {{ template "cbur.fullname" . }}-server-srt
        {{- end  }}
        {{- end  }}
        {{- if .Values.direct_redis.enabled }}
        - name: "redis-password"
          secret:
            secretName: cbur-redis
        {{- end }}
        {{- if not .Values.direct_redis.enabled }}
        - name: "cbur-backup"
          {{- if .Values.volumeType.glusterfs }}
          glusterfs:
            endpoints: {{ .Values.volumeType.backupEndpoints | quote }}
            path: {{ .Values.volumeType.backupPath }}
          {{- else  }}
          persistentVolumeClaim:
            {{- if .Values.directPvc.enabled }}
            claimName: {{ .Values.directPvc.backupPvcName }}
            {{- else }}
            claimName: {{ template "cbur.fullname" . }}-backup
            {{- end }}
          {{- end }}
        - name: "cbur-repo"
          {{- if .Values.volumeType.glusterfs }}
          glusterfs:
            endpoints: {{ .Values.volumeType.repoEndpoints | quote }}
            path: {{ .Values.volumeType.repoPath }}
          {{- else  }}
          persistentVolumeClaim:
            {{- if .Values.directPvc.enabled }}
            claimName: {{ .Values.directPvc.repoPvcName }}
            {{- else }}
            claimName: {{ template "cbur.fullname" . }}-repo
            {{- end }}
          {{- end }}
        {{- if and .Values.k8swatcher.enabled .Values.k8swatcher.clusterBrEnabled }}
        - name: "cbur-backup-cluster"
          {{- if .Values.volumeType.glusterfs }}
          glusterfs:
            endpoints: {{ .Values.volumeType.backupClusterEndpoints | quote }}
            path: {{ .Values.volumeType.backupClusterPath }}
          {{- else  }}
          persistentVolumeClaim:
            {{- if .Values.directPvc.enabled }}
            claimName: {{ .Values.directPvc.backupClusterPvcName }}
            {{- else }}
            claimName: {{ template "cbur.fullname" . }}-backup-cluster
            {{- end }}
          {{- end }}
        - name: ncm-secret
          secret:
            secretName: cbur-ncm-secret
        {{- if and .Values.hostPaths .Values.hostPaths.dirs }}
        {{- range $key, $val := .Values.hostPaths.dirs }}
        - name: {{ $key }}
          hostPath:
            path: {{ $val | quote }}
            type: Directory
        {{- end }}
        {{- end }}
        {{- if and .Values.hostPaths .Values.hostPaths.files }}
        {{- range $key, $val := .Values.hostPaths.files }}
        - name: {{ $key }}
          hostPath:
            path: {{ $val | quote }}
            type: File
        {{- end }}
        {{- end }}
        - name: "helm-home"
          {{- include "cbur.helmHome.path" . | indent 10 }}
        {{- end }}
        {{- end  }}
