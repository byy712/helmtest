apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Release.Name }}-check"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cbur.proxy.commonLabels" (tuple .) | indent 4 }}
    {{- include "cbur.customLabels" (tuple .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "cbur.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
data:
  istio_ready.py: |
    import requests
    import sys
    import time
    import urllib3

    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

    i = 0
    while i < 120:
      try:
        r=requests.get("http://localhost:15020/healthz/ready", verify=False, cert=None, auth=None, headers=None)
        #print("istio proxy status: %s" % r.text)
        if r.status_code == requests.codes.ok:
            print("Istio network Ready now.")
            sys.exit(0)
      except Exception as e:
        print("exception is %s" %e)
        print("Waiting istio network Ready")
      time.sleep(1)
      i = i + 1
    sys.exit(1)
  istio_exit.py: |
    import requests
    import urllib3

    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    requests.post("http://localhost:15020/quitquitquit", verify=False, cert=None, auth=None, headers=None)
  request.py: |
    import os
    import requests
    import urllib3
    from swagger_server.utils.string import str2bool

    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

    SERVICE_URL = os.environ['SERVICE_URL']
    CBURM_PORT = os.environ['CBURM_PORT']
    HTTPS_ENABLED = str2bool(os.environ.get("HTTPS_ENABLED", False))
    if HTTPS_ENABLED:
        url = "https://%s:%s/v2/status/" % (SERVICE_URL,CBURM_PORT)
    else:
        url = "http://%s:%s/v2/status/" % (SERVICE_URL,CBURM_PORT)
    r=requests.get(url, verify=False, cert=None, auth=None, headers=None)
    print("CBUR status: %s" % r.json())
  run.sh: |
    #!/bin/bash
    function check_pod {
       pod_num=$#
       err_flag1=1

       for i in `seq 1 120`
       do
         res=$(${KUBECTL} get deployment -n $NAMESPACE -l app.kubernetes.io/name={{ template "cbur.name" . }} --no-headers)
         if [[ $res ]]; then
            echo "$res"
            echo "=========================================="
            err_flag2=0
            cou_pod=0
            while read -r ready
            do
               IFS='/' read -r -a arr <<< "$ready"
               if [ ${arr[0]} -ne ${arr[1]} ]; then
                  err_flag2=1
                  break
               else
                  ((cou_pod++))
               fi
            done <<< "`echo "$res" | awk '{print $2}'`"
            if [ $err_flag2 -eq 0 ] && [ $cou_pod -eq $pod_num ]; then
               err_flag1=0
               break
            fi
         fi
         sleep 5
       done

       if [ $err_flag1 -eq 1 ]; then
           echo "$NAME is not running"
           res=$(${KUBECTL} get pod -n $NAMESPACE |grep $NAME)
           echo $res
           exit 1
       fi
    }

    function check_ready {
       err_flag=1
       for i in `seq 1 5`
       do
          #source ./set_python_env.sh
          res=$(python /tests/request.py)
          echo "$res"
          echo "$res" | grep "Ready to go"
          if [[ $? -eq "0" ]] ; then
             err_flag=0
             break
          fi
          sleep 1
       done
       if [ $err_flag -eq "1" ]; then
          echo "cburm is not ready"
          exit 1
       fi
    }
