{{- include "cbur.unifiedLoggingMerge" (tuple . "k8swatcher") }}
{{- include "cbur.unifiedLogging" (tuple . "k8swatcher") }}
{{- include "cbur.tls" . }}
{{- if .Values.k8swatcher.enabled }}
apiVersion: {{ template "cbur.DeploymentAPI" . }}
kind: Deployment
metadata:
  name: {{ include "cbur.proxy.resourceName" (tuple . "Deployment" "k8swatcher") }}
  labels:
    heritage: {{ .Release.Service }}
    app: {{ template "cbur.fullname" . }}-k8swatcher
    release: {{ .Release.Name }}
    component: "{{ .Release.Name }}-{{ .Values.component }}"
    {{- include "cbur.proxy.commonLabels" (tuple . .Values.k8swatcher.name) | indent 4 }}
    {{- include "cbur.customLabels" (tuple .Values.k8swatcher.labels .Values.global.labels) | indent 4 }}
  annotations:
    {{- include "cbur.customAnnotations" (tuple .Values.k8swatcher.annotations .Values.global.annotations) | indent 4 }}
spec:
  replicas: {{ .Values.replicas }}
  strategy:
    type: Recreate
    rollingUpdate:
  selector:
    matchLabels:
      heritage: {{ .Release.Service }}
      app: {{ template "cbur.fullname" . }}-k8swatcher
      release: {{ .Release.Name }}
      component: "{{ .Release.Name }}-{{ .Values.component }}"
  template:
    metadata:
      name: {{ include "cbur.proxy.resourceName" (tuple . "Deployment" "k8swatcher") }}
      labels:
        altiplano-role: {{ .Values.accessRoleLabel }}
        heritage: {{ .Release.Service }}
        app: {{ template "cbur.fullname" . }}-k8swatcher
        release: {{ .Release.Name }}
        component: "{{ .Release.Name }}-{{ .Values.component }}"
        {{- include "cbur.proxy.commonLabels" (tuple . .Values.k8swatcher.name) | indent 8 }}
        {{- include "cbur.customLabels" (tuple .Values.k8swatcher.labels .Values.global.labels) | indent 8 }}
      annotations:
      {{- include "cbur.customAnnotations" (tuple .Values.k8swatcher.annotations .Values.custom.pod.annotations .Values.global.annotations) | indent 8 }}
      {{- include "cbur.defaultContainer" (tuple . "k8swatcher") | indent 8 }}
      {{- include "cbur.syslogCmChecksum" (tuple . "k8swatcher") | indent 8 }}
      {{- include "cbur.certCmChecksum" . | indent 8 }}
      {{- if .Values.istio.enabled }}
        sidecar.istio.io/inject: "true"
        {{- if .Values.istio.mtls.enabled }}
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
        {{- end }}
      {{- else }}
        sidecar.istio.io/inject: "false"
      {{- end }}
      {{- if .Values.auth.enabled }}
        rollme: {{ randAlphaNum 5 | quote }}
      {{- end }}
    spec:
      {{- if .Values.rbac.enabled }}
      serviceAccountName: {{ template "cbur.fullname" . }}
      {{- else if .Values.rbac.serviceAccountName }}
      serviceAccountName: {{ .Values.rbac.serviceAccountName }}
      {{- end }}
      automountServiceAccountToken: true
{{ include "cbur.podSecurityContext" . | indent 6 }}
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName | quote }}
      {{- else if .Values.global.priorityClassName }}
      priorityClassName: {{ .Values.global.priorityClassName | quote }}
      {{- end }}
      {{- if .Values.image.master.imagePullSecrets }}
      imagePullSecrets: {{ toYaml .Values.image.master.imagePullSecrets | nindent 8 }}
      {{- else if .Values.global.imagePullSecrets }}
      imagePullSecrets: {{ toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
{{ include "cbur.syslogSidecar" (tuple . "k8swatcher") | indent 8 }}
        - name: {{ include "cbur.proxy.containerName" (tuple . "cbur") }}
          image: {{ include "cbur.image.mapper" (tuple $ .Values.image.master .Values.internalCBURMasterRegistry) }}
          imagePullPolicy: {{ .Values.image.master.pullPolicy | default "IfNotPresent" | quote }}
{{ include "cbur.containerSecurityContext" . | indent 10 }}
{{ include "cbur.readOnlyRootFilesystem" . | indent 12 }}
{{ include "cbur.containerRunAsUser" . | indent 12 }}
{{ include "cbur.containerRunAsGroup" . | indent 12 }}
          env:
          - name: APP_NAME
            value: "k8swatcher"
          - name: KUBE_VERSION
            value: {{ include "cbur.kubeVersion" . }}
          - name: LEGACY_SHORT_SVC_NAME
            {{- if .Values.tls.legacyShortSvcName }}
            value: "true"
            {{- else }}
            value: "false"
            {{- end }}
          {{- if .Values.clusterDomain }}
          - name: CLUSTER_DOMAIN
            value: {{ quote .Values.clusterDomain }}
          {{- end }}
          - name: CBURM_PORT
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
            value: "{{ .Values.tls.port }}"
          {{- else }}
            value: "{{ .Values.serverPort }}"
          {{- end }}
          - name: CBURM_NAME
            value: {{ template "cbur.fullname" . }}
          - name: CBURM_SCOPE
            value: {{ .Values.cburScope }}
          - name: CELERY_NAMESPACE
            value: "{{ .Release.Namespace }}"
          - name: INCLUDE_NAMESPACES
            value: {{ .Values.includeNamespaces | quote }}
          - name: TZ
            value: {{ .Values.global.timeZoneEnv | default "UTC" | quote }}
          {{- if .Values.rbac.enabled }}
          - name: K8S_RBAC_ENABLED
            value: "true"
          - name: SERVICE_ACCOUNT
            value: {{ template "cbur.fullname" . }}
          {{- end }}
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
          - name: HTTPS_ENABLED
            value: "YES"
          - name: CBURM_CERTS_PATH
            value: "/etc/ssl/certs/cbur"
          {{- if .Values.tls.clientSecretRef.credentialName }}
          - name: TLS_CLIENT_CA_CRT_NAME
            value: {{ .Values.tls.clientSecretRef.keyNames.caCrt | default "ca.crt" }}
          - name: TLS_CLIENT_TLS_CRT_NAME
            value: {{ .Values.tls.clientSecretRef.keyNames.tlsCrt | default "tls.crt" }}
          - name: TLS_CLIENT_TLS_KEY_NAME
            value: {{ .Values.tls.clientSecretRef.keyNames.tlsKey | default "tls.key" }}
          {{- end }}
          {{- end }}
          - name: LOGGING_FILE
            value: "/var/log/cbur/br.log"
          - name: AUDIT_LOGGING_FILE
            value: "/var/log/cbur/audit.log"
          - name: ENABLE_UNIFIED_LOGGING
          {{- if .Values.unifiedLogging.useLegacyFormat }}
            value: "false"
          {{- else }}
            value: "true"
          {{- end }}
{{- include "cbur.logging.level" . | indent 10 }}
          - name: CLUSTER_NAME
            value: {{ quote .Values.clusterName }}
          - name: CLUSTER_ID
            value: {{ quote .Values.clusterId }}
          {{- if .Values.k8swatcher.unifiedLogging.syslog }}
          - name: SYSLOG_ENABLED
            {{- if or .Values.k8swatcher.unifiedLogging.syslog.enabled (and .Values.global.unifiedLogging.syslog .Values.global.unifiedLogging.syslog.enabled) }}
            value:  "true"
            {{- else }}
            value:  "false"
            {{- end }}
          {{- end }}
          {{- if not .Values.unifiedLogging.useLegacyFormat }}
{{ include "cbur.unifiedLoggingExt" (tuple . .Values.k8swatcher.unifiedLogging.extension) | indent 10 }}
          {{- end }}
          volumeMounts:
{{ include "cbur.emptydirvolumemount" . | indent 10  }}
{{ include "cbur.k8swatcher.logvolumemount" . | indent 10  }}
          {{- if .Values.istio.enabled }}
{{ include "cbur.istiocheckvolumemount" . | indent 10  }}
          {{- end }}
          {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
          - mountPath: /etc/ssl/certs/cbur
            name: "certs"
            readOnly: true
          {{- end }}
          command:
            - "bash"
            - "-c"
            - |
            {{- if .Values.istio.enabled }}
              source ./set_python_env.sh &&
              trap "python /tmp/istio_exit.py" EXIT &&
              python /tmp/istio_ready.py &&
            {{- end }}
            {{- if or (and .Values.k8swatcher.unifiedLogging.syslog .Values.k8swatcher.unifiedLogging.syslog.enabled) (and .Values.global.unifiedLogging.syslog .Values.global.unifiedLogging.syslog.enabled) }}
              /usr/local/bin/supervisord -c /etc/supervisor/conf.d/k8swatcher.conf.syslog
            {{- else }}
              /usr/local/bin/supervisord -c /etc/supervisor/conf.d/k8swatcher.conf
            {{- end }}
          readinessProbe:
            exec:
              command:
              - sh
              - "-c"
              - |
                 ps -ef |grep start_k8swatcher.py
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 30
          resources:
{{ include "cbur.resources" (tuple . .Values.k8swatcher.resources "500m") | indent 12 }}
        - name: {{ include "cbur.proxy.containerName" (tuple . "cbur") }}-k8swatcher-fluentd-sidecar
          image: "{{ .Values.global.registry }}/{{ .Values.k8swatcher_fluentd_sidecar.image.name }}:{{ .Values.k8swatcher_fluentd_sidecar.image.tag }}"
          imagePullPolicy: {{ .Values.k8swatcher_fluentd_sidecar.image.pullPolicy }}
          securityContext:
            readOnlyRootFilesystem: true
            runAsUser: 1000
            runAsGroup: {{ .Values.securityContext.runAsGroup }}
            runAsNonRoot: {{ .Values.securityContext.runAsNonRoot }}
          resources:
{{ toYaml .Values.k8swatcher_fluentd_sidecar.resources | indent 12 }}
          env:
          {{- if .Values.k8swatcher_fluentd_sidecar.secrets }}  
          - name: IS_USERNAME
            valueFrom:
              secretKeyRef:
                key: {{ .Values.env.secrets.IS_USERNAME }}
                name: {{ .Values.k8swatcher_fluentd_sidecar.secrets.passwordSecret | quote }}
          - name: IS_PASSWORD
            valueFrom:
              secretKeyRef:
                key: {{ .Values.env.secrets.IS_PASSWORD }}
                name: {{ .Values.k8swatcher_fluentd_sidecar.secrets.passwordSecret | quote }}  
          {{- end}}
          - name: CONTAINER_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: fluentd-config
            mountPath: /etc/fluent/
          - name: certificates
            mountPath: /etc/.certificates/
          - name: tmpemptydirvolume
            mountPath: /logs
            subPath: cbur-log   
    {{- if .Values.nodeSelectorOverride }}
      nodeSelector:
{{ toYaml .Values.nodeSelectorOverride | indent 8 }}
    {{- else if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
    {{- end }}
    {{- if .Values.k8swatcher.affinity }}
      affinity:
{{ toYaml .Values.k8swatcher.affinity | indent 8 }}
    {{- else if .Values.k8swatcher.podAntiAffinity }}
      affinity:
      {{- include "cbur.proxy.podAntiAffinity" (tuple . .Values.k8swatcher) | nindent 8}}
    {{- end }}
    {{- with .Values.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.topologySpreadConstraints }}
      topologySpreadConstraints:
{{- toYaml . | nindent 8 }}
    {{- end }}
      volumes:
{{ include "cbur.syslogSidecarVolume" (tuple . "k8swatcher") | indent 8  }}
        {{- if .Values.istio.enabled }}
{{ include "cbur.istiocheckvolume" . | indent 8  }}
        {{- end }}
        - name: tmp
          emptyDir: {}
        {{- if eq (include "cbur.proxy.coalesceBoolean" (tuple .Values.tls.enabled .Values.global.tls.enabled false)) "true" }}
        {{- if .Values.tls.clientSecretRef.credentialName }}
        - name: "certs"
          secret:
            secretName: {{ .Values.tls.clientSecretRef.credentialName }}
        {{- else if .Values.tls.certsPath }}
        - name: "certs"
          hostPath:
            path: {{ .Values.tls.certsPath }}
        {{- else }}
        - name: "certs"
          secret:
            secretName: {{ template "cbur.fullname" . }}-client-srt
        {{- end  }}
        {{- end  }}
        {{- if .Values.k8swatcher_fluentd_sidecar.secrets }}
        - name: certificates
          secret:
            secretName: {{ (tpl .Values.k8swatcher_fluentd_sidecar.secrets.certSecret .) }}
        - name: passwords
          secret:
            secretName: {{ (tpl .Values.k8swatcher_fluentd_sidecar.secrets.passwordSecret .) }}
        {{- end}}
        - name: fluentd-config
          configMap:
            name: {{ include "cbur.proxy.resourceName" (tuple . "Deployment" "k8swatcher") }}-fluentd-config
        - name: logs
          emptyDir: {}
{{ include "cbur.tmpemptydirvolume" . | indent 8  }}
            sizeLimit: {{ index .Values.k8swatcher.resources.limits "ephemeral-storage" | quote }}
{{- end }}
