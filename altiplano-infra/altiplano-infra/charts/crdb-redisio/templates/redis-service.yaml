{{- include "crdb-redisio.init" . -}}
{{- $svc_val := .Values.services.redis -}}
{{- $primary_port := include "crdb-redisio.db.port" . -}}
{{- $alternate_port := include "crdb-redisio.db.alt-port" . -}}
{{- $tls_ports := without (splitList "," (toString $svc_val.tlsPort)) "0" -}}
{{- $nontls_ports := without (splitList "," (toString $svc_val.nonTlsPort)) "0" -}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ template "crdb-redisio.groupname" . }}
  labels:
    {{- include "crdb-redisio.labels" (tuple . "server" "readwrite" "service") | nindent 4 }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "server" "readwrite" "service") | nindent 4 }}
spec:
  type: {{ $svc_val.type }}
  {{- include "crdb-redisio.dual-stack" (tuple . $svc_val) | nindent 2 }}
  ports:
  {{- /* Setup Service ports for the primary port (tlsPort(s) if tls.enabled, nonTlsPort(s) otherwise) */ -}}
  {{- range $index, $port := ternary $tls_ports $nontls_ports .server_tls }}
  - name: {{ printf "tcp-redis-%s" $port }}
    appProtocol: tcp
    port: {{ $port }}
    targetPort: {{ $primary_port }}
    {{- if and (eq $svc_val.type "NodePort") (ne $svc_val.nodePort "") -}}
      {{- if gt (len (splitList "," (toString $svc_val.nodePort))) $index }}
    nodePort: {{ index (splitList "," (toString $svc_val.nodePort)) $index }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- /* Setup Service ports for the alternate port (nonTlsPort(s) if tls.enabled, nil otherwise) */ -}}
  {{- range $port := ternary $nontls_ports (list) .server_tls }}
  - name: {{ printf "tcp-redis-%s" $port }}
    appProtocol: tcp
    port: {{ $port }}
    targetPort: {{ $alternate_port }}
  {{- end }}
  selector:
    {{- include "crdb-redisio.selector_labels" . | nindent 4 }}
    type: server
    redisio_role: master
---
{{- if gt (int .Values.server.count) 1 }}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "crdb-redisio.groupname" . }}-readonly
  labels:
    {{- include "crdb-redisio.labels" (tuple . "server" "readonly" "service") | nindent 4 }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "server" "readonly" "service") | nindent 4 }}
spec:
  type: {{ $svc_val.type }}
  {{- include "crdb-redisio.dual-stack" (tuple . $svc_val) | nindent 2 }}
  ports:
  {{- /* Setup Service ports for the primary port (tlsPort(s) if tls.enabled, nonTlsPort(s) otherwise) */ -}}
  {{- range $index, $port := ternary $tls_ports $nontls_ports .server_tls }}
  - name: {{ printf "tcp-redis-%s" $port }}
    appProtocol: tcp
    port: {{ $port }}
    targetPort: {{ $primary_port }}
    {{- if and (eq $svc_val.type "NodePort") (ne $svc_val.nodePortReadOnly "") -}}
      {{- if gt (len (splitList "," (toString $svc_val.nodePortReadOnly))) $index }}
    nodePort: {{ index (splitList "," (toString $svc_val.nodePortReadOnly)) $index }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- /* Setup Service ports for the alternate port (nonTlsPort(s) if tls.enabled, nil otherwise) */ -}}
  {{- range $port := ternary $nontls_ports (list) .server_tls }}
  - name: {{ printf "tcp-redis-%s" $port }}
    appProtocol: tcp
    port: {{ $port }}
    targetPort: {{ $alternate_port }}
  {{- end }}
  selector:
    {{- include "crdb-redisio.selector_labels" . | nindent 4 }}
    type: server
    redisio_role: slave
{{- end }}
{{- if and .Values.istio.enabled .Values.istio.createDrForClient }}
{{- if semverCompare "<1.5" (toString .Values.istio.version) }}
---
apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: {{ template "crdb-redisio.groupname" . }}-mlts-authn
  labels:
    {{- include "crdb-redisio.labels" (tuple . "server" "readwrite" "readonly" "policy") | nindent 4 }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "server" "readwrite" "readonly" "policy") | nindent 4 }}
spec:
  targets:
  - name: {{ template "crdb-redisio.groupname" . }}
  - name: {{ template "crdb-redisio.groupname" . }}-readonly
  peers:
  - mtls:
      mode: {{ .Values.istio.permissive | ternary "PERMISSIVE" "STRICT" }}
{{- end }}
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ template "crdb-redisio.groupname" . }}-mlts-dr
  labels:
    {{- include "crdb-redisio.labels" (tuple . "server" "readwrite" "destinationrule") | nindent 4 }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "server" "readwrite" "destinationrule") | nindent 4 }}
spec:
  host: {{ template "crdb-redisio.groupname" . }}
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ template "crdb-redisio.groupname" . }}-readonly-mlts-dr
  labels:
    {{- include "crdb-redisio.labels" (tuple . "server" "readonly" "destinationrule") | nindent 4 }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "server" "readonly" "destinationrule") | nindent 4 }}
spec:
  host: {{ template "crdb-redisio.groupname" . }}-readonly
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
{{- end }}
