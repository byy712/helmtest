{{- include "crdb-redisio.init" . -}}

{{/*
 NOTE: v4.certificate causes breakage by changing the secretName from
       <fullname>-<workload.certificate.nameSuffix> to 
       <fullname>-<workload.nameSuffix>-<workload.certificate.nameSuffix>

       Leaving deprecated v3.certificate in place until addressed by csf-common-lib
*/}}

{{- if .server_tls -}}
  {{- range (.sentinel_tls | ternary (list .Values.server .Values.sentinel) (list .Values.server)) -}}
    {{- $_ := merge .certificate (dict "usages" (list "server auth" "client auth")) -}}
    {{- if eq (include "csf-common-lib.v1.coalesceBoolean" (tuple .certificate.enabled $.cmgr_enabled true)) "true" -}}
      {{- include "csf-common-lib.v3.certificate" (tuple $ .) }}
    {{- end -}}
  {{- end -}}
  {{- if .client_tls -}}
    {{- range $client_name, $client_workload := .Values.clients -}}
      {{- $_ := merge $client_workload.certificate (dict "usages" (list "client auth")) -}}
      {{- if eq (include "csf-common-lib.v1.coalesceBoolean" (tuple .certificate.enabled $.cmgr_enabled true)) "true" -}}
        {{- include "csf-common-lib.v3.certificate" (tuple $ $client_workload) }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
