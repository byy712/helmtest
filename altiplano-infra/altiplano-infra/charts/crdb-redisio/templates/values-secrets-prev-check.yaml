{{- include "crdb-redisio.init" . -}}
{{/*
*
* A non-manifest helper to check that the acls in redis-secrets and redis-secrets match
* A mismatch can occur if a restore is performed on a new install with different passwords
* than the old install.
*
*/}}
{{- define "crdb-redisio.secrets-prev-check" -}}
{{- if and .Release.IsUpgrade (not (.Values.server.disableAclPrevCheck)) -}}
    {{- $msg := printf "ACL mismatch between redis-secrets and redis-secrets-prev.\n" -}}
    {{- $msg = printf "\n\n\n!!! Upgrading may result in loss of database access.\n%s" $msg -}}
    {{- $prevsecretname := include "csf-common-lib.v3.resourceName" (tuple . "secret" "redis-secrets-prev") -}}
    {{- $prevsecret := (lookup "v1" "Secret" .Release.Namespace $prevsecretname) -}}
    {{- if $prevsecret -}}
        {{- $currsecretname := include "csf-common-lib.v3.resourceName" (tuple . "secret" "redis-secrets") -}}
        {{- $currsecret := (lookup "v1" "Secret" .Release.Namespace $currsecretname) -}}
        {{- $prevacl := index $prevsecret.data "acl" -}}
        {{- $curracl := index $currsecret.data "acl" -}}
        {{- if not (eq $prevacl $curracl) -}}
            {{- fail $msg -}}
        {{- end -}}
    {{- end -}}
{{- end -}}
{{- end -}}
