{{- include "crdb-redisio.init" . -}}
{{- include "crdb-redisio.values-update-acl" . -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "csf-common-lib.v3.resourceName" (tuple . "secret" "redis-secrets") }}
  labels:
    {{- include "crdb-redisio.labels" (tuple . "secret") | nindent 4 }}
    {{- if .Values.addlSecretLabels }}{{- toYaml .Values.addlSecretLabels | nindent 4 }}{{- end }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "secret") | nindent 4 }}
    "helm.sh/hook": "pre-install,pre-upgrade,pre-rollback"
    "helm.sh/hook-delete-policy": "hook-failed,before-hook-creation"
    "helm.sh/hook-weight": "-5"
    {{- if .Values.addlSecretAnnotations }}{{- toYaml .Values.addlSecretAnnotations | nindent 4 }}{{- end }}
type: Opaque
data:
  {{/* Must include this for backwards-compatibility, especially for rollback to v5.x.x */}}
  {{- if .Values.common }}{{ if .Values.common.password }}
  redis-password: {{ eq "none" .Values.common.password | ternary "" .Values.common.password | quote }}
  {{ end }}{{ end }}
  {{- include "crdb-redisio.sysuserauth.all" . | nindent 2 }}
  {{/* For render-testing only */}}
  {{- if .Values.__renderTest_aclString }}
stringData:
  acl: {{ include "crdb-redisio.acl" . | quote }}
  {{- else }}
  acl: {{ include "crdb-redisio.acl" . | b64enc }}
  {{ end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "csf-common-lib.v3.resourceName" (tuple . "secret" "auth-encrypt") }}
  labels:
    {{- include "crdb-redisio.labels" (tuple . "secret") | nindent 4 }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple . "secret") | nindent 4 }}
type: Opaque
data:
  server-key: {{ derivePassword 1 "long" (include "crdb-redisio.server.image" .) .Release.Name .Chart.Name | repeat 5 | trunc 32 | b64enc | b64enc | quote }}
  sentinel-key: {{ derivePassword 1 "long" (include "crdb-redisio.sentinel.image" .) .Release.Name .Chart.Name | repeat 5 | trunc 32 | b64enc | b64enc | quote }}

{{- $top := . -}}
{{- range $username, $def := .Values.acl -}}
{{- if hasKey $def "enabled" | ternary $def.enabled true -}}
{{/* Only include managed Secrets (non-external) */}}
{{- if empty (include "crdb-redisio.usercreds.secretexternal" (tuple $top $username)) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crdb-redisio.usercreds.secretname" (tuple $top $username) }}
  labels:
    {{- include "crdb-redisio.labels" (tuple $top "secret") | nindent 4 }}
    {{- if $top.Values.addlSecretLabels }}{{- toYaml $top.Values.addlSecretLabels | nindent 4 }}{{- end }}
  annotations:
    {{- include "crdb-redisio.annotations" (tuple $top "secret") | nindent 4 }}
    {{/* System users update during pre, after job runs to apply new pw.
         Non-system users are after post, once servers updated with new pw */}}
    {{- if has $username (values $top.Values.systemUsers) }}
    "helm.sh/hook": "pre-install,pre-upgrade,pre-rollback"
    {{- else }}
    "helm.sh/hook": "post-install,post-upgrade,post-rollback"
    {{- end }}
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": "hook-failed,before-hook-creation"
    {{- if $top.Values.addlSecretAnnotations }}{{- toYaml $top.Values.addlSecretAnnotations | nindent 4 }}{{- end }}
type: Opaque
data:
  {{ include "crdb-redisio.usercreds.creds" (tuple $top $username) | nindent 2 }}
{{ end -}}
{{- end -}}
{{- end -}}