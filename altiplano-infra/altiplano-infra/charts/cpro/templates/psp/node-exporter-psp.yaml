{{- if and (.Values.rbac.enabled) (.Values.nodeExporter.enabled) (.Values.rbac.psp.create) (.Capabilities.APIVersions.Has "policy/v1beta1/PodSecurityPolicy") }}
apiVersion: {{ template "cpro.apiVersion.podSecurityPolicy" . }}
kind: PodSecurityPolicy
metadata:
  labels:
    {{- include "cpro.app.labels.v3" ( dict "root" . "context" .Values.nodeExporter ) | nindent 4 }}
{{- include "cpro.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  name: {{ template "cpro.prometheus.nodeexporter.psporsccname" . }}
  annotations:
{{- include "cpro.labelsOrAnnotations" (tuple .Values.rbac.psp.annotations .Values.global.annotations) | indent 4}}
spec:
  allowPrivilegeEscalation: {{ .Values.nodeExporter.containerSecurityContext.allowPrivilegeEscalation }}
  allowedHostPaths:
  - pathPrefix: /proc
    readOnly: true
  - pathPrefix: /sys
    readOnly: true
  - pathPrefix: /
    readOnly: true
{{- range .Values.nodeExporter.extraHostPathMounts }}
  - pathPrefix: {{ .hostPath }}
    readOnly: {{ .readOnly }}
{{- end }}
  seLinux:
    rule: RunAsAny
  runAsUser:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  supplementalGroups:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  fsGroup:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  allowedCapabilities:
  - 'SYS_TIME'
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
    - 'hostPath'
  hostNetwork: true
  hostPID: true
  hostPorts:
  - min: 1
    max: 65535
{{- end }}

