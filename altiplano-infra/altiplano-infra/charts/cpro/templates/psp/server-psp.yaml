{{- if and (.Values.server.enabled) ($.Values.rbac.enabled) ($.Values.rbac.psp.create)  (.Capabilities.APIVersions.Has "policy/v1beta1/PodSecurityPolicy") }}
{{- if or (.Values.server.extraHostPathMounts) (and ($.istio.enabled) (not $.istio.cni.enabled)) }}
apiVersion: {{ template "cpro.apiVersion.podSecurityPolicy" $ }}
kind: PodSecurityPolicy
metadata:
  labels:
    {{- include "cpro.app.labels.v3" ( dict "root" . "context" .Values.server ) | nindent 4 }}
{{- include "cpro.labelsOrAnnotations" (tuple $.Values.global.labels) | indent 4}}
  name: {{ template "cpro.prometheus.server.psporsccname" $ }}
  annotations:
{{- include "cpro.labelsOrAnnotations" (tuple $.Values.rbac.psp.annotations $.Values.global.annotations) | indent 4}}
spec:
  allowPrivilegeEscalation: true
{{- if $.Values.server.extraHostPathMounts }}
  allowedHostPaths:
{{- range $.Values.server.extraHostPathMounts }}
  - pathPrefix: {{ .hostPath }}
    readOnly: {{ .readOnly }}
{{- end }}
{{- end }}
  seLinux:
    rule: RunAsAny
  runAsUser:
    ranges:
    - max: 65534
      min: 1
    rule: MustRunAs
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    ranges:
    - max: 65534
      min: 1
    rule: MustRunAs
{{- if and ($.istio.enabled) (not $.istio.cni.enabled) }}
  allowedCapabilities:
  - 'NET_ADMIN'
  - 'NET_RAW'
{{- end }}
  volumes:
  - '*'
{{- end }}
{{- end }}
