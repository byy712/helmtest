{{- $webhooksyslogEnabled := eq (include "csf-common-lib.v1.coalesceBoolean" (tuple .Values.webhook4fluentd.unifiedLogging.syslog.enabled .Values.global.unifiedLogging.syslog.enabled false )) "true" }}
{{- if and .Values.webhook4fluentd.enabled (or $webhooksyslogEnabled .Values.webhook4fluentd.unifiedLogging.extension .Values.global.unifiedLogging.extension) }}
{{- include "cpro-common-lib.v1.syslog" ( dict "root" . "context" .Values.webhook4fluentd) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cpro-common-lib-v1.ConfigmapName" (dict "name" "webhookfluentdcm" "root" .) }}
  labels:
    {{- include "cpro.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  annotations:
{{- include "cpro.labelsOrAnnotations" (tuple .Values.global.annotations) | indent 4}}
data:
  fluentd.conf: |
    <system>
      <log>
        format json
        time_format %Y-%m-%dT%H:%M:%S%z
      </log>
    </system>
    <source>
      @type tail
      path /var/log/webhook4fluentd/*.log
      pos_file /var/log/webhook4fluentd/fluent-webhook.pos
      read_from_head true
      tag webhook4fluentd-main-container
      <parse>
        @type none
      </parse>
    </source>
    <match webhook4fluentd-main-container>
     @type rewrite_tag_filter
    <rule>
      key message
      pattern ^\{.+\}$
      tag ${tag}.json
    </rule>
    <rule>
      key message
      pattern /ts=(?<time>.+) (.*) level=(?<level>[A-Za-z]+) msg="(?<msg>.+)"/
      tag ${tag}.log.B
    </rule>
    <rule>
      key message
      pattern /^(?<loglevel>[A-Z])(?<time>[0-9]+ [^ ]+)([ ]+)([0-9]+) ([^ ]+)([ ]+)((?<msg>[^\{].+))/
      tag ${tag}.log.A
    </rule>
    <rule>
      key message
      pattern .+
      tag ${tag}.log.none
    </rule>
    </match>

    <filter webhook4fluentd-main-container.json>
      @type parser
      key_name message
      <parse>
        @type json
      </parse>
    </filter>

    <filter webhook4fluentd-main-container.log.A>
      @type parser
      key_name message
      <parse>
        @type regexp
        expression /^(?<loglevel>[A-Z])(?<time>[0-9]+ [^ ]+)([ ]+)([0-9]+) ([^ ]+)([ ]+)((?<msg>[^\{].+))/
      </parse>
    </filter>

    <filter webhook4fluentd-main-container.log.A>
      @type record_modifier
      <record>
        level ${if record["loglevel"] == "E"; record["loglevel"] = "ERROR";elsif record["loglevel"] == "A"; record["loglevel"] = "ALERT"; elsif record["loglevel"] == "I"; record["loglevel"] = "INFO"; elsif record["loglevel"] == "W"; record["loglevel"] = "WARN"; elsif record["loglevel"] == "F"; record["loglevel"] = "FATAL"; end;}
      </record>
      remove_keys loglevel,$.extension.loglevel
    </filter>

    <filter webhook4fluentd-main-container.log.B>
      @type parser
      key_name message
      <parse>
        @type regexp
        expression /ts=(?<time>.+) (.*) level=(?<level>[A-Za-z]+) msg="(?<msg>.+)"/
      </parse>
    </filter>

    <filter webhook4fluentd-main-container.log.*>
    @type record_modifier
    <record>
      type log
      log ${ { message: record.has_key?("msg") ? record["msg"]:record["message"]  }}
    </record>
    remove_keys msg,message,$extension.msg,$.extension.message
    </filter>

    <filter webhook4fluentd-main-container.**>
      @type record_transformer
      enable_ruby true
      <record>
        level ${record.has_key?("level") ? record["level"]:"NOTICE" }
        system ${ ENV["SYSTEM"] }
        systemid ${ ENV["SYSTEMID"] }
        host ${ ENV["PODNAME"]}.${ ENV["RELEASE_NAMESPACE"] || '' }
        timezone ${ ENV["TZ"] }
        time ${record.has_key?("time") ? record["time"]: time.strftime('%Y-%m-%dT%H:%M:%S%z') }
        extension ${require 'json';record.merge(JSON.parse(ENV["EXTENSION_FIELDS"]))}
      </record>
      remove_keys $.extension.@time,$.extension.type,$.extension.level,$.extension.message,$.extension.extension,$.message,$.extension.log
    </filter >
    <match webhook4fluentd-main-container.** >
      @type rewrite_tag_filter
      <rule>
        key level
        pattern (?i)alert
        tag alert.${tag}
      </rule>
      <rule>
        key level
        pattern .+
        tag notice.${tag}
      </rule>
    </match>
    <match notice.** alert.** >
        @type copy
        <store>
          @type stdout
          <format>
            @type json
          </format>
        </store>
        {{- if $webhooksyslogEnabled }}
        <store>
          @type remote_syslog
          host {{ tpl $.syslog.host . }}
          port {{ tpl ($.syslog.port | quote) . }}
          {{- if or (eq (tpl $.syslog.protocol . | lower) "tcp") (eq (tpl $.syslog.protocol . | lower) "ssl") }}
          protocol tcp
          {{- else }}
          protocol udp
          {{- end }}
          {{- if tpl (default "" $.syslog.facility) . }}
          facility {{ tpl $.syslog.facility . | lower }}
          {{- end }}
          severity ${tag[0]}
          <format>
            @type json
          </format>
        {{- if and (tpl (default "" $.syslog.tls.secretRef.name) .) (tpl (default "" $.syslog.tls.secretRef.keyNames.caCrt) .) }}
          tls true
          ca_file /etc/fluent/certs/syslogRootCaPem
          {{- end }}
          <buffer tag>
          </buffer>
        </store>
        {{- end }}
    </match>
{{- end }}

