{{- include "cpro.istio.cproInitIstio" . }}
{{- if and ($.istio.enabled) (not $.istio.cni.enabled) (.Values.rbac.enabled) (.Values.kubeStateMetrics.enabled) (.Values.rbac.psp.create) (.Capabilities.APIVersions.Has "policy/v1beta1/PodSecurityPolicy") }}
apiVersion: {{ template "cpro.apiVersion.podSecurityPolicy" . }}
kind: PodSecurityPolicy
metadata:
  labels:
    {{- include "cpro.app.labels.v3" ( dict "root" . "context" .Values.kubeStateMetrics ) | nindent 4 }}
{{- include "cpro.labelsOrAnnotations" (tuple .Values.global.labels) | indent 4}}
  name: {{ template "cpro.prometheus.kubeStateMetrics.psp" . }}
  annotations:
{{- include "cpro.labelsOrAnnotations" (tuple .Values.rbac.psp.annotations .Values.global.annotations) | indent 4}}
spec:
  allowPrivilegeEscalation: true
  seLinux:
    rule: RunAsAny
  runAsUser:
    ranges:
    - max: 65534
      min: 1
    rule: MustRunAs
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    ranges:
    - max: 65534
      min: 1
    rule: MustRunAs
  allowedCapabilities:
  - 'NET_ADMIN'
  - 'NET_RAW'
  volumes:
  - '*'
{{- end }}
