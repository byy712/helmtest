{{- if .Values.ingress.enabled -}}
{{- $name := include "altiplano-oauth2-proxy.name" . -}}
{{- $ingressPath := .Values.ingress.path -}}
{{- $ingressLimitRps := "1000" -}}
{{- if .Values.env.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.env.INGRESS_LIMIT_RPS -}}
{{- else if .Values.global.INGRESS_LIMIT_RPS }}
{{- $ingressLimitRps = .Values.global.INGRESS_LIMIT_RPS -}}
{{- end }}
{{- $ingressLimitBurstMultiplier := "5" -}}
{{- if .Values.env.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.env.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- else if .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER }}
{{- $ingressLimitBurstMultiplier = .Values.global.INGRESS_LIMIT_BURST_MULTIPLIER -}}
{{- end }}
{{- $ingressControllerType := .Values.global.INGRESS_CONTROLLER_TYPE }}
{{- $gitVersion := .Capabilities.KubeVersion.GitVersion }}
{{- if semverCompare "<1.19.0-0" $gitVersion }}
apiVersion: networking.k8s.io/v1beta1
{{- else }}
apiVersion: networking.k8s.io/v1
{{- end }}
kind: Ingress
metadata:
  name: {{ template "altiplano-oauth2-proxy.fullname" . }}
  labels:
    app: {{ $name }}
    chart: {{ template "altiplano-oauth2-proxy.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
  {{- if eq $ingressControllerType "kubernetes" }}
{{- with .Values.ingress.annotations }}
{{ toYaml . | indent 4 }}
{{- end }}
    nginx.ingress.kubernetes.io/proxy-buffer-size: 128k
    nginx.ingress.kubernetes.io/limit-rps: "{{ $ingressLimitRps }}"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "{{ $ingressLimitBurstMultiplier }}"
  {{- else }}
{{- with .Values.nginxIncIngress.annotations }}
{{ toYaml . | indent 4 }}
{{- end }}
    nginx.org/location-snippets: |
      proxy_set_header X-Forwarded-Prefix         /oauth2;
      rewrite ^(/oauth2)$ $1/ permanent;
      rewrite ^(/oauth2/callback($|/))$  /oauth2/ permanent;
      rewrite "(?i)/oauth2(/|$)(.*)" /$2 break;
      return 400;
  {{- end }}
spec:
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- if .Values.ingress.hosts }}
    {{- range $host := .Values.ingress.hosts }}
    - host: {{ $host }}
      http:
        paths:
        {{- if $ingressPath }}
        - path: {{ $ingressPath }}
        {{- else }}
        - path: /{{ $name }}
        {{- end }}
          backend:
            {{- if semverCompare "<1.19.0-0" $gitVersion }}
            serviceName: {{ $name }}
            servicePort: oauthproxyport
            {{- else }}
            service:
              name: {{ $name }}
              port:
                name: oauthproxyport
          pathType: ImplementationSpecific
            {{- end }}
      {{- end -}}
      {{- else }}
    - http:
        paths:
        {{- if $ingressPath }}
        - path: {{ $ingressPath }}
        {{- else }}
        - path: /{{ $name }}
        {{- end }}
          backend:
            {{- if semverCompare "<1.19.0-0" $gitVersion }}
            serviceName: {{ $name }}
            servicePort: oauthproxyport
            {{- else }}
            service:
              name: {{ $name }}
              port:
                name: oauthproxyport
          pathType: ImplementationSpecific
          {{- end }}
  {{- end }}
{{- end }}
