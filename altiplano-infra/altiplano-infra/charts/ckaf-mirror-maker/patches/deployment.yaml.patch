--- ckaf-mirror-maker-5.1.0/ckaf-mirror-maker/templates/deployment.yaml	2024-03-28 23:41:14.000000000 +0530
+++ ckaf-mirror-maker-5.1.0-nokia-patch-6/ckaf-mirror-maker/templates/deployment.yaml	2024-06-24 15:42:32.927201193 +0530
@@ -15,10 +15,7 @@
 spec:
   replicas: {{ .Values.replicaCount }}
   strategy:
-    rollingUpdate:
-      maxSurge: {{ .Values.RollingUpdate.MaxSurge }}
-      maxUnavailable: {{ .Values.RollingUpdate.MaxUnavailable }}
-    type: RollingUpdate
+{{ toYaml .Values.strategy | indent 4 }}
   selector:
     matchLabels:
       release: {{ .Release.Name }}
@@ -26,6 +23,7 @@
   template:
     metadata:
       labels:
+        altiplano-role: {{ .Values.accessRoleLabel }}
 {{- include "csf-common-lib.v1.customLabels" (tuple .Values.mmPodLevel.labels .Values.custom.mmPodLevel.labels .Values.global.labels) | indent 8 }}
 {{ include "ckaf-mirror-maker.commonLabels" . | indent 8 }}
         app: {{ .Chart.Name }}
@@ -73,15 +71,255 @@
         - name: {{ . }}
       {{- end }}
       {{- end }}
-      {{- if .Values.global.istio.enabled }}
       automountServiceAccountToken: true
-      {{- else }}
-      automountServiceAccountToken: false
-      {{- end }}
       {{- if .Values.topologySpreadConstraints }}
       topologySpreadConstraints: {{- include "csf-common-lib.v2.topologySpreadConstraints" (tuple . .Values ) | nindent 8 }}
       {{- end }}
       initContainers:
+      - name: init-swo-container-{{ .Chart.Name }}
+        {{- if eq .Values.global.flatRegistry true }}
+        image: "{{ .Values.global.registry }}/{{ .Values.kubectlImageName }}:{{ .Values.kubectlTag }}"
+        {{- else }}
+        image: "{{ coalesce .Values.global.registry1 .Values.global.registry }}/{{ include "ckaf-mirror-maker.kubectlImageRepo" . }}:{{ .Values.kubectlTag }}"
+        {{- end }}
+        command: [ "/bin/sh", "-c" ]
+        securityContext:
+          runAsNonRoot: {{ .Values.initContainer.securityContext.runAsNonRoot | default true }}
+          runAsUser: {{ .Values.initContainer.securityContext.runAsUser | default 1000 }}
+          runAsGroup: {{ .Values.initContainer.securityContext.runAsGroup | default 1000 }}
+        args:
+          - |
+              beforeGeoSite=$(cat /etc/kafka/geo-site/beforeGeoSite)
+              currentGeoSite=$(cat /etc/kafka/geo-site/currentGeoSite)
+              echo "beforeGeoSite:" $beforeGeoSite
+              echo "currentGeoSite:" $currentGeoSite
+              if [ -n "$beforeGeoSite" ] && [ "$currentGeoSite" != "$beforeGeoSite" ] && [ "$currentGeoSite" == "true" ]
+              then
+                totalPair=$(env | grep MIRROR_MAKER_PAIR | wc -l)
+                for ((i=0; i<$totalPair; i++)); do
+                  purgeKafkaTopic=PURGE_KAFKA_TOPIC_"$i"
+                  if [ ${!purgeKafkaTopic} == "true" ]
+                  then
+                    kafkaTopicPair=MIRROR_MAKER_PAIR_"$i"
+                    siteName=$(echo ${!kafkaTopicPair} | awk -F',' '{print $1}' | tr '[:lower:]' '[:upper:]')
+                    bootstrapServerName=MIRROR_MAKER_"$siteName"_BOOTSTRAP_SERVERS
+                    bootstrapServer=$(echo ${!bootstrapServerName})
+                    /etc/kafka/scripts/purge-kafka-topics.sh {{ .Release.Namespace }} $bootstrapServer
+                  fi
+                done
+              fi
+        env:
+        {{- range $index, $mirror := .Values.mirrorMakerConfig.mirrors }}
+          {{- $srcCluster := .sourceCluster }}
+          {{- $targetCluster := .targetCluster }}
+          {{- if ne $srcCluster "" }}
+        - name: {{ printf "MIRROR_MAKER_PAIR_%d" $index }}
+          value: {{ printf "%s,%s" $srcCluster $targetCluster }}
+          {{- end  }}
+          {{- $purgeKafkaTopic := index $mirror "purgeKafkaTopic" }}
+            {{- if (not $purgeKafkaTopic) }}
+        - name: {{ printf "PURGE_KAFKA_TOPIC_%d" $index }}
+          value: "false"
+            {{- else }}
+              {{- if ne $purgeKafkaTopic "" }}
+        - name: {{ printf "PURGE_KAFKA_TOPIC_%d" $index }}
+          value: {{ $purgeKafkaTopic | quote }}
+              {{- else }}
+        - name: {{ printf "PURGE_KAFKA_TOPIC_%d" $index }}
+          value: "false"
+              {{- end }}
+            {{- end }}
+        {{- end }}
+        {{- range $cluster := .Values.mirrorMakerConfig.clusters }}
+          {{- $alias := .alias }}
+          {{- range $clusterKey, $clusterValue := $cluster }}
+            {{- if eq $clusterKey "bootstrap.servers" }}
+        - name: {{ printf "MIRROR_MAKER_%s_BOOTSTRAP_SERVERS" $alias | upper  }}
+          value: {{ $clusterValue | quote }}
+            {{- end  }}
+          {{- end  }}
+        {{- end  }}
+        volumeMounts:
+        {{- if .Release.IsUpgrade }}
+        - name: scripts
+          mountPath: /etc/kafka/scripts/
+        - name: geo-site
+          mountPath: /etc/kafka/geo-site/
+        {{- end }}
+      - name: fnms-init-container-{{ .Chart.Name }}
+        image: {{ .Values.global.registry }}/{{ .Values.initContainer.image.name }}:{{ .Values.initContainer.image.tag }}
+        env:
+          - name: keystore_jks_pass
+            valueFrom:
+              secretKeyRef:
+                name: {{ .Values.certificates.secrets.altiplano_keystore_secrets }}
+                key: {{ .Values.certificates.fileNames.altiplano_keystore_password }}
+          - name: keyfile
+            value: /etc/altiplano/certificates/secrets/{{ .Values.certificates.fileNames.kafka_server_key_pem }}
+          - name: keyfilepass
+            value: /etc/altiplano/certificates/secrets/{{ .Values.certificates.fileNames.kafka_server_key_pass }}
+          - name: certfile
+            value: /etc/altiplano/certificates/secrets/{{ .Values.certificates.fileNames.kafka_server_cert_pem }}
+          - name: keystore_jks
+            value: /etc/kafka/secrets/ssl/..data/{{ .Values.certificates.fileNames.kafka_server_keystore_jks }}
+          - name: truststore
+            value: /etc/altiplano/certificates/secrets/{{ .Values.certificates.fileNames.kafka_server_trustchain_cert_pem }}
+          - name: truststore_jks
+            value: /etc/kafka/secrets/ssl/..data/{{ .Values.certificates.fileNames.kafka_server_truststore_jks }}
+          - name: keystorepasswordfile
+            value: {{ .Values.certificates.fileNames.altiplano_keystore_password }}
+        command: [ "/bin/sh", "-c" ]
+        securityContext:
+          runAsNonRoot: {{ .Values.initContainer.securityContext.runAsNonRoot | default true }}
+          runAsUser: {{ .Values.initContainer.securityContext.runAsUser | default 1000 }}
+          runAsGroup: {{ .Values.initContainer.securityContext.runAsGroup | default 1000 }}
+        args:
+          - |
+            /opt/init-container/pem-to-keystore.sh $keyfile $keyfilepass $certfile $keystore_jks_pass $keystore_jks $truststore $keystore_jks_pass $truststore_jks
+            cp /etc/altiplano/certificates/storepass/{{ .Values.certificates.fileNames.altiplano_keystore_password }} /etc/kafka/secrets/ssl/..data/
+        {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
+        {{- $alias := .alias }}
+        {{- with .ssl }}
+        {{- if eq .enabled true }}
+            cp /etc/kafka/secrets/ssl/..data/{{ .certificates.fileNames.kafka_server_keystore_jks }} /etc/mirror-maker/secrets/ssl/{{$alias}}/{{$alias}}_keystore
+            cp /etc/kafka/secrets/ssl/..data/{{ .certificates.fileNames.kafka_server_truststore_jks }} /etc/mirror-maker/secrets/ssl/{{$alias}}/{{$alias}}_truststore
+            cp /etc/kafka/secrets/ssl/..data/{{ .certificates.fileNames.altiplano_keystore_password }} /etc/mirror-maker/secrets/ssl/{{$alias}}/.{{$alias}}_keyStoreCred
+            cp /etc/kafka/secrets/ssl/..data/{{ .certificates.fileNames.altiplano_keystore_password }} /etc/mirror-maker/secrets/ssl/{{$alias}}/.{{$alias}}_trustStoreCred
+            cp /etc/kafka/secrets/ssl/..data/{{ .certificates.fileNames.altiplano_keystore_password }} /etc/mirror-maker/secrets/ssl/{{$alias}}/.{{$alias}}_keyCred
+        {{- end }}
+        {{- end }}
+        {{- end }}
+        volumeMounts:
+        {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
+        {{- $alias := .alias }}
+        {{- with .ssl }}
+        {{- if eq .enabled true }}
+        - name: {{ printf "mirror-maker-certs-%s" $alias }}
+          mountPath: {{ printf "/etc/mirror-maker/secrets/ssl/%s" $alias | quote }}
+        {{- end }}
+        {{- end }}
+        {{- end }}
+        - name: ssl
+          mountPath: /etc/kafka/secrets/ssl/
+        - name: ssl-data
+          mountPath: /etc/kafka/secrets/ssl/..data/
+        - name: altiplano-kafka-certs
+          mountPath: /etc/altiplano/certificates/secrets/
+        - name: altiplano-keystore-password
+          mountPath: /etc/altiplano/certificates/storepass/
+      - name: init-{{ .Chart.Name }}
+        image: {{ .Values.global.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
+        imagePullPolicy: "{{ .Values.init.pullPolicy }}"
+        command: ["sh","-c","until [ $ALTIPLANO_GEO_ACTIVE_SITE == true ]; do echo waiting for ALTIPLANO_GEO_ACTIVE_SITE to be true; sleep 10; done ; ./bin/initMirrorMaker.sh;"]
+        {{- if eq .Values.security.enabled true }}
+        securityContext:
+        {{- if ( ne ( toString ( .Values.security.runAsUser )) "auto" ) }}
+          runAsUser: {{ .Values.security.runAsUser }}
+          {{- if .Values.security.runAsGroup }}
+          runAsGroup: {{ .Values.security.runAsGroup }}
+          {{- end }}
+        {{- end }}
+          allowPrivilegeEscalation: false
+          readOnlyRootFilesystem: {{ .Values.security.readOnlyRootFilesystem | default true }}
+          privileged: false
+          capabilities:
+             drop:
+               - all
+          {{- end }}
+        resources:
+{{ toYaml .Values.initContainerResources | indent 10 }}
+        volumeMounts:
+        - name: init-tmp
+          mountPath: /etc/kafka/sites-config
+        - name: ssl-data
+          mountPath: /etc/kafka/secrets/ssl/..data/
+        {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
+        {{- $alias := .alias }}
+        {{- with .ssl }}
+        {{- if eq .enabled true }}
+        - name: {{ printf "mirror-maker-certs-%s" $alias }}
+          mountPath: {{ printf "/etc/mirror-maker/secrets/ssl/%s" $alias | quote }}
+        {{- end }}
+        {{- end }}
+        {{- end }}
+    {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
+      {{- $alias := .alias }}
+      {{- with .saslKrb }}
+      {{- if eq .enabled true }}
+        - name: {{ printf "mirror-maker-sasl-krb-%s" $alias }}
+          mountPath: {{ printf "/etc/mirror-maker/secrets/sasl/%s" $alias | quote }}
+      {{- end }}
+      {{- end }}
+      {{- end }}
+        {{- if and (.Values.mirrorMakerConfig.krbConfigmapName) (.Values.mirrorMakerConfig.KrbConfKeyName) }}
+        - name: mirror-maker-sasl-krb5-conf
+          mountPath: "/etc/mirror-maker/krbConf"
+        {{- end }}
+        env:
+        {{- range $index,$mirror := .Values.mirrorMakerConfig.mirrors }}
+          {{- $srcCluster := .sourceCluster }}
+          {{- $targetCluster := .targetCluster }}
+          {{- if ne $srcCluster "" }}
+        - name: {{ printf "MIRROR_MAKER_PAIR_%d" $index }}
+          value: {{ printf "%s,%s" $srcCluster $targetCluster }}
+          {{- end  }}
+          {{- range $mirrorKey, $mirrorValue := $mirror }}
+          {{- if or (eq $mirrorKey "sourceConnector") }}
+          {{- range $configKey, $configValue := $mirrorValue.config }}
+            {{- if or (eq $configKey "replication.policy.class") }}
+        - name: {{ printf "MIRROR_MAKER_PAIR_%d_REPLICATION_POLICY" $index  }}
+          value: {{ $configValue | quote }}
+            {{- end  }}
+          {{- end  }}
+          {{- end  }}
+          {{- end  }}
+          {{- end  }}
+        - name: ALTIPLANO_GEO_ACTIVE_SITE
+          value: {{ .Values.global.ALTIPLANO_GEO_ACTIVE_SITE | quote  }}
+        {{- range $cluster := .Values.mirrorMakerConfig.clusters }}
+        {{- $alias := .alias }}
+        {{- range $clusterKey, $clusterValue := $cluster }}
+        {{- if or (eq $clusterKey "bootstrap.servers") (eq $clusterKey "security.protocol") }}
+        - name: {{ printf "MIRROR_MAKER_%s_%s" $alias $clusterKey | replace "." "_" | upper  }}
+          value: {{ $clusterValue | quote }}
+        {{- end  }}
+        {{- end  }}
+        {{- end  }}
+        - name: MIRROR_MAKER_CLUSTERS
+          value: {{ .Values.mirrorMakerConfig.mmClusters }}
+      {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
+      {{- $alias := .alias }}
+      {{- with .ssl }}
+      {{- if eq .enabled true }}
+        - name: {{ printf "KAFKA_SSL_%s_TRUSTSTORE_CREDENTIALS" $alias | upper }}
+          valueFrom:
+            secretKeyRef:
+              name: {{ .certificates.altiplano_keystore_secrets }}
+              key: {{ .certificates.altiplano_keystore_password }}
+        - name: {{ printf "KAFKA_SSL_%s_KEYSTORE_CREDENTIALS" $alias | upper }}
+          valueFrom:
+            secretKeyRef:
+              name: {{ .certificates.altiplano_keystore_secrets }}
+              key: {{ .certificates.altiplano_keystore_password }}
+      {{- end }}
+      {{- end }}
+      {{- end }}
+        {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
+        {{- $alias := .alias }}
+        {{- with .saslKrb }}
+        {{- if eq .enabled true }}
+        - name: {{ printf "MIRROR_MAKER_%s_PRINCIPAL_NAME" $alias | upper }}
+          valueFrom:
+            secretKeyRef:
+              name: {{ .krbSecretName }}
+              key: {{ .krbPrincipalKey }}
+        - name: {{ printf "MIRROR_MAKER_%s_KEYTAB_NAME" $alias | upper }}
+          value: {{ .krbKeytabKey }}
+        - name: {{ printf "MIRROR_MAKER_%s_SASL_JAAS_CONFIG" $alias | upper }}
+          value: {{ printf "com.sun.security.auth.module.Krb5LoginModule required useKeyTab=true storeKey=true serviceName=kafka keyTab=\"/etc/mirror-maker/secrets/sasl/%s/$(%s)\" principal=\"$(%s)\";" $alias (printf "MIRROR_MAKER_%s_KEYTAB_NAME" $alias | upper ) (printf "MIRROR_MAKER_%s_PRINCIPAL_NAME" $alias | upper )  | quote }}
+        {{- end }}
+        {{- end }}
+        {{- end }}
       - name: init
         image: {{ include "ckaf-mirror-maker.image" (tuple .Values .Values.global.registry5 .Values.init.imageName .Values.init.imageRepo .Values.init.imageTag .Values.init) }}
         command: ["sh","-c","/etc/kafka/encrypt.sh"]
@@ -109,10 +347,12 @@
         resources:
 {{- include "ckaf-mirror-maker.getResources" (tuple . .Values.initContainerResources "200m") | indent 10 }}
         volumeMounts:
+        - name: ssl-data
+          mountPath: /etc/kafka/secrets/ssl/..data/
         {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
         {{- $alias := .alias }}
         {{- if eq (include "ckaf-mirror-maker.cluster.tls.enabled" (tuple $clusters)) "true" }}
-        - name: {{ printf "mirror-maker-ssl-%s" $alias }}
+        - name: {{ printf "mirror-maker-certs-%s" $alias }}
           mountPath: {{ printf "/etc/mirror-maker/secrets/ssl/%s" $alias | quote }}
         {{- end }}
         {{- with .saslPlain }}
@@ -417,40 +657,75 @@
             - name: mirrormaker-jmx-exporter-volume
               mountPath: /jmx-exporter
         {{- end }}
+        - name: {{ .Chart.Name }}-fluentd-sidecar
+          image: {{ .Values.global.registry }}/{{ .Values.fluentd_sidecar.image.name }}:{{ .Values.fluentd_sidecar.image.tag }}
+          imagePullPolicy: {{ .Values.fluentd_sidecar.image.pullPolicy }}
+          securityContext:
+            readOnlyRootFilesystem: {{ .Values.fluentd_sidecar.securityContext.readOnlyRootFilesystem | default true }}
+            runAsUser: {{ .Values.fluentd_sidecar.securityContext.runAsUser | default 1000 }}
+            runAsGroup: {{ .Values.fluentd_sidecar.securityContext.runAsGroup | default 998 }}
+          volumeMounts:
+          - name: tmp
+            mountPath: /tmp
+          - name: fluentd-config
+            mountPath: /etc/fluent/
+          - name: certificates
+            mountPath: "/etc/.certificates/"
+          - name: log4j-dir
+            mountPath: /logs
+          resources:
+{{ toYaml .Values.fluentd_sidecar.resources | indent 12 }}
+          env:
+          {{- if .Values.fluentd_sidecar.secrets }}
+          - name: IS_USERNAME
+            valueFrom:
+              secretKeyRef:
+                key: {{ .Values.env.secrets.IS_USERNAME }}
+                name: {{ .Values.fluentd_sidecar.secrets.passwordSecret | quote }}
+          - name: IS_PASSWORD
+            valueFrom:
+              secretKeyRef:
+                key: {{ .Values.env.secrets.IS_PASSWORD }}
+                name: {{ .Values.fluentd_sidecar.secrets.passwordSecret | quote }}
+          {{- end }}
+          - name: CONTAINER_NAME
+            valueFrom:
+              fieldRef:
+                apiVersion: v1
+                fieldPath: metadata.name
+          - name: MY_POD_IP
+            valueFrom:
+              fieldRef:
+                fieldPath: status.podIP
       volumes:
+        - name: init-tmp
+          emptyDir: {}
         - name: mirrormaker-jmx-config-volume
           configMap:
             name: {{ template "ckaf-mirror-maker.name" . }}
         - name: mirrormaker-jmx-exporter-volume
           emptyDir: {}
-
+        - name: tmp
+          emptyDir: {}
       {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
       {{- $alias := .alias }}
       {{- $ssl := .ssl }}
       {{- $tls := .tls }}
       {{- if eq (include "ckaf-mirror-maker.cluster.tls.enabled" (tuple $clusters)) "true" }}
-        - name: {{ printf "mirror-maker-ssl-%s" $alias }}
-          projected:
-            sources:
-              - secret:
-                  name: {{ include "ckaf-mirror-maker.tls.secretName" (tuple $ (coalesce $ssl.secret_name $tls.secretRef.name)  $.Values.mirrorMakerConfig ) }}
-                  items:
-                    - key: {{ include "ckaf-mirror-maker.tls.keystore" (tuple $ (coalesce $ssl.keystore_key $tls.secretRef.keyNames.keystore_key) $.Values.mirrorMakerConfig.certificate ) }}
-                      path: {{ printf "%s_keystore" $alias }}
-                    - key: {{ include "ckaf-mirror-maker.tls.trustore" (tuple $ (coalesce $ssl.truststore_key $tls.secretRef.keyNames.truststore_key) $.Values.mirrorMakerConfig.certificate ) }}
-                      path: {{ printf "%s_truststore" $alias }}
-              - secret:
-                  name: {{ include "ckaf-mirror-maker.tls.store.secretName" (tuple $ (coalesce $ssl.secret_name $tls.secretRef.name)  $.Values.mirrorMakerConfig.certificate ) }}
-                  items:
-                    - key: {{ include "ckaf-mirror-maker.tls.keystore.password" (tuple $ (coalesce $ssl.keystore_passwd_key $tls.secretRef.keyNames.keystore_passwd_key)  $.Values.mirrorMakerConfig.certificate ) }}
-                      path: {{ printf ".%s_keyStoreCred" $alias }}
-                    - key: {{ include "ckaf-mirror-maker.tls.key.password" (tuple $ (coalesce $ssl.keystore_key_passwd_key $tls.secretRef.keyNames.keystore_key_passwd_key) $.Values.mirrorMakerConfig.certificate )}}
-                      path: {{ printf ".%s_keyCred" $alias }}
-                    - key: {{ include "ckaf-mirror-maker.tls.truststore.password" (tuple $ (coalesce $ssl.truststore_passwd_key $tls.secretRef.keyNames.truststore_passwd_key) $.Values.mirrorMakerConfig.certificate )}}
-                      path: {{ printf ".%s_trustStoreCred" $alias }}
-      {{- end }}
-      {{- end }}
-
+        - name: {{ printf "mirror-maker-certs-%s" $alias }}
+          emptyDir: {}
+        {{- end }}
+        {{- end }}
+        - name: ssl
+          emptyDir: {}
+        - name: ssl-data
+          emptyDir: {}
+        - name: altiplano-kafka-certs
+          secret:
+            secretName: {{ .Values.certificates.secrets.altiplano_kafka_certificate_secrets }}
+        - name: altiplano-keystore-password
+          secret:
+            secretName: {{ .Values.certificates.secrets.altiplano_keystore_secrets }}
       {{- range $clusters := .Values.mirrorMakerConfig.clusters }}
       {{- $alias := .alias }}
       {{- with .saslKrb }}
@@ -480,7 +755,19 @@
       {{- end }}
       {{- end }}
       {{- end }}
-
+        - name: logs
+          emptyDir: {}
+        - name: fluentd-config
+          configMap:
+            name: {{ template "ckaf-mirror-maker.name" . }}-fluentd-config
+        {{- if .Values.fluentd_sidecar.secrets }}
+        - name: certificates
+          secret:
+            secretName: {{ (tpl .Values.fluentd_sidecar.secrets.certSecret .) }}
+        - name: passwords
+          secret:
+            secretName: {{ (tpl .Values.fluentd_sidecar.secrets.passwordSecret .) }}
+        {{- end }}
       {{- if and (.Values.mirrorMakerConfig.krbConfigmapName) (.Values.mirrorMakerConfig.KrbConfKeyName) }}
         - name: mirror-maker-sasl-krb5-conf      
           configMap:
@@ -489,6 +776,15 @@
             - key: {{ .Values.mirrorMakerConfig.KrbConfKeyName }}
               path: krb5.conf
       {{- end }}
+      {{- if .Release.IsUpgrade }}
+        - name: geo-site
+          configMap:
+            name: {{ .Release.Name }}-altiplano-geo-site
+        - name: scripts
+          configMap: 
+            name: mirror-maker-scripts
+            defaultMode: 0755
+      {{- end }}
         - name: shared
           emptyDir: {} 
         - name: mm-dir
