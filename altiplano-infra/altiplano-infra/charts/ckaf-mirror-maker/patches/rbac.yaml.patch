--- ckaf-mirror-maker-5.1.0/ckaf-mirror-maker/templates/rbac.yaml	2024-03-28 23:41:14.000000000 +0530
+++ ckaf-mirror-maker-5.1.0-nokia-patch-7/ckaf-mirror-maker/templates/rbac.yaml	2024-06-24 15:09:38.879980846 +0530
@@ -2,7 +2,7 @@
 apiVersion: v1
 kind: ServiceAccount
 metadata:
-  name: {{ template "ckaf-mirror-maker.name" . }}-mmadmin
+  name: {{ template "ckaf-mirror-maker.name" . }}-pre-mmadmin
   namespace: "{{.Release.Namespace}}"
   labels:
 {{ include "ckaf-mirror-maker.commonLabels" . | indent 4 }}
@@ -11,6 +11,34 @@
     heritage: {{ .Release.Service }}
     release: {{ .Release.Name }}
   annotations:
+    helm.sh/hook: pre-install,pre-upgrade
+    helm.sh/hook-weight: "-10"
+    helm.sh/hook-delete-policy: before-hook-creation, hook-succeeded
+    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
+    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
+{{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
+automountServiceAccountToken: false
+{{- if  coalesce .Values.imagePullSecrets .Values.global.imagePullSecrets }}
+imagePullSecrets:
+{{- range coalesce .Values.imagePullSecrets  .Values.global.imagePullSecrets }}
+  - name: {{ . }}
+{{- end }}
+{{- end }}
+---
+---
+apiVersion: v1
+kind: ServiceAccount
+metadata:
+  name: {{ template "ckaf-mirror-maker.name" . }}-sa-mmadmin
+  namespace: "{{.Release.Namespace}}"
+  labels:
+{{ include "ckaf-mirror-maker.commonLabels" . | indent 4 }}
+{{- include "csf-common-lib.v1.customLabels" (tuple .Values.global.labels) | indent 4 }}
+    app: {{ .Chart.Name }}
+    heritage: {{ .Release.Service }}
+    release: {{ .Release.Name }}
+  annotations:
+    helm.sh/hook-weight: "-10"
     seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
     seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
 {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
@@ -38,7 +66,7 @@
 {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
 rules:
 - apiGroups: [""]
-  resources: ["pods"]
+  resources: ["pods", "serviceaccounts"]
   verbs: ["list", "create", "get", "watch", "delete","deletecollection"]
 - apiGroups: [""]
   resources: ["persistentvolumeclaims"]
@@ -46,6 +74,9 @@
 - apiGroups: [""]
   resources: ["pods/status"]
   verbs: ["get"]
+- apiGroups: ["apps"]
+  resources: ["deployments", "deployments/scale"]
+  verbs: ["get","patch"]
 - apiGroups: [""]
   resources: ["services","configmaps"]
   verbs:  ["get","create","delete","patch","update"]
@@ -104,7 +135,11 @@
 {{- include "csf-common-lib.v1.customAnnotations" (tuple .Values.global.annotations) | indent 4 }}
 subjects:
 - kind: ServiceAccount
-  name: {{ template "ckaf-mirror-maker.name" . }}-mmadmin
+  name: {{ template "ckaf-mirror-maker.name" . }}-pre-mmadmin
+  namespace: "{{ .Release.Namespace }}"
+  apiGroup: ""
+- kind: ServiceAccount
+  name: {{ template "ckaf-mirror-maker.name" . }}-sa-mmadmin
   namespace: "{{ .Release.Namespace }}"
   apiGroup: ""
 roleRef:
